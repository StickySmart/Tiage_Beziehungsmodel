<!--
 * ¬© 2025 Ti-age.de Alle Rechte vorbehalten.
 * Dieses Werk ist urheberrechtlich gesch√ºtzt.
 * Jegliche Nutzung ohne ausdr√ºckliche Genehmigung ist untersagt.
 -->
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bed√ºrfnis-Editor | Ti-Age</title>
    <link rel="canonical" href="https://ti-age.de/needs-editor.html">
    <!-- Zentrale CSS-Variablen - EINZIGE QUELLE -->
    <link rel="stylesheet" href="templates/variables.css?v=20251205c">
    <link rel="stylesheet" href="templates/template_desktop.css?v=20251205c">
    <link rel="stylesheet" href="templates/template_mobile.css?v=20251205c" media="(max-width: 768px)">
    <!-- Profile Review Styling -->
    <link rel="stylesheet" href="css/profile-review.css">
    <!-- Resonanz Profile Header Card Styling -->
    <link rel="stylesheet" href="css/resonanz-profile-header-card.css">
    <!-- Resonanz Tree View Styling -->
    <link rel="stylesheet" href="css/resonanz-tree-view.css">

    <!-- LocalForage - Browser-Datenbank f√ºr Profile -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

    <!-- TIAGE i18n - Internationalisierung -->
    <script src="js/locales/de.js"></script>
    <script src="js/locales/en.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/version.js"></script>

    <!-- TIAGE Micro-Statements Databases -->
    <script src="statements/archetypeStatements.js"></script>
    <script src="statements/archetypeStatements_EN.js"></script>
    <script src="statements/dominanceStatements.js"></script>
    <script src="statements/orientationStatements.js"></script>
    <script src="statements/statusStatements.js"></script>
    <script src="statements/gfkStatements.js"></script>
    <script src="statements/resonanceQuotesTable.js"></script>

    <!-- TIAGE SYNTHESE - Zentralisierte Berechnungslogik -->
    <script src="js/synthesis/constants.js"></script>
    <script src="js/help-texts.js"></script>
    <script src="js/synthesis/needsIntegration.js"></script>
    <script src="js/synthesis/factors/archetypeMatrixCalculator.js"></script>
    <script src="js/synthesis/factors/archetypeFactor.js"></script>
    <script src="js/synthesis/factors/dominanceFactor.js"></script>
    <script src="js/synthesis/factors/orientationFactor.js"></script>
    <script src="js/synthesis/factors/genderFactor.js"></script>
    <script src="js/synthesis/lifestyleFilter.js"></script>
    <script src="js/utils/statistics.js"></script>
    <script src="js/synthesis/synthesisCalculator.js"></script>
    <script src="js/synthesis/pathosTextGenerator.js"></script>
    <script src="js/synthesis/logosTextGenerator.js"></script>
    <script src="js/synthesis/oshoZenTextGenerator.js"></script>
    <script src="js/synthesis/integratedSynthesisTextGenerator.js"></script>

    <!-- TIAGE COMPATIBILITY -->
    <script src="js/compatibility/physicalCompatibility.js"></script>
    <script src="js/compatibility/philosophyCompatibility.js"></script>
    <script src="js/compatibility/compatibilityOrchestrator.js"></script>

    <!-- TIAGE DIMENSIONS -->
    <script src="js/dimensions/tagDimensionRelevance.js"></script>
    <script src="js/dimensions/dominanzModifier.js"></script>
    <script src="js/dimensions/tagCalculator.js"></script>
    <!-- BED√úRFNIS-KATALOG (SSOT - l√§dt JSON direkt) -->
    <script src="profiles/definitions/beduerfnis-katalog.js"></script>
    <!-- ARCHETYP PROFILE -->
    <script src="profiles/archetypen/single.js"></script>
    <script src="profiles/archetypen/duo.js"></script>
    <script src="profiles/archetypen/duo-flex.js"></script>
    <script src="profiles/archetypen/solopoly.js"></script>
    <script src="profiles/archetypen/polyamor.js"></script>
    <script src="profiles/archetypen/ra.js"></script>
    <script src="profiles/archetypen/lat.js"></script>
    <script src="profiles/archetypen/aromantisch.js"></script>
    <script src="profiles/archetypen/index.js"></script>
    <!-- GESCHLECHTSIDENTIT√ÑT MODIFIER -->
    <script src="profiles/modifiers/gender/mann-cis.js"></script>
    <script src="profiles/modifiers/gender/mann-trans.js"></script>
    <script src="profiles/modifiers/gender/mann-suchend.js"></script>
    <script src="profiles/modifiers/gender/frau-cis.js"></script>
    <script src="profiles/modifiers/gender/frau-trans.js"></script>
    <script src="profiles/modifiers/gender/frau-suchend.js"></script>
    <script src="profiles/modifiers/gender/inter-nonbinaer.js"></script>
    <script src="profiles/modifiers/gender/inter-fluid.js"></script>
    <script src="profiles/modifiers/gender/inter-suchend.js"></script>
    <!-- DOMINANZ MODIFIER -->
    <script src="profiles/modifiers/dominanz/dominant.js"></script>
    <script src="profiles/modifiers/dominanz/submissiv.js"></script>
    <script src="profiles/modifiers/dominanz/switch.js"></script>
    <script src="profiles/modifiers/dominanz/ausgeglichen.js"></script>
    <!-- ORIENTIERUNG MODIFIER -->
    <script src="profiles/modifiers/orientierung/heterosexuell.js"></script>
    <script src="profiles/modifiers/orientierung/homosexuell.js"></script>
    <script src="profiles/modifiers/orientierung/bisexuell.js"></script>
    <!-- MODIFIER INDEX -->
    <script src="profiles/modifiers/index.js"></script>
    <!-- SSOT Taxonomie -->
    <script src="profiles/definitions/taxonomie.js"></script>
    <!-- GFK Bed√ºrfnisse & Modifikatoren -->
    <script src="profiles/definitions/gfk-beduerfnisse.js"></script>
    <script src="profiles/beduerfnis-modifikatoren.js"></script>
    <script src="profiles/definitions/archetyp-definitions.js"></script>
    <script src="profiles/profile-store.js"></script>

    <style>
        /* Page-specific styles for full-screen needs editor */
        .needs-editor-page {
            min-height: 100vh;
            background: var(--bg-dark, #0a0a0f);
            display: flex;
            flex-direction: column;
        }

        .needs-editor-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg-card, #1a1a2e);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .needs-editor-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .needs-editor-back-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-primary, #fff);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .needs-editor-back-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: var(--primary, #FFD700);
        }

        .needs-editor-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary, #fff);
        }

        .needs-editor-badge {
            background: var(--primary, #FFD700);
            color: #000;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .needs-editor-content {
            flex: 1;
            padding: 16px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        /* Search container */
        .needs-editor-search {
            background: var(--bg-card, #1a1a2e);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .needs-editor-search-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: var(--text-primary, #fff);
            font-size: 14px;
            box-sizing: border-box;
        }

        .needs-editor-search-input:focus {
            outline: none;
            border-color: var(--primary, #FFD700);
        }

        /* Needs list container */
        .needs-editor-list-container {
            background: var(--bg-card, #1a1a2e);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }

        /* Override profile-review styles for full page */
        .needs-editor-list-container .flat-needs-container {
            padding: 0;
        }

        .needs-editor-list-container .flat-needs-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--bg-card, #1a1a2e);
        }

        .needs-editor-list-container .flat-needs-list-wrapper {
            max-height: none;
            overflow: visible;
        }

        .needs-editor-list-container .flat-needs-list {
            max-height: none;
        }

        /* Person toggle */
        .needs-editor-person-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            justify-content: center;
        }

        .needs-editor-person-btn {
            padding: 10px 24px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: var(--text-secondary, #999);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .needs-editor-person-btn.active {
            background: var(--primary, #FFD700);
            color: #000;
            border-color: var(--primary, #FFD700);
        }

        .needs-editor-person-btn:hover:not(.active) {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.3);
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            .needs-editor-header {
                flex-wrap: wrap;
            }

            .needs-editor-title {
                font-size: 16px;
            }

            .needs-editor-content {
                padding: 12px;
            }
        }

        /* Highlight-Animation f√ºr openNeedWithResonance */
        .need-highlight-flash {
            animation: needHighlight 1.5s ease-out;
        }

        @keyframes needHighlight {
            0% { background-color: var(--accent-primary, #4a90d9); box-shadow: 0 0 10px var(--accent-primary, #4a90d9); }
            100% { background-color: transparent; box-shadow: none; }
        }
    </style>
</head>
<body>
    <div class="needs-editor-page">
        <!-- Header -->
        <header class="needs-editor-header">
            <div class="needs-editor-header-left">
                <button class="needs-editor-back-btn" onclick="goBack()">
                    <span>&#x2190;</span>
                    <span>Zur√ºck</span>
                </button>
                <h1 class="needs-editor-title">Alle Bed√ºrfnisse</h1>
                <span class="needs-editor-badge" id="needsEditorBadge">Profil</span>
            </div>
        </header>

        <!-- Main Content -->
        <main class="needs-editor-content">
            <!-- Person Toggle -->
            <div class="needs-editor-person-toggle">
                <button class="needs-editor-person-btn active" id="btnPersonIch" onclick="switchPerson('ich')">
                    ICH
                </button>
                <button class="needs-editor-person-btn" id="btnPersonPartner" onclick="switchPerson('partner')">
                    PARTNER
                </button>
            </div>

            <!-- Search/Filter - using profile-review styles -->
            <div class="profile-review-search-container" style="position: relative; z-index: 102;">
                <div class="profile-review-search-wrapper">
                    <span class="profile-review-search-icon">üîç</span>
                    <input type="text"
                           id="profileReviewSearchInput"
                           class="profile-review-search-input"
                           placeholder="Such..."
                           oninput="handleIntelligentSearch(this.value)"
                           onkeydown="handleSearchKeydown(event)"
                           onfocus="showSearchSuggestions()"
                           autocomplete="off">
                    <button class="profile-review-search-clear"
                            onclick="clearProfileReviewSearch()"
                            title="Suche leeren">√ó</button>
                    <!-- Intelligent Suggestions Dropdown -->
                    <div id="searchSuggestionsDropdown" class="search-suggestions-dropdown" style="display: none;">
                        <div class="search-suggestions-content"></div>
                    </div>
                </div>
                <div class="profile-review-search-hint" id="profileReviewSearchHint"></div>
            </div>

            <!-- Filter Controls Container wird dynamisch in renderAllNeedsFlat generiert -->

            <!-- Needs List -->
            <div class="needs-editor-list-container" id="needsEditorListContainer">
                <div style="padding: 40px; text-align: center; color: rgba(255,255,255,0.6);">
                    Lade Bed√ºrfnisse...
                </div>
            </div>
        </main>
    </div>

    <!-- State Management - Single Source of Truth -->
    <script src="js/state.js"></script>
    <!-- Memory Manager -->
    <script src="js/memory-manager.js"></script>

    <script src="js/app-i18n.js"></script>

    <!-- Profile UI Components -->
    <script src="js/components/TripleButtonGroup.js"></script>
    <script src="js/components/ProfileCard.js"></script>
    <script src="js/components/GewichtungCard.js"></script>
    <script src="js/components/ResonanzCard.js"></script>
    <script src="js/components/ResonanzProfileHeaderCard.js"></script>
    <script src="js/components/CategorySection.js"></script>
    <script src="js/components/profile-config.js"></script>
    <!-- Universeller Dimension-Kategorie-Filter -->
    <script src="js/components/DimensionKategorieFilter.js"></script>
    <!-- Resonanz Tree View -->
    <script src="js/components/ResonanzTreeView.js"></script>
    <script src="js/components/AttributeSummaryCard.js"></script>
    <script src="js/components/profile-components.js"></script>
    <!-- PerspektivenModal f√ºr Need-Details -->
    <script src="js/components/PerspektivenModal.js"></script>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // NEED DEFINITION MODAL - DIREKT AUS BEDUERFNIS-KATALOG
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        /**
         * √ñffnet das Bed√ºrfnis-Modal mit Details direkt aus BeduerfnisKatalog
         */
        window.openNeedDefinitionModal = function(needId) {
            const modal = document.getElementById('needDefinitionModal');
            const body = document.getElementById('needDefinitionModalBody');
            const title = document.getElementById('needDefinitionModalTitle');

            if (!modal || !body) return;

            // Katalog pr√ºfen
            const katalog = window.BeduerfnisKatalog;
            if (!katalog) {
                body.innerHTML = '<p style="color: var(--text-muted);">Katalog nicht geladen.</p>';
                modal.classList.add('active');
                return;
            }

            // Need-ID ermitteln (kann #B-ID oder string-key sein)
            let bId = needId;
            if (!needId.startsWith('#B') && typeof BeduerfnisIds !== 'undefined') {
                bId = BeduerfnisIds.toId(needId) || needId;
            }

            // Need aus Katalog holen
            const need = katalog.beduerfnisse[bId];
            if (!need) {
                body.innerHTML = `<p style="color: var(--text-muted);">Bed√ºrfnis ${needId} nicht gefunden.</p>`;
                modal.classList.add('active');
                return;
            }

            // Titel setzen
            title.textContent = need.label;

            // Kategorie, Dimension, Perspektive aus Katalog holen
            const kategorie = katalog.kategorien[need.kategorie];
            const dimension = katalog.dimensionen[need.dimension];
            const perspektive = kategorie ? katalog.perspektiven[getPerspektiveForKategorie(need.kategorie)] : null;

            // Aktuellen Wert aus TiageState holen
            let currentValue = null;
            let needKey = typeof BeduerfnisIds !== 'undefined' ? BeduerfnisIds.toKey(bId) : bId;
            if (typeof TiageState !== 'undefined') {
                const flatNeeds = TiageState.get('flatNeeds.' + currentPerson) || {};
                currentValue = flatNeeds[needKey] ?? flatNeeds[bId];
            }

            // HTML aufbauen
            let html = '<div class="need-modal-content">';

            // ID Badge
            html += `
                <div class="need-modal-id-row">
                    <span class="need-modal-id">${need.id}</span>
                    ${need.frageTyp ? `<span class="need-modal-type need-modal-type-${need.frageTyp}">${need.frageTyp === 'haupt' ? 'üìã Hauptfrage' : 'üìë Nuance'}</span>` : ''}
                </div>
            `;

            // Kategorie & Dimension
            html += `<div class="need-modal-meta-grid">`;

            if (kategorie) {
                html += `
                    <div class="need-modal-meta-item">
                        <span class="need-modal-meta-label">Kategorie</span>
                        <span class="need-modal-meta-value" style="color: ${kategorie.color}">
                            <span class="need-modal-dot" style="background: ${kategorie.color}"></span>
                            ${kategorie.label}
                        </span>
                    </div>
                `;
            }

            if (dimension) {
                html += `
                    <div class="need-modal-meta-item">
                        <span class="need-modal-meta-label">Dimension</span>
                        <span class="need-modal-meta-value" style="color: ${dimension.color}">
                            <span class="need-modal-badge" style="background: ${dimension.color}">${dimension.kurzform}</span>
                            ${dimension.label}
                        </span>
                    </div>
                `;
            }

            if (perspektive) {
                html += `
                    <div class="need-modal-meta-item">
                        <span class="need-modal-meta-label">Perspektive</span>
                        <span class="need-modal-meta-value">
                            ${perspektive.id} ${perspektive.label}
                        </span>
                    </div>
                `;
            }

            html += `</div>`;

            // Frage (wenn vorhanden)
            if (need.frage) {
                html += `
                    <div class="need-modal-question">
                        <span class="need-modal-question-icon">‚ùì</span>
                        <span class="need-modal-question-text">${need.frage}</span>
                    </div>
                `;
            }

            // Kontext (bei Nuancen)
            if (need.kontext) {
                html += `
                    <div class="need-modal-context">
                        <span class="need-modal-context-label">Kontext:</span>
                        <span class="need-modal-context-text">${need.kontext}</span>
                    </div>
                `;
            }

            // Hauptbed√ºrfnis-Referenz (bei Nuancen)
            if (need.hauptbeduerfnis) {
                const hauptNeed = katalog.beduerfnisse[need.hauptbeduerfnis];
                if (hauptNeed) {
                    html += `
                        <div class="need-modal-parent">
                            <span class="need-modal-parent-label">Geh√∂rt zu:</span>
                            <span class="need-modal-parent-link" onclick="openNeedDefinitionModal('${need.hauptbeduerfnis}')">${hauptNeed.label} (${need.hauptbeduerfnis})</span>
                        </div>
                    `;
                }
            }

            // Nuancen (bei Hauptfragen)
            if (need.nuancen && need.nuancen.length > 0) {
                html += `
                    <div class="need-modal-nuancen">
                        <span class="need-modal-nuancen-label">Nuancen:</span>
                        <div class="need-modal-nuancen-list">
                            ${need.nuancen.map(nId => {
                                const n = katalog.beduerfnisse[nId];
                                return n ? `<span class="need-modal-nuance-tag" onclick="openNeedDefinitionModal('${nId}')">${n.label}</span>` : '';
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            // Aktueller Wert
            if (currentValue !== null && currentValue !== undefined) {
                html += `
                    <div class="need-modal-value">
                        <div class="need-modal-value-header">
                            <span class="need-modal-value-label">Dein aktueller Wert</span>
                            <span class="need-modal-value-number">${currentValue}</span>
                        </div>
                        <div class="need-modal-value-bar">
                            <div class="need-modal-value-fill" style="width: ${currentValue}%"></div>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            body.innerHTML = html;

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        /**
         * Hilfsfunktion: Perspektive f√ºr Kategorie ermitteln
         */
        function getPerspektiveForKategorie(katId) {
            // GFK-Kern (#K1-#K10) ‚Üí #P1 (Statistik/GFK)
            // Dynamik (#K11) ‚Üí #P4 (SexPositiv)
            // Lebensthemen (#K12-#K18) ‚Üí #P1
            const katNum = parseInt(katId.replace('#K', ''));
            if (katNum === 11) return '#P4';
            return '#P1';
        }

        /**
         * Schlie√üt das Bed√ºrfnis-Modal
         */
        window.closeNeedDefinitionModal = function(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('needDefinitionModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        };

        /**
         * √ñffnet Need mit Resonanz-Daten (wird von AttributeSummaryCard aufgerufen)
         */
        window.openNeedWithResonance = function(needId) {
            openNeedDefinitionModal(needId);
        };

        // Current state
        let currentPerson = 'ich';
        let currentArchetype = 'polyamor';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeNeedsEditor();
        });

        function initializeNeedsEditor() {
            // FIX: Filter zur√ºcksetzen beim Initialisieren (Clean State)
            if (typeof DimensionKategorieFilter !== 'undefined') {
                DimensionKategorieFilter.reset();
            }

            // Get params from URL or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            currentPerson = urlParams.get('person') || localStorage.getItem('tiage_needs_editor_person') || 'ich';
            // Priorit√§t: URL-Parameter > TiageState > localStorage > Fallback
            currentArchetype = urlParams.get('archetype') ||
                (typeof TiageState !== 'undefined' ? TiageState.getArchetype(currentPerson) : null) ||
                localStorage.getItem('tiage_selected_archetype_' + currentPerson) ||
                'polyamor';

            // WICHTIG: Setze Archetyp in TiageState und lade Profil
            // Damit TiageState.flatNeeds korrekt initialisiert wird
            if (typeof TiageState !== 'undefined' && typeof ProfileCalculator !== 'undefined') {
                // Setze den Archetyp in TiageState
                TiageState.set('archetypes.' + currentPerson + '.primary', currentArchetype);

                // Lade das Profil (berechnet flatNeeds und schreibt in TiageState)
                const profileData = {
                    archetyp: currentArchetype,
                    geschlecht: TiageState.get('personDimensions.' + currentPerson + '.geschlecht') || null,
                    dominanz: TiageState.get('personDimensions.' + currentPerson + '.dominanz') || null,
                    orientierung: TiageState.get('personDimensions.' + currentPerson + '.orientierung') || null
                };
                ProfileCalculator.loadProfile(currentPerson, profileData);
                console.log('[NeedsEditor] Profil geladen f√ºr', currentPerson, ':', currentArchetype);
            }

            // Set context for AttributeSummaryCard
            window.currentProfileReviewContext = {
                person: currentPerson,
                archetypeKey: currentArchetype
            };

            // Update person toggle
            updatePersonToggle();

            // Update badge
            updateBadge();

            // Load data from TiageState or localStorage
            loadNeedsData();

            // Render the needs list
            renderNeedsList();
        }

        function updatePersonToggle() {
            document.getElementById('btnPersonIch').classList.toggle('active', currentPerson === 'ich');
            document.getElementById('btnPersonPartner').classList.toggle('active', currentPerson === 'partner');
        }

        function updateBadge() {
            const badge = document.getElementById('needsEditorBadge');
            const archetypeLabels = {
                'single': 'Single',
                'duo': 'Duo',
                'duo-flex': 'Duo-Flex',
                'solopoly': 'Solo-Poly',
                'polyamor': 'Polyamor',
                'ra': 'RA',
                'lat': 'LAT',
                'aromantisch': 'Aromantisch'
            };
            badge.textContent = archetypeLabels[currentArchetype] || currentArchetype;
        }

        function loadNeedsData() {
            // Try to load from TiageState first
            if (typeof TiageState !== 'undefined') {
                const flatNeeds = TiageState.get('flatNeeds.' + currentPerson);
                if (flatNeeds && flatNeeds.length > 0) {
                    // FIX: Die Daten m√ºssen auch an AttributeSummaryCard √ºbergeben werden!
                    if (typeof AttributeSummaryCard !== 'undefined') {
                        AttributeSummaryCard.setFlatNeeds(flatNeeds);
                    }
                    console.log('[NeedsEditor] Loaded from TiageState:', flatNeeds.length, 'needs');
                    return;
                }
            }

            // Fallback to localStorage
            const stored = localStorage.getItem('tiage_flat_needs');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    if (typeof AttributeSummaryCard !== 'undefined') {
                        AttributeSummaryCard.setFlatNeeds(parsed);
                    }
                    console.log('[NeedsEditor] Loaded from localStorage');
                } catch (e) {
                    console.error('[NeedsEditor] Error parsing localStorage:', e);
                }
            }
        }

        function renderNeedsList() {
            const container = document.getElementById('needsEditorListContainer');

            if (typeof AttributeSummaryCard === 'undefined') {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #f87171;">Fehler: AttributeSummaryCard nicht geladen</div>';
                return;
            }

            // Get archetype for person - Priorit√§t: TiageState > localStorage > Fallback
            const archetype = (typeof TiageState !== 'undefined' ? TiageState.getArchetype(currentPerson) : null) ||
                localStorage.getItem('tiage_selected_archetype_' + currentPerson) ||
                'polyamor';

            // Get archetype label
            const archetypeLabels = {
                'single': 'Single',
                'duo': 'Duo',
                'duo-flex': 'Duo-Flex',
                'solopoly': 'Solo-Poly',
                'polyamor': 'Polyamor',
                'ra': 'RA',
                'lat': 'LAT',
                'aromantisch': 'Aromantisch'
            };
            const archetypeLabel = archetypeLabels[archetype] || archetype;

            // Render using AttributeSummaryCard with both archetype and label
            const html = AttributeSummaryCard.renderAllNeedsFlat(archetype, archetypeLabel);
            container.innerHTML = html;

            // Initialize multi-select controls if available
            if (typeof AttributeSummaryCard.initDimensionFilter === 'function') {
                setTimeout(function() {
                    AttributeSummaryCard.initDimensionFilter();
                }, 100);
            }

            console.log('[NeedsEditor] Rendered needs list for', currentPerson, 'with archetype', archetype);
        }

        function switchPerson(person) {
            // Save current state first
            saveCurrentState();

            // FIX: Filter zur√ºcksetzen beim Person-Wechsel
            if (typeof DimensionKategorieFilter !== 'undefined') {
                DimensionKategorieFilter.reset();
            }

            currentPerson = person;
            localStorage.setItem('tiage_needs_editor_person', person);

            // Update UI
            updatePersonToggle();

            // Update archetype for this person - Priorit√§t: TiageState > localStorage > Fallback
            currentArchetype = (typeof TiageState !== 'undefined' ? TiageState.getArchetype(person) : null) ||
                localStorage.getItem('tiage_selected_archetype_' + person) ||
                'polyamor';
            updateBadge();

            // WICHTIG: Lade Profil f√ºr die neue Person
            if (typeof TiageState !== 'undefined' && typeof ProfileCalculator !== 'undefined') {
                TiageState.set('archetypes.' + person + '.primary', currentArchetype);

                const profileData = {
                    archetyp: currentArchetype,
                    geschlecht: TiageState.get('personDimensions.' + person + '.geschlecht') || null,
                    dominanz: TiageState.get('personDimensions.' + person + '.dominanz') || null,
                    orientierung: TiageState.get('personDimensions.' + person + '.orientierung') || null
                };
                ProfileCalculator.loadProfile(person, profileData);
                console.log('[NeedsEditor] Profil gewechselt zu', person, ':', currentArchetype);
            }

            // Update context for AttributeSummaryCard
            window.currentProfileReviewContext = {
                person: person,
                archetypeKey: currentArchetype
            };

            // Reload data and re-render
            loadNeedsData();
            renderNeedsList();
        }

        function saveCurrentState() {
            if (typeof AttributeSummaryCard !== 'undefined') {
                const flatNeeds = AttributeSummaryCard.getFlatNeeds();
                if (flatNeeds) {
                    // Save to localStorage
                    localStorage.setItem('tiage_flat_needs', JSON.stringify(flatNeeds));

                    // Save to TiageState if available
                    if (typeof TiageState !== 'undefined') {
                        TiageState.set('flatNeeds.' + currentPerson, flatNeeds);
                    }
                }
            }
        }

        function handleNeedsSearch(query) {
            if (typeof AttributeSummaryCard !== 'undefined' && typeof AttributeSummaryCard.filterBySearch === 'function') {
                AttributeSummaryCard.filterBySearch(query);
            }
        }

        function goBack() {
            // Check if there's a referrer
            if (document.referrer && document.referrer.includes(window.location.hostname)) {
                window.history.back();
            } else {
                window.location.href = 'archetype-interaction.html';
            }
        }

        function saveAndGoBack() {
            saveCurrentState();

            // Dispatch event for main page to update
            window.dispatchEvent(new CustomEvent('flatNeedsUpdated', {
                detail: { person: currentPerson }
            }));

            goBack();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INTELLIGENT SEARCH SUGGESTIONS (adapted from app-main.js)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        var suggestionState = {
            selectedIndex: -1,
            suggestions: [],
            activeSuggestion: null
        };

        function getPerspectiveForCategory(categoryKey) {
            if (window.PerspektivenModal && window.PerspektivenModal.kategoriePerspektiven) {
                var perspId = window.PerspektivenModal.kategoriePerspektiven[categoryKey];
                if (perspId && window.PerspektivenModal.perspektiven[perspId]) {
                    return window.PerspektivenModal.perspektiven[perspId];
                }
            }
            return null;
        }

        function getPerspectiveForNeed(needId) {
            if (!window.BeduerfnisKatalog || !window.BeduerfnisKatalog.beduerfnisse) return null;
            var need = window.BeduerfnisKatalog.beduerfnisse[needId];
            if (!need || !need.kategorie) return null;
            var categoryId = need.kategorie;
            if (!window.TiageTaxonomie || !window.TiageTaxonomie.kategorien) return null;
            var category = window.TiageTaxonomie.kategorien[categoryId];
            if (!category || !category.key) return null;
            return getPerspectiveForCategory(category.key);
        }

        function generateSearchSuggestions(query) {
            var suggestions = [];
            var parts = query.split(',');
            var lastPart = parts[parts.length - 1].trim();
            var lowerQuery = lastPart.toLowerCase();

            if (!lowerQuery) {
                // Show all categories
                if (window.TiageTaxonomie && window.TiageTaxonomie.kategorien) {
                    Object.values(window.TiageTaxonomie.kategorien).forEach(function(kat) {
                        suggestions.push({ type: 'category', id: kat.id, label: kat.label, description: kat.beschreibung, perspective: getPerspectiveForCategory(kat.key) });
                    });
                }
                // Show all dimensions
                if (window.TiageTaxonomie && window.TiageTaxonomie.dimensionen) {
                    Object.values(window.TiageTaxonomie.dimensionen).forEach(function(dim) {
                        suggestions.push({ type: 'dimension', id: dim.id, label: dim.label, description: dim.beschreibung, perspective: null });
                    });
                }
                // Show all resonance factors
                var resonanzfaktoren = {
                    'R1': { id: 'R1', label: 'Leben', icon: 'üî•', beschreibung: 'Orientierung - Existenz, Zuneigung, Mu√üe, Intimit√§t' },
                    'R2': { id: 'R2', label: 'Philosophie', icon: 'üß†', beschreibung: 'Archetyp - Lebensplanung, Werte, Finanzen' },
                    'R3': { id: 'R3', label: 'Dynamik', icon: '‚ö°', beschreibung: 'Dominanz - Machtdynamik, BDSM, Sicherheit' },
                    'R4': { id: 'R4', label: 'Identit√§t', icon: 'üíö', beschreibung: 'Geschlecht - Authentizit√§t, Kommunikation, Selbstausdruck' }
                };
                Object.values(resonanzfaktoren).forEach(function(r) {
                    suggestions.push({ type: 'resonanz', id: r.id, label: r.label, icon: r.icon, description: r.beschreibung, perspective: null });
                });
                // Show all perspectives
                if (window.TiageTaxonomie && window.TiageTaxonomie.perspektiven) {
                    Object.values(window.TiageTaxonomie.perspektiven).forEach(function(p) {
                        suggestions.push({ type: 'perspective', id: p.id, label: p.label, description: p.beschreibung, perspective: null });
                    });
                }
                return suggestions;
            }

            // Search in needs
            var needsSource = window.BeduerfnisKatalog?.beduerfnisse || (typeof BeduerfnisIds !== 'undefined' ? BeduerfnisIds.beduerfnisse : null);
            if (needsSource) {
                Object.values(needsSource).forEach(function(need) {
                    var matchScore = 0;
                    if (need.label && need.label.toLowerCase().includes(lowerQuery)) matchScore = 10;
                    if (need.id && need.id.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 8);
                    if (matchScore > 0) {
                        suggestions.push({ type: 'need', id: need.id, label: need.label, description: need.frage || '', perspective: getPerspectiveForNeed(need.id), score: matchScore });
                    }
                });
            }

            // Search in categories
            if (window.TiageTaxonomie && window.TiageTaxonomie.kategorien) {
                Object.values(window.TiageTaxonomie.kategorien).forEach(function(kat) {
                    var matchScore = 0;
                    if (kat.label && kat.label.toLowerCase().includes(lowerQuery)) matchScore = 9;
                    if (kat.beschreibung && kat.beschreibung.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 7);
                    if (kat.id && kat.id.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 8);
                    if (matchScore > 0) {
                        suggestions.push({ type: 'category', id: kat.id, label: kat.label, description: kat.beschreibung, perspective: getPerspectiveForCategory(kat.key), score: matchScore });
                    }
                });
            }

            // Search in dimensions
            if (window.TiageTaxonomie && window.TiageTaxonomie.dimensionen) {
                Object.values(window.TiageTaxonomie.dimensionen).forEach(function(dim) {
                    var matchScore = 0;
                    if (dim.label && dim.label.toLowerCase().includes(lowerQuery)) matchScore = 8;
                    if (dim.beschreibung && dim.beschreibung.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 6);
                    if (dim.id && dim.id.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 7);
                    if (matchScore > 0) {
                        suggestions.push({ type: 'dimension', id: dim.id, label: dim.label, description: dim.beschreibung, perspective: null, score: matchScore });
                    }
                });
            }

            // Search in resonance factors
            var resonanzfaktoren = {
                'R1': { id: 'R1', label: 'Leben', icon: 'üî•', beschreibung: 'Orientierung - Existenz, Zuneigung, Mu√üe, Intimit√§t' },
                'R2': { id: 'R2', label: 'Philosophie', icon: 'üß†', beschreibung: 'Archetyp - Lebensplanung, Werte, Finanzen' },
                'R3': { id: 'R3', label: 'Dynamik', icon: '‚ö°', beschreibung: 'Dominanz - Machtdynamik, BDSM, Sicherheit' },
                'R4': { id: 'R4', label: 'Identit√§t', icon: 'üíö', beschreibung: 'Geschlecht - Authentizit√§t, Kommunikation, Selbstausdruck' }
            };
            Object.values(resonanzfaktoren).forEach(function(r) {
                var matchScore = 0;
                if (r.label && r.label.toLowerCase().includes(lowerQuery)) matchScore = 8;
                if (r.beschreibung && r.beschreibung.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 6);
                if (r.id && r.id.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 7);
                if (matchScore > 0) {
                    suggestions.push({ type: 'resonanz', id: r.id, label: r.label, icon: r.icon, description: r.beschreibung, perspective: null, score: matchScore });
                }
            });

            suggestions.sort(function(a, b) { return (b.score || 0) - (a.score || 0); });
            return suggestions.slice(0, 15);
        }

        function renderSuggestionItem(suggestion, index) {
            var typeLabel = { 'need': 'Bed√ºrfnis', 'category': 'Kategorie', 'dimension': 'Dimension', 'resonanz': 'Resonanzfaktor', 'perspective': 'Perspektive' }[suggestion.type] || suggestion.type;
            var iconPrefix = suggestion.icon ? suggestion.icon + ' ' : '';
            var descriptionHTML = suggestion.description ? '<div class="suggestion-item-description">' + (suggestion.description.length > 120 ? suggestion.description.substring(0, 120) + '...' : suggestion.description) + '</div>' : '';
            return '<div class="suggestion-item' + (index === suggestionState.selectedIndex ? ' active' : '') + '" data-index="' + index + '" data-value="' + suggestion.label + '">' +
                '<div class="suggestion-item-header">' +
                '<span class="suggestion-item-type type-' + suggestion.type + '">' + typeLabel + '</span>' +
                '<span class="suggestion-item-label">' + iconPrefix + suggestion.label + '</span>' +
                '<span class="suggestion-item-id">' + suggestion.id + '</span>' +
                '</div>' + descriptionHTML + '</div>';
        }

        function displaySearchSuggestions(suggestions) {
            var dropdown = document.getElementById('searchSuggestionsDropdown');
            var content = dropdown ? dropdown.querySelector('.search-suggestions-content') : null;
            if (!dropdown || !content) return;

            suggestionState.suggestions = suggestions;
            suggestionState.selectedIndex = -1;

            if (suggestions.length === 0) {
                content.innerHTML = '<div class="search-suggestions-empty">Keine Vorschl√§ge gefunden</div>';
                dropdown.style.display = 'block';
                return;
            }

            var grouped = { 'need': [], 'category': [], 'dimension': [], 'resonanz': [], 'perspective': [] };
            suggestions.forEach(function(s, i) { if (grouped[s.type]) grouped[s.type].push({suggestion: s, index: i}); });

            var html = '';
            var order = ['need', 'category', 'dimension', 'resonanz', 'perspective'];
            var headers = { 'need': 'Bed√ºrfnisse', 'category': 'Kategorien', 'dimension': 'Dimensionen', 'resonanz': 'Resonanzfaktoren', 'perspective': 'Perspektiven' };
            order.forEach(function(type) {
                if (grouped[type].length > 0) {
                    html += '<div class="suggestion-section-header">' + headers[type] + '</div>';
                    grouped[type].forEach(function(item) { html += renderSuggestionItem(item.suggestion, item.index); });
                }
            });

            content.innerHTML = html;
            dropdown.style.display = 'block';
            content.querySelectorAll('.suggestion-item').forEach(function(item) {
                item.addEventListener('click', function() { selectSuggestion(parseInt(item.getAttribute('data-index'))); });
            });
        }

        function hideSearchSuggestions() {
            var dropdown = document.getElementById('searchSuggestionsDropdown');
            if (dropdown) dropdown.style.display = 'none';
            suggestionState.selectedIndex = -1;
        }
        window.hideSearchSuggestions = hideSearchSuggestions;

        /**
         * Hilfsfunktion: Kategorie-ID eines Bed√ºrfnisses ermitteln
         */
        function getNeedCategoryId(needId) {
            if (!window.BeduerfnisKatalog || !window.BeduerfnisKatalog.beduerfnisse) return null;
            var need = window.BeduerfnisKatalog.beduerfnisse[needId];
            return need ? need.kategorie : null;
        }

        /**
         * Hilfsfunktion: Dimension-ID eines Bed√ºrfnisses ermitteln
         */
        function getNeedDimensionId(needId) {
            var categoryId = getNeedCategoryId(needId);
            if (!categoryId) return null;
            if (!window.TiageTaxonomie || !window.TiageTaxonomie.kategorien) return null;
            var category = window.TiageTaxonomie.kategorien[categoryId];
            return category ? category.dimension : null;
        }

        /**
         * Hilfsfunktion: Alle durchsuchbaren Texte f√ºr ein Bed√ºrfnis sammeln
         */
        function getSearchableTextsForNeed(needId, labelText) {
            var texts = [labelText, needId];

            // Kategorie-Info hinzuf√ºgen
            var categoryId = getNeedCategoryId(needId);
            if (categoryId && window.TiageTaxonomie && window.TiageTaxonomie.kategorien) {
                var category = window.TiageTaxonomie.kategorien[categoryId];
                if (category) {
                    if (category.label) texts.push(category.label);
                    if (category.key) texts.push(category.key);
                    // Dimension-Info
                    if (category.dimension && window.TiageTaxonomie.dimensionen) {
                        var dimension = window.TiageTaxonomie.dimensionen[category.dimension];
                        if (dimension) {
                            if (dimension.label) texts.push(dimension.label);
                            if (dimension.id) texts.push(dimension.id);
                        }
                    }
                }
            }

            // Perspektive-Info hinzuf√ºgen
            var perspective = getPerspectiveForNeed(needId);
            if (perspective) {
                if (perspective.label) texts.push(perspective.label);
                if (perspective.id) texts.push(perspective.id);
            }

            return texts.join(' ').toLowerCase();
        }

        /**
         * Pr√ºft ob alle Komma-separierten Kriterien im Text gefunden werden (AND-Logik)
         */
        function matchesAllCriteria(searchableText, criteria) {
            if (!criteria || criteria.length === 0) return true;

            for (var i = 0; i < criteria.length; i++) {
                var criterion = criteria[i].toLowerCase();
                if (criterion && !searchableText.includes(criterion)) {
                    return false;
                }
            }
            return true;
        }

        function filterProfileReviewByNeed(query) {
            // Direkte Filterung der flat-need-item Elemente
            var flatNeedItems = document.querySelectorAll('.flat-need-item');
            if (!flatNeedItems.length) return;

            // Wenn leer, alle anzeigen
            if (!query || !query.trim()) {
                flatNeedItems.forEach(function(item) {
                    item.classList.remove('filter-hidden', 'filter-match');
                });
                return;
            }

            // Komma-separierte Kriterien extrahieren (AND-Logik)
            // "LIe,schm" ‚Üí ["lie", "schm"] - beide m√ºssen matchen
            var criteria = query.split(',').map(function(c) { return c.trim().toLowerCase(); }).filter(function(c) { return c.length > 0; });

            var totalMatches = 0;

            flatNeedItems.forEach(function(item) {
                var needId = item.getAttribute('data-need') || '';
                var needLabel = item.querySelector('.flat-need-label');
                var labelText = needLabel ? needLabel.textContent : '';

                // Alle durchsuchbaren Texte sammeln (Label, ID, Kategorie, Dimension, Perspektive)
                // und pr√ºfen ob ALLE Kriterien irgendwo vorkommen
                var searchableText = getSearchableTextsForNeed(needId, labelText);
                var matches = matchesAllCriteria(searchableText, criteria);

                item.classList.toggle('filter-hidden', !matches);
                item.classList.toggle('filter-match', matches);

                if (matches) totalMatches++;
            });

            console.log('[Filter] needs-editor:', query, '- Matches:', totalMatches);
        }

        function handleIntelligentSearch(query) {
            filterProfileReviewByNeed(query);
            var suggestions = generateSearchSuggestions(query);
            displaySearchSuggestions(suggestions);
        }
        window.handleIntelligentSearch = handleIntelligentSearch;

        function showSearchSuggestions() {
            var input = document.getElementById('profileReviewSearchInput');
            if (!input) return;
            var suggestions = generateSearchSuggestions(input.value || '');
            displaySearchSuggestions(suggestions);
        }
        window.showSearchSuggestions = showSearchSuggestions;

        function selectSuggestion(index) {
            if (index < 0 || index >= suggestionState.suggestions.length) return;
            var suggestion = suggestionState.suggestions[index];
            var input = document.getElementById('profileReviewSearchInput');
            suggestionState.activeSuggestion = suggestion;

            // Pr√ºfe ob bereits mehrere Begriffe vorhanden sind (Komma = UND-Verkn√ºpfung)
            var hasMultipleTerms = input && input.value.includes(',');

            // FIX: Bei Bed√ºrfnis-Auswahl -> Textsuche mit dem Label
            if (suggestion.type === 'need') {
                // Setze das Suchfeld auf das Bed√ºrfnis-Label (ohne Komma am Ende)
                if (input) {
                    input.value = suggestion.label;
                }
                // Filter zur√ºcksetzen OHNE Event auszul√∂sen (sonst wird activeSuggestion gel√∂scht)
                if (typeof DimensionKategorieFilter !== 'undefined') {
                    DimensionKategorieFilter.reset(true); // silent = true
                }
                filterProfileReviewByNeed(suggestion.label);
                console.log('[Filter] Bed√ºrfnis als Textsuche:', suggestion.label);
                hideSearchSuggestions();
                displayActiveSuggestion();
                return;
            }

            // F√ºr andere Typen: Komma-Logik beibehalten
            if (input) {
                var parts = input.value.split(',').map(function(p) { return p.trim(); }).filter(function(p) { return p.length > 0; });
                // Letzten (unvollst√§ndigen) Teil ersetzen
                if (parts.length > 0) {
                    parts[parts.length - 1] = suggestion.label;
                } else {
                    parts.push(suggestion.label);
                }
                input.value = parts.join(', ') + ', ';
                input.focus();
            }

            // FIX: Bei Resonanzfaktor-Auswahl den DimensionKategorieFilter aktivieren
            if (suggestion.type === 'resonanz' && typeof DimensionKategorieFilter !== 'undefined') {
                // Bei Mehrfach-Auswahl: NICHT resetten, sondern hinzuf√ºgen
                if (!hasMultipleTerms) {
                    DimensionKategorieFilter.reset();
                }
                // Alle Kategorien des Resonanzfaktors aktivieren
                var kategorien = DimensionKategorieFilter.KATEGORIEN_PRO_DIMENSION[suggestion.id];
                if (kategorien && kategorien.length > 0) {
                    kategorien.forEach(function(kat) {
                        if (!DimensionKategorieFilter.isKategorieActive(kat.id)) {
                            DimensionKategorieFilter.toggleKategorie(kat.id);
                        }
                    });
                    console.log('[Filter] Resonanzfaktor aktiviert:', suggestion.id);
                }
                filterProfileReviewByNeed('');
            } else if (suggestion.type === 'category' && typeof DimensionKategorieFilter !== 'undefined') {
                // Bei Kategorie-Auswahl: NICHT resetten bei Mehrfach-Auswahl
                if (!hasMultipleTerms) {
                    DimensionKategorieFilter.reset();
                }
                // Kategorie hinzuf√ºgen (nur wenn nicht bereits aktiv)
                if (!DimensionKategorieFilter.isKategorieActive(suggestion.id)) {
                    DimensionKategorieFilter.toggleKategorie(suggestion.id);
                }
                console.log('[Filter] Kategorie aktiviert:', suggestion.id);
                filterProfileReviewByNeed('');
            } else {
                // F√ºr andere Typen (dimension, perspective)
                if (typeof DimensionKategorieFilter !== 'undefined' && !hasMultipleTerms) {
                    DimensionKategorieFilter.reset();
                }
                filterProfileReviewByNeed(input ? input.value : '');
            }

            hideSearchSuggestions();
            displayActiveSuggestion();
        }

        function displayActiveSuggestion() {
            var hint = document.getElementById('profileReviewSearchHint');
            console.log('[displayActiveSuggestion] hint element:', hint);
            if (!hint) {
                console.error('[displayActiveSuggestion] profileReviewSearchHint nicht gefunden!');
                return;
            }
            var suggestion = suggestionState.activeSuggestion;
            console.log('[displayActiveSuggestion] suggestion:', suggestion);
            if (!suggestion) {
                console.warn('[displayActiveSuggestion] Keine activeSuggestion gesetzt');
                return;
            }

            // FIX: Bei Bed√ºrfnis/Textsuche spezielle Anzeige
            if (suggestion.type === 'need') {
                console.log('[displayActiveSuggestion] Zeige Textsuche-Tag f√ºr:', suggestion.label);
                hint.innerHTML = '<span class="search-active-selection">' +
                    '<span class="search-active-type type-textsearch">üîç Textsuche</span>' +
                    '<span class="search-active-label">"' + suggestion.label + '"</span>' +
                    '<button class="search-active-clear" onclick="clearActiveSuggestion()" title="Suche entfernen">√ó</button></span>';
                hint.classList.add('has-active-selection');
                return;
            }

            var typeLabel = { 'category': 'Kategorie', 'dimension': 'Dimension', 'resonanz': 'Resonanzfaktor', 'perspective': 'Perspektive' }[suggestion.type] || suggestion.type;
            var iconPrefix = suggestion.icon ? suggestion.icon + ' ' : '';
            hint.innerHTML = '<span class="search-active-selection">' +
                '<span class="search-active-type type-' + suggestion.type + '">' + typeLabel + '</span>' +
                '<span class="search-active-label">' + iconPrefix + suggestion.label + '</span>' +
                '<span class="search-active-id">' + suggestion.id + '</span>' +
                '<button class="search-active-clear" onclick="clearActiveSuggestion()" title="Auswahl entfernen">√ó</button></span>';
            hint.classList.add('has-active-selection');
        }
        window.displayActiveSuggestion = displayActiveSuggestion;

        function clearActiveSuggestion() {
            suggestionState.activeSuggestion = null;
            var hint = document.getElementById('profileReviewSearchHint');
            if (hint) { hint.innerHTML = ''; hint.classList.remove('has-active-selection'); }
            // Clear the search input and reset filter
            var input = document.getElementById('profileReviewSearchInput');
            if (input) { input.value = ''; }
            // Reset filter to show all items
            filterProfileReviewByNeed('');
            // Hide suggestions dropdown
            hideSearchSuggestions();
        }
        window.clearActiveSuggestion = clearActiveSuggestion;

        function handleSearchKeydown(event) {
            var dropdown = document.getElementById('searchSuggestionsDropdown');
            var dropdownVisible = dropdown && dropdown.style.display !== 'none';
            var suggestions = suggestionState.suggestions || [];

            // Enter funktioniert auch ohne sichtbares Dropdown (f√ºr Textsuche)
            if (event.key === 'Enter') {
                event.preventDefault();
                if (dropdownVisible && suggestionState.selectedIndex >= 0) {
                    selectSuggestion(suggestionState.selectedIndex);
                } else {
                    // FIX: Bei Enter ohne Vorschlagsauswahl -> Textsuche aktivieren
                    var input = document.getElementById('profileReviewSearchInput');
                    var query = input ? input.value.trim() : '';
                    if (query.length > 0) {
                        suggestionState.activeSuggestion = {
                            type: 'need',
                            id: null,
                            label: query
                        };
                        displayActiveSuggestion();
                        hideSearchSuggestions();
                        console.log('[handleSearchKeydown] Textsuche aktiviert f√ºr:', query);
                    }
                }
                return;
            }

            // F√ºr andere Tasten: Dropdown muss sichtbar sein
            if (!dropdownVisible) return;
            if (suggestions.length === 0) return;

            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    suggestionState.selectedIndex = Math.min(suggestionState.selectedIndex + 1, suggestions.length - 1);
                    updateSuggestionSelection();
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    suggestionState.selectedIndex = Math.max(suggestionState.selectedIndex - 1, -1);
                    updateSuggestionSelection();
                    break;
                case 'Escape':
                    event.preventDefault();
                    hideSearchSuggestions();
                    break;
            }
        }
        window.handleSearchKeydown = handleSearchKeydown;

        function updateSuggestionSelection() {
            var content = document.querySelector('.search-suggestions-content');
            if (!content) return;
            content.querySelectorAll('.suggestion-item').forEach(function(item, index) {
                if (index === suggestionState.selectedIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    item.classList.remove('active');
                }
            });
        }

        function clearProfileReviewSearch() {
            var input = document.getElementById('profileReviewSearchInput');
            if (input) input.value = '';
            filterProfileReviewByNeed('');
            hideSearchSuggestions();
            clearActiveSuggestion();
            // Update clear button visibility
            var wrapper = document.querySelector('.profile-review-search-wrapper');
            if (wrapper) wrapper.classList.remove('has-value');
        }
        window.clearProfileReviewSearch = clearProfileReviewSearch;

        // Close suggestions when clicking outside
        document.addEventListener('click', function(event) {
            var searchWrapper = document.querySelector('.profile-review-search-wrapper');
            var dropdown = document.getElementById('searchSuggestionsDropdown');
            if (searchWrapper && dropdown && !searchWrapper.contains(event.target) && !dropdown.contains(event.target)) {
                hideSearchSuggestions();
            }
        });

        // Update clear button visibility on input
        document.addEventListener('DOMContentLoaded', function() {
            var input = document.getElementById('profileReviewSearchInput');
            if (input) {
                input.addEventListener('input', function() {
                    var wrapper = document.querySelector('.profile-review-search-wrapper');
                    if (wrapper) wrapper.classList.toggle('has-value', this.value.length > 0);
                });
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INTELLIGENT SEARCH SUGGESTIONS (adapted from app-main.js)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        var suggestionState = {
            selectedIndex: -1,
            suggestions: [],
            activeSuggestion: null
        };

        function getPerspectiveForCategory(categoryKey) {
            if (window.PerspektivenModal && window.PerspektivenModal.kategoriePerspektiven) {
                var perspId = window.PerspektivenModal.kategoriePerspektiven[categoryKey];
                if (perspId && window.PerspektivenModal.perspektiven[perspId]) {
                    return window.PerspektivenModal.perspektiven[perspId];
                }
            }
            return null;
        }

        function getPerspectiveForNeed(needId) {
            if (!window.BeduerfnisKatalog || !window.BeduerfnisKatalog.beduerfnisse) return null;
            var need = window.BeduerfnisKatalog.beduerfnisse[needId];
            if (!need || !need.kategorie) return null;
            var categoryId = need.kategorie;
            if (!window.TiageTaxonomie || !window.TiageTaxonomie.kategorien) return null;
            var category = window.TiageTaxonomie.kategorien[categoryId];
            if (!category || !category.key) return null;
            return getPerspectiveForCategory(category.key);
        }

        function generateSearchSuggestions(query) {
            var suggestions = [];
            var parts = query.split(',');
            var lastPart = parts[parts.length - 1].trim();
            var lowerQuery = lastPart.toLowerCase();

            if (!lowerQuery) {
                // Show all categories
                if (window.TiageTaxonomie && window.TiageTaxonomie.kategorien) {
                    Object.values(window.TiageTaxonomie.kategorien).forEach(function(kat) {
                        suggestions.push({ type: 'category', id: kat.id, label: kat.label, description: kat.beschreibung, perspective: getPerspectiveForCategory(kat.key) });
                    });
                }
                // Show all dimensions
                if (window.TiageTaxonomie && window.TiageTaxonomie.dimensionen) {
                    Object.values(window.TiageTaxonomie.dimensionen).forEach(function(dim) {
                        suggestions.push({ type: 'dimension', id: dim.id, label: dim.label, description: dim.beschreibung, perspective: null });
                    });
                }
                // Show all resonance factors
                var resonanzfaktoren = {
                    'R1': { id: 'R1', label: 'Leben', icon: 'üî•', beschreibung: 'Orientierung - Existenz, Zuneigung, Mu√üe, Intimit√§t' },
                    'R2': { id: 'R2', label: 'Philosophie', icon: 'üß†', beschreibung: 'Archetyp - Lebensplanung, Werte, Finanzen' },
                    'R3': { id: 'R3', label: 'Dynamik', icon: '‚ö°', beschreibung: 'Dominanz - Machtdynamik, BDSM, Sicherheit' },
                    'R4': { id: 'R4', label: 'Identit√§t', icon: 'üíö', beschreibung: 'Geschlecht - Authentizit√§t, Kommunikation, Selbstausdruck' }
                };
                Object.values(resonanzfaktoren).forEach(function(r) {
                    suggestions.push({ type: 'resonanz', id: r.id, label: r.label, icon: r.icon, description: r.beschreibung, perspective: null });
                });
                // Show all perspectives
                if (window.TiageTaxonomie && window.TiageTaxonomie.perspektiven) {
                    Object.values(window.TiageTaxonomie.perspektiven).forEach(function(p) {
                        suggestions.push({ type: 'perspective', id: p.id, label: p.label, description: p.beschreibung, perspective: null });
                    });
                }
                return suggestions;
            }

            // Search in needs
            var needsSource = window.BeduerfnisKatalog?.beduerfnisse || (typeof BeduerfnisIds !== 'undefined' ? BeduerfnisIds.beduerfnisse : null);
            if (needsSource) {
                Object.values(needsSource).forEach(function(need) {
                    var matchScore = 0;
                    if (need.label && need.label.toLowerCase().includes(lowerQuery)) matchScore = 10;
                    if (need.id && need.id.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 8);
                    if (matchScore > 0) {
                        suggestions.push({ type: 'need', id: need.id, label: need.label, description: need.frage || '', perspective: getPerspectiveForNeed(need.id), score: matchScore });
                    }
                });
            }

            // Search in categories
            if (window.TiageTaxonomie && window.TiageTaxonomie.kategorien) {
                Object.values(window.TiageTaxonomie.kategorien).forEach(function(kat) {
                    var matchScore = 0;
                    if (kat.label && kat.label.toLowerCase().includes(lowerQuery)) matchScore = 9;
                    if (kat.beschreibung && kat.beschreibung.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 7);
                    if (kat.id && kat.id.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 8);
                    if (matchScore > 0) {
                        suggestions.push({ type: 'category', id: kat.id, label: kat.label, description: kat.beschreibung, perspective: getPerspectiveForCategory(kat.key), score: matchScore });
                    }
                });
            }

            // Search in dimensions
            if (window.TiageTaxonomie && window.TiageTaxonomie.dimensionen) {
                Object.values(window.TiageTaxonomie.dimensionen).forEach(function(dim) {
                    var matchScore = 0;
                    if (dim.label && dim.label.toLowerCase().includes(lowerQuery)) matchScore = 8;
                    if (dim.beschreibung && dim.beschreibung.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 6);
                    if (dim.id && dim.id.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 7);
                    if (matchScore > 0) {
                        suggestions.push({ type: 'dimension', id: dim.id, label: dim.label, description: dim.beschreibung, perspective: null, score: matchScore });
                    }
                });
            }

            // Search in resonance factors
            var resonanzfaktoren = {
                'R1': { id: 'R1', label: 'Leben', icon: 'üî•', beschreibung: 'Orientierung - Existenz, Zuneigung, Mu√üe, Intimit√§t' },
                'R2': { id: 'R2', label: 'Philosophie', icon: 'üß†', beschreibung: 'Archetyp - Lebensplanung, Werte, Finanzen' },
                'R3': { id: 'R3', label: 'Dynamik', icon: '‚ö°', beschreibung: 'Dominanz - Machtdynamik, BDSM, Sicherheit' },
                'R4': { id: 'R4', label: 'Identit√§t', icon: 'üíö', beschreibung: 'Geschlecht - Authentizit√§t, Kommunikation, Selbstausdruck' }
            };
            Object.values(resonanzfaktoren).forEach(function(r) {
                var matchScore = 0;
                if (r.label && r.label.toLowerCase().includes(lowerQuery)) matchScore = 8;
                if (r.beschreibung && r.beschreibung.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 6);
                if (r.id && r.id.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 7);
                if (matchScore > 0) {
                    suggestions.push({ type: 'resonanz', id: r.id, label: r.label, icon: r.icon, description: r.beschreibung, perspective: null, score: matchScore });
                }
            });

            suggestions.sort(function(a, b) { return (b.score || 0) - (a.score || 0); });
            return suggestions.slice(0, 15);
        }

        function renderSuggestionItem(suggestion, index) {
            var typeLabel = { 'need': 'Bed√ºrfnis', 'category': 'Kategorie', 'dimension': 'Dimension', 'resonanz': 'Resonanzfaktor', 'perspective': 'Perspektive' }[suggestion.type] || suggestion.type;
            var iconPrefix = suggestion.icon ? suggestion.icon + ' ' : '';
            var descriptionHTML = suggestion.description ? '<div class="suggestion-item-description">' + (suggestion.description.length > 120 ? suggestion.description.substring(0, 120) + '...' : suggestion.description) + '</div>' : '';
            return '<div class="suggestion-item' + (index === suggestionState.selectedIndex ? ' active' : '') + '" data-index="' + index + '" data-value="' + suggestion.label + '">' +
                '<div class="suggestion-item-header">' +
                '<span class="suggestion-item-type type-' + suggestion.type + '">' + typeLabel + '</span>' +
                '<span class="suggestion-item-label">' + iconPrefix + suggestion.label + '</span>' +
                '<span class="suggestion-item-id">' + suggestion.id + '</span>' +
                '</div>' + descriptionHTML + '</div>';
        }

        function displaySearchSuggestions(suggestions) {
            var dropdown = document.getElementById('searchSuggestionsDropdown');
            var content = dropdown ? dropdown.querySelector('.search-suggestions-content') : null;
            if (!dropdown || !content) return;

            suggestionState.suggestions = suggestions;
            suggestionState.selectedIndex = -1;

            if (suggestions.length === 0) {
                content.innerHTML = '<div class="search-suggestions-empty">Keine Vorschl√§ge gefunden</div>';
                dropdown.style.display = 'block';
                return;
            }

            var grouped = { 'need': [], 'category': [], 'dimension': [], 'resonanz': [], 'perspective': [] };
            suggestions.forEach(function(s, i) { if (grouped[s.type]) grouped[s.type].push({suggestion: s, index: i}); });

            var html = '';
            var order = ['need', 'category', 'dimension', 'resonanz', 'perspective'];
            var headers = { 'need': 'Bed√ºrfnisse', 'category': 'Kategorien', 'dimension': 'Dimensionen', 'resonanz': 'Resonanzfaktoren', 'perspective': 'Perspektiven' };
            order.forEach(function(type) {
                if (grouped[type].length > 0) {
                    html += '<div class="suggestion-section-header">' + headers[type] + '</div>';
                    grouped[type].forEach(function(item) { html += renderSuggestionItem(item.suggestion, item.index); });
                }
            });

            content.innerHTML = html;
            dropdown.style.display = 'block';
            content.querySelectorAll('.suggestion-item').forEach(function(item) {
                item.addEventListener('click', function() { selectSuggestion(parseInt(item.getAttribute('data-index'))); });
            });
        }

        function hideSearchSuggestions() {
            var dropdown = document.getElementById('searchSuggestionsDropdown');
            if (dropdown) dropdown.style.display = 'none';
            suggestionState.selectedIndex = -1;
        }
        window.hideSearchSuggestions = hideSearchSuggestions;

        /**
         * Hilfsfunktion: Kategorie-ID eines Bed√ºrfnisses ermitteln
         */
        function getNeedCategoryId(needId) {
            if (!window.BeduerfnisKatalog || !window.BeduerfnisKatalog.beduerfnisse) return null;
            var need = window.BeduerfnisKatalog.beduerfnisse[needId];
            return need ? need.kategorie : null;
        }

        /**
         * Hilfsfunktion: Dimension-ID eines Bed√ºrfnisses ermitteln
         */
        function getNeedDimensionId(needId) {
            var categoryId = getNeedCategoryId(needId);
            if (!categoryId) return null;
            if (!window.TiageTaxonomie || !window.TiageTaxonomie.kategorien) return null;
            var category = window.TiageTaxonomie.kategorien[categoryId];
            return category ? category.dimension : null;
        }

        /**
         * Hilfsfunktion: Alle durchsuchbaren Texte f√ºr ein Bed√ºrfnis sammeln
         */
        function getSearchableTextsForNeed(needId, labelText) {
            var texts = [labelText, needId];

            // Kategorie-Info hinzuf√ºgen
            var categoryId = getNeedCategoryId(needId);
            if (categoryId && window.TiageTaxonomie && window.TiageTaxonomie.kategorien) {
                var category = window.TiageTaxonomie.kategorien[categoryId];
                if (category) {
                    if (category.label) texts.push(category.label);
                    if (category.key) texts.push(category.key);
                    // Dimension-Info
                    if (category.dimension && window.TiageTaxonomie.dimensionen) {
                        var dimension = window.TiageTaxonomie.dimensionen[category.dimension];
                        if (dimension) {
                            if (dimension.label) texts.push(dimension.label);
                            if (dimension.id) texts.push(dimension.id);
                        }
                    }
                }
            }

            // Perspektive-Info hinzuf√ºgen
            var perspective = getPerspectiveForNeed(needId);
            if (perspective) {
                if (perspective.label) texts.push(perspective.label);
                if (perspective.id) texts.push(perspective.id);
            }

            return texts.join(' ').toLowerCase();
        }

        /**
         * Pr√ºft ob alle Komma-separierten Kriterien im Text gefunden werden (AND-Logik)
         */
        function matchesAllCriteria(searchableText, criteria) {
            if (!criteria || criteria.length === 0) return true;

            for (var i = 0; i < criteria.length; i++) {
                var criterion = criteria[i].toLowerCase();
                if (criterion && !searchableText.includes(criterion)) {
                    return false;
                }
            }
            return true;
        }

        function filterProfileReviewByNeed(query) {
            // Direkte Filterung der flat-need-item Elemente
            var flatNeedItems = document.querySelectorAll('.flat-need-item');
            if (!flatNeedItems.length) return;

            // Wenn leer, alle anzeigen
            if (!query || !query.trim()) {
                flatNeedItems.forEach(function(item) {
                    item.classList.remove('filter-hidden', 'filter-match');
                });
                return;
            }

            // Komma-separierte Kriterien extrahieren (AND-Logik)
            // "LIe,schm" ‚Üí ["lie", "schm"] - beide m√ºssen matchen
            var criteria = query.split(',').map(function(c) { return c.trim().toLowerCase(); }).filter(function(c) { return c.length > 0; });

            var totalMatches = 0;

            flatNeedItems.forEach(function(item) {
                var needId = item.getAttribute('data-need') || '';
                var needLabel = item.querySelector('.flat-need-label');
                var labelText = needLabel ? needLabel.textContent : '';

                // Alle durchsuchbaren Texte sammeln (Label, ID, Kategorie, Dimension, Perspektive)
                // und pr√ºfen ob ALLE Kriterien irgendwo vorkommen
                var searchableText = getSearchableTextsForNeed(needId, labelText);
                var matches = matchesAllCriteria(searchableText, criteria);

                item.classList.toggle('filter-hidden', !matches);
                item.classList.toggle('filter-match', matches);

                if (matches) totalMatches++;
            });

            console.log('[Filter] needs-editor:', query, '- Matches:', totalMatches);
        }

        function handleIntelligentSearch(query) {
            filterProfileReviewByNeed(query);
            var suggestions = generateSearchSuggestions(query);
            displaySearchSuggestions(suggestions);
        }
        window.handleIntelligentSearch = handleIntelligentSearch;

        function showSearchSuggestions() {
            var input = document.getElementById('profileReviewSearchInput');
            if (!input) return;
            var suggestions = generateSearchSuggestions(input.value || '');
            displaySearchSuggestions(suggestions);
        }
        window.showSearchSuggestions = showSearchSuggestions;

        function selectSuggestion(index) {
            if (index < 0 || index >= suggestionState.suggestions.length) return;
            var suggestion = suggestionState.suggestions[index];
            var input = document.getElementById('profileReviewSearchInput');
            suggestionState.activeSuggestion = suggestion;

            // Pr√ºfe ob bereits mehrere Begriffe vorhanden sind (Komma = UND-Verkn√ºpfung)
            var hasMultipleTerms = input && input.value.includes(',');

            // FIX: Bei Bed√ºrfnis-Auswahl -> Textsuche mit dem Label
            if (suggestion.type === 'need') {
                // Setze das Suchfeld auf das Bed√ºrfnis-Label (ohne Komma am Ende)
                if (input) {
                    input.value = suggestion.label;
                }
                // Filter zur√ºcksetzen OHNE Event auszul√∂sen (sonst wird activeSuggestion gel√∂scht)
                if (typeof DimensionKategorieFilter !== 'undefined') {
                    DimensionKategorieFilter.reset(true); // silent = true
                }
                filterProfileReviewByNeed(suggestion.label);
                console.log('[Filter] Bed√ºrfnis als Textsuche:', suggestion.label);
                hideSearchSuggestions();
                displayActiveSuggestion();
                return;
            }

            // F√ºr andere Typen: Komma-Logik beibehalten
            if (input) {
                var parts = input.value.split(',').map(function(p) { return p.trim(); }).filter(function(p) { return p.length > 0; });
                // Letzten (unvollst√§ndigen) Teil ersetzen
                if (parts.length > 0) {
                    parts[parts.length - 1] = suggestion.label;
                } else {
                    parts.push(suggestion.label);
                }
                input.value = parts.join(', ') + ', ';
                input.focus();
            }

            // FIX: Bei Resonanzfaktor-Auswahl den DimensionKategorieFilter aktivieren
            if (suggestion.type === 'resonanz' && typeof DimensionKategorieFilter !== 'undefined') {
                // Bei Mehrfach-Auswahl: NICHT resetten, sondern hinzuf√ºgen
                if (!hasMultipleTerms) {
                    DimensionKategorieFilter.reset();
                }
                // Alle Kategorien des Resonanzfaktors aktivieren
                var kategorien = DimensionKategorieFilter.KATEGORIEN_PRO_DIMENSION[suggestion.id];
                if (kategorien && kategorien.length > 0) {
                    kategorien.forEach(function(kat) {
                        if (!DimensionKategorieFilter.isKategorieActive(kat.id)) {
                            DimensionKategorieFilter.toggleKategorie(kat.id);
                        }
                    });
                    console.log('[Filter] Resonanzfaktor aktiviert:', suggestion.id);
                }
                filterProfileReviewByNeed('');
            } else if (suggestion.type === 'category' && typeof DimensionKategorieFilter !== 'undefined') {
                // Bei Kategorie-Auswahl: NICHT resetten bei Mehrfach-Auswahl
                if (!hasMultipleTerms) {
                    DimensionKategorieFilter.reset();
                }
                // Kategorie hinzuf√ºgen (nur wenn nicht bereits aktiv)
                if (!DimensionKategorieFilter.isKategorieActive(suggestion.id)) {
                    DimensionKategorieFilter.toggleKategorie(suggestion.id);
                }
                console.log('[Filter] Kategorie aktiviert:', suggestion.id);
                filterProfileReviewByNeed('');
            } else {
                // F√ºr andere Typen (dimension, perspective)
                if (typeof DimensionKategorieFilter !== 'undefined' && !hasMultipleTerms) {
                    DimensionKategorieFilter.reset();
                }
                filterProfileReviewByNeed(input ? input.value : '');
            }

            hideSearchSuggestions();
            displayActiveSuggestion();
        }

        function displayActiveSuggestion() {
            var hint = document.getElementById('profileReviewSearchHint');
            console.log('[displayActiveSuggestion] hint element:', hint);
            if (!hint) {
                console.error('[displayActiveSuggestion] profileReviewSearchHint nicht gefunden!');
                return;
            }
            var suggestion = suggestionState.activeSuggestion;
            console.log('[displayActiveSuggestion] suggestion:', suggestion);
            if (!suggestion) {
                console.warn('[displayActiveSuggestion] Keine activeSuggestion gesetzt');
                return;
            }

            // FIX: Bei Bed√ºrfnis/Textsuche spezielle Anzeige
            if (suggestion.type === 'need') {
                console.log('[displayActiveSuggestion] Zeige Textsuche-Tag f√ºr:', suggestion.label);
                hint.innerHTML = '<span class="search-active-selection">' +
                    '<span class="search-active-type type-textsearch">üîç Textsuche</span>' +
                    '<span class="search-active-label">"' + suggestion.label + '"</span>' +
                    '<button class="search-active-clear" onclick="clearActiveSuggestion()" title="Suche entfernen">√ó</button></span>';
                hint.classList.add('has-active-selection');
                return;
            }

            var typeLabel = { 'category': 'Kategorie', 'dimension': 'Dimension', 'resonanz': 'Resonanzfaktor', 'perspective': 'Perspektive' }[suggestion.type] || suggestion.type;
            var iconPrefix = suggestion.icon ? suggestion.icon + ' ' : '';
            hint.innerHTML = '<span class="search-active-selection">' +
                '<span class="search-active-type type-' + suggestion.type + '">' + typeLabel + '</span>' +
                '<span class="search-active-label">' + iconPrefix + suggestion.label + '</span>' +
                '<span class="search-active-id">' + suggestion.id + '</span>' +
                '<button class="search-active-clear" onclick="clearActiveSuggestion()" title="Auswahl entfernen">√ó</button></span>';
            hint.classList.add('has-active-selection');
        }
        window.displayActiveSuggestion = displayActiveSuggestion;

        function clearActiveSuggestion() {
            suggestionState.activeSuggestion = null;
            var hint = document.getElementById('profileReviewSearchHint');
            if (hint) { hint.innerHTML = ''; hint.classList.remove('has-active-selection'); }
            // Clear the search input and reset filter
            var input = document.getElementById('profileReviewSearchInput');
            if (input) { input.value = ''; }
            // Reset filter to show all items
            filterProfileReviewByNeed('');
            // Hide suggestions dropdown
            hideSearchSuggestions();
        }
        window.clearActiveSuggestion = clearActiveSuggestion;

        function handleSearchKeydown(event) {
            var dropdown = document.getElementById('searchSuggestionsDropdown');
            var dropdownVisible = dropdown && dropdown.style.display !== 'none';
            var suggestions = suggestionState.suggestions || [];

            // Enter funktioniert auch ohne sichtbares Dropdown (f√ºr Textsuche)
            if (event.key === 'Enter') {
                event.preventDefault();
                if (dropdownVisible && suggestionState.selectedIndex >= 0) {
                    selectSuggestion(suggestionState.selectedIndex);
                } else {
                    // FIX: Bei Enter ohne Vorschlagsauswahl -> Textsuche aktivieren
                    var input = document.getElementById('profileReviewSearchInput');
                    var query = input ? input.value.trim() : '';
                    if (query.length > 0) {
                        suggestionState.activeSuggestion = {
                            type: 'need',
                            id: null,
                            label: query
                        };
                        displayActiveSuggestion();
                        hideSearchSuggestions();
                        console.log('[handleSearchKeydown] Textsuche aktiviert f√ºr:', query);
                    }
                }
                return;
            }

            // F√ºr andere Tasten: Dropdown muss sichtbar sein
            if (!dropdownVisible) return;
            if (suggestions.length === 0) return;

            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    suggestionState.selectedIndex = Math.min(suggestionState.selectedIndex + 1, suggestions.length - 1);
                    updateSuggestionSelection();
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    suggestionState.selectedIndex = Math.max(suggestionState.selectedIndex - 1, -1);
                    updateSuggestionSelection();
                    break;
                case 'Escape':
                    event.preventDefault();
                    hideSearchSuggestions();
                    break;
            }
        }
        window.handleSearchKeydown = handleSearchKeydown;

        function updateSuggestionSelection() {
            var content = document.querySelector('.search-suggestions-content');
            if (!content) return;
            content.querySelectorAll('.suggestion-item').forEach(function(item, index) {
                if (index === suggestionState.selectedIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    item.classList.remove('active');
                }
            });
        }

        function clearProfileReviewSearch() {
            var input = document.getElementById('profileReviewSearchInput');
            if (input) input.value = '';
            filterProfileReviewByNeed('');
            hideSearchSuggestions();
            clearActiveSuggestion();
            // Update clear button visibility
            var wrapper = document.querySelector('.profile-review-search-wrapper');
            if (wrapper) wrapper.classList.remove('has-value');
        }
        window.clearProfileReviewSearch = clearProfileReviewSearch;

        // Close suggestions when clicking outside
        document.addEventListener('click', function(event) {
            var searchWrapper = document.querySelector('.profile-review-search-wrapper');
            var dropdown = document.getElementById('searchSuggestionsDropdown');
            if (searchWrapper && dropdown && !searchWrapper.contains(event.target) && !dropdown.contains(event.target)) {
                hideSearchSuggestions();
            }
        });

        // Update clear button visibility on input
        document.addEventListener('DOMContentLoaded', function() {
            var input = document.getElementById('profileReviewSearchInput');
            if (input) {
                input.addEventListener('input', function() {
                    var wrapper = document.querySelector('.profile-review-search-wrapper');
                    if (wrapper) wrapper.classList.toggle('has-value', this.value.length > 0);
                });
            }
        });

        // FIX: Bei Filter-Reset auch Suchstring und aktive Suggestion l√∂schen
        document.addEventListener('dimensionKategorieFilterChange', function(event) {
            var kategorien = event.detail && event.detail.kategorien;
            // Wenn Filter zur√ºckgesetzt wurde (keine Kategorien aktiv)
            if (!kategorien || kategorien.length === 0) {
                // Suchstring leeren
                var input = document.getElementById('profileReviewSearchInput');
                if (input && input.value) {
                    input.value = '';
                    filterProfileReviewByNeed('');
                }
                // Aktive Suggestion l√∂schen
                if (suggestionState.activeSuggestion) {
                    suggestionState.activeSuggestion = null;
                    var hint = document.getElementById('profileReviewSearchHint');
                    if (hint) {
                        hint.innerHTML = '';
                        hint.classList.remove('has-active-selection');
                    }
                }
                // Clear button visibility aktualisieren
                var wrapper = document.querySelector('.profile-review-search-wrapper');
                if (wrapper) wrapper.classList.remove('has-value');
                console.log('[Filter] Reset: Suchstring und aktive Suggestion gel√∂scht');
            }
        });
    </script>

    <!-- Need Definition Modal -->
    <div id="needDefinitionModal" class="need-definition-modal" onclick="closeNeedDefinitionModal(event)">
        <div class="need-definition-modal-content" onclick="event.stopPropagation()">
            <div class="need-definition-modal-header">
                <h3 id="needDefinitionModalTitle">Bed√ºrfnis</h3>
                <button class="need-definition-modal-close" onclick="closeNeedDefinitionModal()">&times;</button>
            </div>
            <div id="needDefinitionModalBody" class="need-definition-modal-body">
                <!-- Content wird dynamisch generiert -->
            </div>
        </div>
    </div>

    <style>
        /* Need Definition Modal Styles */
        .need-definition-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .need-definition-modal.active {
            display: flex;
        }
        .need-definition-modal-content {
            background: var(--card-bg, #1a1a2e);
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .need-definition-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .need-definition-modal-header h3 {
            margin: 0;
            font-size: 18px;
            color: var(--text-primary, #fff);
        }
        .need-definition-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-muted, #888);
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .need-definition-modal-close:hover {
            color: var(--text-primary, #fff);
        }
        .need-definition-modal-body {
            padding: 20px;
        }

        /* Need Modal Content Styles */
        .need-modal-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .need-modal-id-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .need-modal-id {
            font-family: monospace;
            font-size: 11px;
            color: var(--text-muted, #888);
            background: rgba(255,255,255,0.05);
            padding: 3px 8px;
            border-radius: 4px;
        }

        .need-modal-type {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .need-modal-type-haupt {
            background: rgba(59,130,246,0.15);
            color: #3B82F6;
        }

        .need-modal-type-nuance {
            background: rgba(139,92,246,0.15);
            color: #8B5CF6;
        }

        .need-modal-meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .need-modal-meta-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .need-modal-meta-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted, #888);
        }

        .need-modal-meta-value {
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .need-modal-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .need-modal-badge {
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .need-modal-question {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 14px;
            background: rgba(59,130,246,0.08);
            border-radius: 10px;
            border-left: 3px solid #3B82F6;
        }

        .need-modal-question-icon {
            font-size: 16px;
            flex-shrink: 0;
        }

        .need-modal-question-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-primary, #fff);
            font-style: italic;
        }

        .need-modal-context {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .need-modal-context-label {
            color: var(--text-muted, #888);
        }

        .need-modal-context-text {
            color: var(--text-primary, #fff);
        }

        .need-modal-parent {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .need-modal-parent-label {
            color: var(--text-muted, #888);
        }

        .need-modal-parent-link {
            color: #3B82F6;
            cursor: pointer;
            text-decoration: underline;
        }

        .need-modal-parent-link:hover {
            color: #60a5fa;
        }

        .need-modal-nuancen {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .need-modal-nuancen-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted, #888);
        }

        .need-modal-nuancen-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .need-modal-nuance-tag {
            font-size: 11px;
            padding: 4px 10px;
            background: rgba(139,92,246,0.1);
            color: #a78bfa;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .need-modal-nuance-tag:hover {
            background: rgba(139,92,246,0.2);
            color: #c4b5fd;
        }

        .need-modal-value {
            margin-top: 8px;
            padding: 14px;
            background: rgba(74,144,217,0.08);
            border-radius: 10px;
            border: 1px solid rgba(74,144,217,0.2);
        }

        .need-modal-value-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .need-modal-value-label {
            font-size: 12px;
            color: var(--text-muted, #888);
        }

        .need-modal-value-number {
            font-size: 22px;
            font-weight: 700;
            color: var(--accent-primary, #4a90d9);
        }

        .need-modal-value-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .need-modal-value-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary, #4a90d9), #60a5fa);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
    </style>
</body>
</html>
