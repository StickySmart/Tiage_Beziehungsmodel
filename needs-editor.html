<!--
 * ¬© 2025 Ti-age.de Alle Rechte vorbehalten.
 * Dieses Werk ist urheberrechtlich gesch√ºtzt.
 * Jegliche Nutzung ohne ausdr√ºckliche Genehmigung ist untersagt.
 -->
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bed√ºrfnis-Editor | Ti-Age</title>
    <link rel="canonical" href="https://ti-age.de/needs-editor.html">
    <!-- Zentrale CSS-Variablen - EINZIGE QUELLE -->
    <link rel="stylesheet" href="templates/variables.css?v=20251205c">
    <link rel="stylesheet" href="templates/template_desktop.css?v=20251205c">
    <link rel="stylesheet" href="templates/template_mobile.css?v=20251205c" media="(max-width: 768px)">
    <!-- Profile Review Styling -->
    <link rel="stylesheet" href="css/profile-review.css">
    <!-- Resonanz Profile Header Card Styling -->
    <link rel="stylesheet" href="css/resonanz-profile-header-card.css">
    <!-- Resonanz Tree View Styling -->
    <link rel="stylesheet" href="css/resonanz-tree-view.css">

    <!-- LocalForage - Browser-Datenbank f√ºr Profile -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

    <!-- TIAGE i18n - Internationalisierung -->
    <script src="js/locales/de.js"></script>
    <script src="js/locales/en.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/version.js"></script>

    <!-- TIAGE Micro-Statements Databases -->
    <script src="statements/archetypeStatements.js"></script>
    <script src="statements/archetypeStatements_EN.js"></script>
    <script src="statements/dominanceStatements.js"></script>
    <script src="statements/orientationStatements.js"></script>
    <script src="statements/statusStatements.js"></script>
    <script src="statements/gfkStatements.js"></script>
    <script src="statements/resonanceQuotesTable.js"></script>

    <!-- TIAGE SYNTHESE - Zentralisierte Berechnungslogik -->
    <script src="js/synthesis/constants.js"></script>
    <script src="js/help-texts.js"></script>
    <script src="js/synthesis/needsIntegration.js"></script>
    <script src="js/synthesis/factors/archetypeMatrixCalculator.js"></script>
    <script src="js/synthesis/factors/archetypeFactor.js"></script>
    <script src="js/synthesis/factors/dominanceFactor.js"></script>
    <script src="js/synthesis/factors/orientationFactor.js"></script>
    <script src="js/synthesis/factors/genderFactor.js"></script>
    <script src="js/synthesis/lifestyleFilter.js"></script>
    <script src="js/utils/statistics.js"></script>
    <script src="js/synthesis/synthesisCalculator.js"></script>
    <script src="js/synthesis/pathosTextGenerator.js"></script>
    <script src="js/synthesis/logosTextGenerator.js"></script>
    <script src="js/synthesis/oshoZenTextGenerator.js"></script>
    <script src="js/synthesis/integratedSynthesisTextGenerator.js"></script>

    <!-- TIAGE COMPATIBILITY -->
    <script src="js/compatibility/physicalCompatibility.js"></script>
    <script src="js/compatibility/philosophyCompatibility.js"></script>
    <script src="js/compatibility/compatibilityOrchestrator.js"></script>

    <!-- TIAGE DIMENSIONS -->
    <script src="js/dimensions/tagDimensionRelevance.js"></script>
    <script src="js/dimensions/dominanzModifier.js"></script>
    <script src="js/dimensions/tagCalculator.js"></script>
    <!-- BED√úRFNIS-IDs -->
    <script src="profiles/definitions/beduerfnis-ids.js"></script>
    <!-- BED√úRFNIS-KATALOG v3.0.0 Loader -->
    <script src="profiles/data/beduerfnis-katalog-loader.js"></script>
    <!-- ARCHETYP PROFILE -->
    <script src="profiles/archetypen/single.js"></script>
    <script src="profiles/archetypen/duo.js"></script>
    <script src="profiles/archetypen/duo-flex.js"></script>
    <script src="profiles/archetypen/solopoly.js"></script>
    <script src="profiles/archetypen/polyamor.js"></script>
    <script src="profiles/archetypen/ra.js"></script>
    <script src="profiles/archetypen/lat.js"></script>
    <script src="profiles/archetypen/aromantisch.js"></script>
    <script src="profiles/archetypen/index.js"></script>
    <!-- GESCHLECHTSIDENTIT√ÑT MODIFIER -->
    <script src="profiles/modifiers/gender/mann-cis.js"></script>
    <script src="profiles/modifiers/gender/mann-trans.js"></script>
    <script src="profiles/modifiers/gender/mann-suchend.js"></script>
    <script src="profiles/modifiers/gender/frau-cis.js"></script>
    <script src="profiles/modifiers/gender/frau-trans.js"></script>
    <script src="profiles/modifiers/gender/frau-suchend.js"></script>
    <script src="profiles/modifiers/gender/inter-nonbinaer.js"></script>
    <script src="profiles/modifiers/gender/inter-fluid.js"></script>
    <script src="profiles/modifiers/gender/inter-suchend.js"></script>
    <!-- DOMINANZ MODIFIER -->
    <script src="profiles/modifiers/dominanz/dominant.js"></script>
    <script src="profiles/modifiers/dominanz/submissiv.js"></script>
    <script src="profiles/modifiers/dominanz/switch.js"></script>
    <script src="profiles/modifiers/dominanz/ausgeglichen.js"></script>
    <!-- ORIENTIERUNG MODIFIER -->
    <script src="profiles/modifiers/orientierung/heterosexuell.js"></script>
    <script src="profiles/modifiers/orientierung/homosexuell.js"></script>
    <script src="profiles/modifiers/orientierung/bisexuell.js"></script>
    <!-- MODIFIER INDEX -->
    <script src="profiles/modifiers/index.js"></script>
    <!-- SSOT Taxonomie -->
    <script src="profiles/definitions/taxonomie.js"></script>
    <!-- GFK Bed√ºrfnisse & Modifikatoren -->
    <script src="profiles/definitions/gfk-beduerfnisse.js"></script>
    <script src="profiles/beduerfnis-modifikatoren.js"></script>
    <script src="profiles/definitions/archetyp-definitions.js"></script>
    <script src="profiles/profile-store.js"></script>

    <style>
        /* Page-specific styles for full-screen needs editor */
        .needs-editor-page {
            min-height: 100vh;
            background: var(--bg-dark, #0a0a0f);
            display: flex;
            flex-direction: column;
        }

        .needs-editor-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg-card, #1a1a2e);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .needs-editor-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .needs-editor-back-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-primary, #fff);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .needs-editor-back-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: var(--primary, #FFD700);
        }

        .needs-editor-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary, #fff);
        }

        .needs-editor-badge {
            background: var(--primary, #FFD700);
            color: #000;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .needs-editor-content {
            flex: 1;
            padding: 16px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        /* Search container */
        .needs-editor-search {
            background: var(--bg-card, #1a1a2e);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .needs-editor-search-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: var(--text-primary, #fff);
            font-size: 14px;
            box-sizing: border-box;
        }

        .needs-editor-search-input:focus {
            outline: none;
            border-color: var(--primary, #FFD700);
        }

        /* Needs list container */
        .needs-editor-list-container {
            background: var(--bg-card, #1a1a2e);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }

        /* Override profile-review styles for full page */
        .needs-editor-list-container .flat-needs-container {
            padding: 0;
        }

        .needs-editor-list-container .flat-needs-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--bg-card, #1a1a2e);
        }

        .needs-editor-list-container .flat-needs-list-wrapper {
            max-height: none;
            overflow: visible;
        }

        .needs-editor-list-container .flat-needs-list {
            max-height: none;
        }

        /* Person toggle */
        .needs-editor-person-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            justify-content: center;
        }

        .needs-editor-person-btn {
            padding: 10px 24px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: var(--text-secondary, #999);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .needs-editor-person-btn.active {
            background: var(--primary, #FFD700);
            color: #000;
            border-color: var(--primary, #FFD700);
        }

        .needs-editor-person-btn:hover:not(.active) {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.3);
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            .needs-editor-header {
                flex-wrap: wrap;
            }

            .needs-editor-title {
                font-size: 16px;
            }

            .needs-editor-content {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="needs-editor-page">
        <!-- Header -->
        <header class="needs-editor-header">
            <div class="needs-editor-header-left">
                <button class="needs-editor-back-btn" onclick="goBack()">
                    <span>&#x2190;</span>
                    <span>Zur√ºck</span>
                </button>
                <h1 class="needs-editor-title">Alle Bed√ºrfnisse</h1>
                <span class="needs-editor-badge" id="needsEditorBadge">Profil</span>
            </div>
        </header>

        <!-- Main Content -->
        <main class="needs-editor-content">
            <!-- Person Toggle -->
            <div class="needs-editor-person-toggle">
                <button class="needs-editor-person-btn active" id="btnPersonIch" onclick="switchPerson('ich')">
                    ICH
                </button>
                <button class="needs-editor-person-btn" id="btnPersonPartner" onclick="switchPerson('partner')">
                    PARTNER
                </button>
            </div>

            <!-- Search/Filter - using profile-review styles -->
            <div class="profile-review-search-container" style="position: relative; z-index: 102;">
                <div class="profile-review-search-wrapper">
                    <span class="profile-review-search-icon">üîç</span>
                    <input type="text"
                           id="profileReviewSearchInput"
                           class="profile-review-search-input"
                           placeholder="Such..."
                           oninput="handleIntelligentSearch(this.value)"
                           onkeydown="handleSearchKeydown(event)"
                           onfocus="showSearchSuggestions()"
                           autocomplete="off">
                    <button class="profile-review-search-clear"
                            onclick="clearProfileReviewSearch()"
                            title="Suche leeren">√ó</button>
                    <!-- Intelligent Suggestions Dropdown -->
                    <div id="searchSuggestionsDropdown" class="search-suggestions-dropdown" style="display: none;">
                        <div class="search-suggestions-content"></div>
                    </div>
                </div>
                <div class="profile-review-search-hint" id="profileReviewSearchHint"></div>
            </div>

            <!-- Filter Controls Container wird dynamisch in renderAllNeedsFlat generiert -->

            <!-- Needs List -->
            <div class="needs-editor-list-container" id="needsEditorListContainer">
                <div style="padding: 40px; text-align: center; color: rgba(255,255,255,0.6);">
                    Lade Bed√ºrfnisse...
                </div>
            </div>
        </main>
    </div>

    <!-- State Management - Single Source of Truth -->
    <script src="js/state.js"></script>
    <!-- Memory Manager -->
    <script src="js/memory-manager.js"></script>

    <script src="js/app-i18n.js"></script>

    <!-- Profile UI Components -->
    <script src="js/components/TripleButtonGroup.js"></script>
    <script src="js/components/ProfileCard.js"></script>
    <script src="js/components/GewichtungCard.js"></script>
    <script src="js/components/ResonanzCard.js"></script>
    <script src="js/components/ResonanzProfileHeaderCard.js"></script>
    <script src="js/components/CategorySection.js"></script>
    <script src="js/components/profile-config.js"></script>
    <!-- Universeller Dimension-Kategorie-Filter -->
    <script src="js/components/DimensionKategorieFilter.js"></script>
    <!-- Resonanz Tree View -->
    <script src="js/components/ResonanzTreeView.js"></script>
    <script src="js/components/AttributeSummaryCard.js"></script>
    <script src="js/components/profile-components.js"></script>

    <script>
        // Current state
        let currentPerson = 'ich';
        let currentArchetype = 'polyamor';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeNeedsEditor();
        });

        function initializeNeedsEditor() {
            // Get params from URL or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            currentPerson = urlParams.get('person') || localStorage.getItem('tiage_needs_editor_person') || 'ich';
            currentArchetype = urlParams.get('archetype') || localStorage.getItem('tiage_selected_archetype_ich') || 'polyamor';

            // Update person toggle
            updatePersonToggle();

            // Update badge
            updateBadge();

            // Load data from TiageState or localStorage
            loadNeedsData();

            // Render the needs list
            renderNeedsList();
        }

        function updatePersonToggle() {
            document.getElementById('btnPersonIch').classList.toggle('active', currentPerson === 'ich');
            document.getElementById('btnPersonPartner').classList.toggle('active', currentPerson === 'partner');
        }

        function updateBadge() {
            const badge = document.getElementById('needsEditorBadge');
            const archetypeLabels = {
                'single': 'Single',
                'duo': 'Duo',
                'duo-flex': 'Duo-Flex',
                'solopoly': 'Solo-Poly',
                'polyamor': 'Polyamor',
                'ra': 'RA',
                'lat': 'LAT',
                'aromantisch': 'Aromantisch'
            };
            badge.textContent = archetypeLabels[currentArchetype] || currentArchetype;
        }

        function loadNeedsData() {
            // Try to load from TiageState first
            if (typeof TiageState !== 'undefined') {
                const flatNeeds = TiageState.get('flatNeeds.' + currentPerson);
                if (flatNeeds && flatNeeds.length > 0) {
                    console.log('[NeedsEditor] Loaded from TiageState:', flatNeeds.length, 'needs');
                    return;
                }
            }

            // Fallback to localStorage
            const stored = localStorage.getItem('tiage_flat_needs');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    if (typeof AttributeSummaryCard !== 'undefined') {
                        AttributeSummaryCard.setFlatNeeds(parsed);
                    }
                    console.log('[NeedsEditor] Loaded from localStorage');
                } catch (e) {
                    console.error('[NeedsEditor] Error parsing localStorage:', e);
                }
            }
        }

        function renderNeedsList() {
            const container = document.getElementById('needsEditorListContainer');

            if (typeof AttributeSummaryCard === 'undefined') {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #f87171;">Fehler: AttributeSummaryCard nicht geladen</div>';
                return;
            }

            // Get archetype for person
            const archetype = currentPerson === 'ich'
                ? (localStorage.getItem('tiage_selected_archetype_ich') || 'polyamor')
                : (localStorage.getItem('tiage_selected_archetype_partner') || 'polyamor');

            // Get archetype label
            const archetypeLabels = {
                'single': 'Single',
                'duo': 'Duo',
                'duo-flex': 'Duo-Flex',
                'solopoly': 'Solo-Poly',
                'polyamor': 'Polyamor',
                'ra': 'RA',
                'lat': 'LAT',
                'aromantisch': 'Aromantisch'
            };
            const archetypeLabel = archetypeLabels[archetype] || archetype;

            // Render using AttributeSummaryCard with both archetype and label
            const html = AttributeSummaryCard.renderAllNeedsFlat(archetype, archetypeLabel);
            container.innerHTML = html;

            // Initialize multi-select controls if available
            if (typeof AttributeSummaryCard.initDimensionFilter === 'function') {
                setTimeout(function() {
                    AttributeSummaryCard.initDimensionFilter();
                }, 100);
            }

            console.log('[NeedsEditor] Rendered needs list for', currentPerson, 'with archetype', archetype);
        }

        function switchPerson(person) {
            // Save current state first
            saveCurrentState();

            currentPerson = person;
            localStorage.setItem('tiage_needs_editor_person', person);

            // Update UI
            updatePersonToggle();

            // Update archetype for this person
            currentArchetype = person === 'ich'
                ? (localStorage.getItem('tiage_selected_archetype_ich') || 'polyamor')
                : (localStorage.getItem('tiage_selected_archetype_partner') || 'polyamor');
            updateBadge();

            // Reload data and re-render
            loadNeedsData();
            renderNeedsList();
        }

        function saveCurrentState() {
            if (typeof AttributeSummaryCard !== 'undefined') {
                const flatNeeds = AttributeSummaryCard.getFlatNeeds();
                if (flatNeeds) {
                    // Save to localStorage
                    localStorage.setItem('tiage_flat_needs', JSON.stringify(flatNeeds));

                    // Save to TiageState if available
                    if (typeof TiageState !== 'undefined') {
                        TiageState.set('flatNeeds.' + currentPerson, flatNeeds);
                    }
                }
            }
        }

        function handleNeedsSearch(query) {
            if (typeof AttributeSummaryCard !== 'undefined' && typeof AttributeSummaryCard.filterBySearch === 'function') {
                AttributeSummaryCard.filterBySearch(query);
            }
        }

        function goBack() {
            // Check if there's a referrer
            if (document.referrer && document.referrer.includes(window.location.hostname)) {
                window.history.back();
            } else {
                window.location.href = 'archetype-interaction.html';
            }
        }

        function saveAndGoBack() {
            saveCurrentState();

            // Dispatch event for main page to update
            window.dispatchEvent(new CustomEvent('flatNeedsUpdated', {
                detail: { person: currentPerson }
            }));

            goBack();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INTELLIGENT SEARCH SUGGESTIONS (adapted from app-main.js)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        var suggestionState = {
            selectedIndex: -1,
            suggestions: [],
            activeSuggestion: null
        };

        function getPerspectiveForCategory(categoryKey) {
            if (window.PerspektivenModal && window.PerspektivenModal.kategoriePerspektiven) {
                var perspId = window.PerspektivenModal.kategoriePerspektiven[categoryKey];
                if (perspId && window.PerspektivenModal.perspektiven[perspId]) {
                    return window.PerspektivenModal.perspektiven[perspId];
                }
            }
            return null;
        }

        function getPerspectiveForNeed(needId) {
            if (!window.BeduerfnisKatalog || !window.BeduerfnisKatalog.beduerfnisse) return null;
            var need = window.BeduerfnisKatalog.beduerfnisse[needId];
            if (!need || !need.kategorie) return null;
            var categoryId = need.kategorie;
            if (!window.TiageTaxonomie || !window.TiageTaxonomie.kategorien) return null;
            var category = window.TiageTaxonomie.kategorien[categoryId];
            if (!category || !category.key) return null;
            return getPerspectiveForCategory(category.key);
        }

        function generateSearchSuggestions(query) {
            var suggestions = [];
            var parts = query.split(',');
            var lastPart = parts[parts.length - 1].trim();
            var lowerQuery = lastPart.toLowerCase();

            if (!lowerQuery) {
                // Show all categories
                if (window.TiageTaxonomie && window.TiageTaxonomie.kategorien) {
                    Object.values(window.TiageTaxonomie.kategorien).forEach(function(kat) {
                        suggestions.push({ type: 'category', id: kat.id, label: kat.label, description: kat.beschreibung, perspective: getPerspectiveForCategory(kat.key) });
                    });
                }
                // Show all dimensions
                if (window.TiageTaxonomie && window.TiageTaxonomie.dimensionen) {
                    Object.values(window.TiageTaxonomie.dimensionen).forEach(function(dim) {
                        suggestions.push({ type: 'dimension', id: dim.id, label: dim.label, description: dim.beschreibung, perspective: null });
                    });
                }
                // Show all resonance factors
                var resonanzfaktoren = {
                    'R1': { id: 'R1', label: 'Leben', icon: 'üî•', beschreibung: 'Orientierung - Existenz, Zuneigung, Mu√üe, Intimit√§t' },
                    'R2': { id: 'R2', label: 'Philosophie', icon: 'üß†', beschreibung: 'Archetyp - Lebensplanung, Werte, Finanzen' },
                    'R3': { id: 'R3', label: 'Dynamik', icon: '‚ö°', beschreibung: 'Dominanz - Machtdynamik, BDSM, Sicherheit' },
                    'R4': { id: 'R4', label: 'Identit√§t', icon: 'üíö', beschreibung: 'Geschlecht - Authentizit√§t, Kommunikation, Selbstausdruck' }
                };
                Object.values(resonanzfaktoren).forEach(function(r) {
                    suggestions.push({ type: 'resonanz', id: r.id, label: r.label, icon: r.icon, description: r.beschreibung, perspective: null });
                });
                // Show all perspectives
                if (window.TiageTaxonomie && window.TiageTaxonomie.perspektiven) {
                    Object.values(window.TiageTaxonomie.perspektiven).forEach(function(p) {
                        suggestions.push({ type: 'perspective', id: p.id, label: p.label, description: p.beschreibung, perspective: null });
                    });
                }
                return suggestions;
            }

            // Search in needs
            var needsSource = window.BeduerfnisKatalog?.beduerfnisse || (typeof BeduerfnisIds !== 'undefined' ? BeduerfnisIds.beduerfnisse : null);
            if (needsSource) {
                Object.values(needsSource).forEach(function(need) {
                    var matchScore = 0;
                    if (need.label && need.label.toLowerCase().includes(lowerQuery)) matchScore = 10;
                    if (need.id && need.id.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 8);
                    if (matchScore > 0) {
                        suggestions.push({ type: 'need', id: need.id, label: need.label, description: need.frage || '', perspective: getPerspectiveForNeed(need.id), score: matchScore });
                    }
                });
            }

            // Search in categories
            if (window.TiageTaxonomie && window.TiageTaxonomie.kategorien) {
                Object.values(window.TiageTaxonomie.kategorien).forEach(function(kat) {
                    var matchScore = 0;
                    if (kat.label && kat.label.toLowerCase().includes(lowerQuery)) matchScore = 9;
                    if (kat.beschreibung && kat.beschreibung.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 7);
                    if (kat.id && kat.id.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 8);
                    if (matchScore > 0) {
                        suggestions.push({ type: 'category', id: kat.id, label: kat.label, description: kat.beschreibung, perspective: getPerspectiveForCategory(kat.key), score: matchScore });
                    }
                });
            }

            // Search in dimensions
            if (window.TiageTaxonomie && window.TiageTaxonomie.dimensionen) {
                Object.values(window.TiageTaxonomie.dimensionen).forEach(function(dim) {
                    var matchScore = 0;
                    if (dim.label && dim.label.toLowerCase().includes(lowerQuery)) matchScore = 8;
                    if (dim.beschreibung && dim.beschreibung.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 6);
                    if (dim.id && dim.id.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 7);
                    if (matchScore > 0) {
                        suggestions.push({ type: 'dimension', id: dim.id, label: dim.label, description: dim.beschreibung, perspective: null, score: matchScore });
                    }
                });
            }

            // Search in resonance factors
            var resonanzfaktoren = {
                'R1': { id: 'R1', label: 'Leben', icon: 'üî•', beschreibung: 'Orientierung - Existenz, Zuneigung, Mu√üe, Intimit√§t' },
                'R2': { id: 'R2', label: 'Philosophie', icon: 'üß†', beschreibung: 'Archetyp - Lebensplanung, Werte, Finanzen' },
                'R3': { id: 'R3', label: 'Dynamik', icon: '‚ö°', beschreibung: 'Dominanz - Machtdynamik, BDSM, Sicherheit' },
                'R4': { id: 'R4', label: 'Identit√§t', icon: 'üíö', beschreibung: 'Geschlecht - Authentizit√§t, Kommunikation, Selbstausdruck' }
            };
            Object.values(resonanzfaktoren).forEach(function(r) {
                var matchScore = 0;
                if (r.label && r.label.toLowerCase().includes(lowerQuery)) matchScore = 8;
                if (r.beschreibung && r.beschreibung.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 6);
                if (r.id && r.id.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 7);
                if (matchScore > 0) {
                    suggestions.push({ type: 'resonanz', id: r.id, label: r.label, icon: r.icon, description: r.beschreibung, perspective: null, score: matchScore });
                }
            });

            suggestions.sort(function(a, b) { return (b.score || 0) - (a.score || 0); });
            return suggestions.slice(0, 15);
        }

        function renderSuggestionItem(suggestion, index) {
            var typeLabel = { 'need': 'Bed√ºrfnis', 'category': 'Kategorie', 'dimension': 'Dimension', 'resonanz': 'Resonanzfaktor', 'perspective': 'Perspektive' }[suggestion.type] || suggestion.type;
            var iconPrefix = suggestion.icon ? suggestion.icon + ' ' : '';
            var descriptionHTML = suggestion.description ? '<div class="suggestion-item-description">' + (suggestion.description.length > 120 ? suggestion.description.substring(0, 120) + '...' : suggestion.description) + '</div>' : '';
            return '<div class="suggestion-item' + (index === suggestionState.selectedIndex ? ' active' : '') + '" data-index="' + index + '" data-value="' + suggestion.label + '">' +
                '<div class="suggestion-item-header">' +
                '<span class="suggestion-item-type type-' + suggestion.type + '">' + typeLabel + '</span>' +
                '<span class="suggestion-item-label">' + iconPrefix + suggestion.label + '</span>' +
                '<span class="suggestion-item-id">' + suggestion.id + '</span>' +
                '</div>' + descriptionHTML + '</div>';
        }

        function displaySearchSuggestions(suggestions) {
            var dropdown = document.getElementById('searchSuggestionsDropdown');
            var content = dropdown ? dropdown.querySelector('.search-suggestions-content') : null;
            if (!dropdown || !content) return;

            suggestionState.suggestions = suggestions;
            suggestionState.selectedIndex = -1;

            if (suggestions.length === 0) {
                content.innerHTML = '<div class="search-suggestions-empty">Keine Vorschl√§ge gefunden</div>';
                dropdown.style.display = 'block';
                return;
            }

            var grouped = { 'need': [], 'category': [], 'dimension': [], 'resonanz': [], 'perspective': [] };
            suggestions.forEach(function(s, i) { if (grouped[s.type]) grouped[s.type].push({suggestion: s, index: i}); });

            var html = '';
            var order = ['need', 'category', 'dimension', 'resonanz', 'perspective'];
            var headers = { 'need': 'Bed√ºrfnisse', 'category': 'Kategorien', 'dimension': 'Dimensionen', 'resonanz': 'Resonanzfaktoren', 'perspective': 'Perspektiven' };
            order.forEach(function(type) {
                if (grouped[type].length > 0) {
                    html += '<div class="suggestion-section-header">' + headers[type] + '</div>';
                    grouped[type].forEach(function(item) { html += renderSuggestionItem(item.suggestion, item.index); });
                }
            });

            content.innerHTML = html;
            dropdown.style.display = 'block';
            content.querySelectorAll('.suggestion-item').forEach(function(item) {
                item.addEventListener('click', function() { selectSuggestion(parseInt(item.getAttribute('data-index'))); });
            });
        }

        function hideSearchSuggestions() {
            var dropdown = document.getElementById('searchSuggestionsDropdown');
            if (dropdown) dropdown.style.display = 'none';
            suggestionState.selectedIndex = -1;
        }
        window.hideSearchSuggestions = hideSearchSuggestions;

        function filterProfileReviewByNeed(query) {
            // Direkte Filterung der flat-need-item Elemente (SSOT: gleiche Logik wie app-main.js)
            var flatNeedItems = document.querySelectorAll('.flat-need-item');
            if (!flatNeedItems.length) return;

            // Wenn leer, alle anzeigen
            if (!query || !query.trim()) {
                flatNeedItems.forEach(function(item) {
                    item.classList.remove('filter-hidden', 'filter-match');
                });
                return;
            }

            var totalMatches = 0;
            var lowerQuery = query.trim().toLowerCase();

            flatNeedItems.forEach(function(item) {
                var needLabel = item.querySelector('.flat-need-label');
                var labelText = needLabel ? needLabel.textContent.toLowerCase() : '';
                var needId = (item.getAttribute('data-need') || '').toLowerCase();

                // Suche in Label und ID
                var matches = labelText.includes(lowerQuery) || needId.includes(lowerQuery);

                item.classList.toggle('filter-hidden', !matches);
                item.classList.toggle('filter-match', matches);

                if (matches) totalMatches++;
            });

            console.log('[Filter] needs-editor:', query, '- Matches:', totalMatches);
        }

        function handleIntelligentSearch(query) {
            filterProfileReviewByNeed(query);
            var suggestions = generateSearchSuggestions(query);
            displaySearchSuggestions(suggestions);
        }
        window.handleIntelligentSearch = handleIntelligentSearch;

        function showSearchSuggestions() {
            var input = document.getElementById('profileReviewSearchInput');
            if (!input) return;
            var suggestions = generateSearchSuggestions(input.value || '');
            displaySearchSuggestions(suggestions);
        }
        window.showSearchSuggestions = showSearchSuggestions;

        function selectSuggestion(index) {
            if (index < 0 || index >= suggestionState.suggestions.length) return;
            var suggestion = suggestionState.suggestions[index];
            var input = document.getElementById('profileReviewSearchInput');
            suggestionState.activeSuggestion = suggestion;

            if (input) {
                var parts = input.value.split(',');
                parts[parts.length - 1] = suggestion.label;
                input.value = parts.join(',');
                filterProfileReviewByNeed(input.value);
            }
            hideSearchSuggestions();
            displayActiveSuggestion();
        }

        function displayActiveSuggestion() {
            var hint = document.getElementById('profileReviewSearchHint');
            if (!hint) return;
            var suggestion = suggestionState.activeSuggestion;
            if (!suggestion) return;
            var typeLabel = { 'need': 'Bed√ºrfnis', 'category': 'Kategorie', 'dimension': 'Dimension', 'resonanz': 'Resonanzfaktor', 'perspective': 'Perspektive' }[suggestion.type] || suggestion.type;
            var iconPrefix = suggestion.icon ? suggestion.icon + ' ' : '';
            hint.innerHTML = '<span class="search-active-selection">' +
                '<span class="search-active-type type-' + suggestion.type + '">' + typeLabel + '</span>' +
                '<span class="search-active-label">' + iconPrefix + suggestion.label + '</span>' +
                '<span class="search-active-id">' + suggestion.id + '</span>' +
                '<button class="search-active-clear" onclick="clearActiveSuggestion()" title="Auswahl entfernen">√ó</button></span>';
            hint.classList.add('has-active-selection');
        }
        window.displayActiveSuggestion = displayActiveSuggestion;

        function clearActiveSuggestion() {
            suggestionState.activeSuggestion = null;
            var hint = document.getElementById('profileReviewSearchHint');
            if (hint) { hint.innerHTML = ''; hint.classList.remove('has-active-selection'); }
            var input = document.getElementById('profileReviewSearchInput');
            if (input && input.value) handleIntelligentSearch(input.value);
        }
        window.clearActiveSuggestion = clearActiveSuggestion;

        function handleSearchKeydown(event) {
            var dropdown = document.getElementById('searchSuggestionsDropdown');
            if (!dropdown || dropdown.style.display === 'none') return;
            var suggestions = suggestionState.suggestions;
            if (suggestions.length === 0) return;

            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    suggestionState.selectedIndex = Math.min(suggestionState.selectedIndex + 1, suggestions.length - 1);
                    updateSuggestionSelection();
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    suggestionState.selectedIndex = Math.max(suggestionState.selectedIndex - 1, -1);
                    updateSuggestionSelection();
                    break;
                case 'Enter':
                    event.preventDefault();
                    if (suggestionState.selectedIndex >= 0) selectSuggestion(suggestionState.selectedIndex);
                    break;
                case 'Escape':
                    event.preventDefault();
                    hideSearchSuggestions();
                    break;
            }
        }
        window.handleSearchKeydown = handleSearchKeydown;

        function updateSuggestionSelection() {
            var content = document.querySelector('.search-suggestions-content');
            if (!content) return;
            content.querySelectorAll('.suggestion-item').forEach(function(item, index) {
                if (index === suggestionState.selectedIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    item.classList.remove('active');
                }
            });
        }

        function clearProfileReviewSearch() {
            var input = document.getElementById('profileReviewSearchInput');
            if (input) input.value = '';
            filterProfileReviewByNeed('');
            hideSearchSuggestions();
            clearActiveSuggestion();
            // Update clear button visibility
            var wrapper = document.querySelector('.profile-review-search-wrapper');
            if (wrapper) wrapper.classList.remove('has-value');
        }
        window.clearProfileReviewSearch = clearProfileReviewSearch;

        // Close suggestions when clicking outside
        document.addEventListener('click', function(event) {
            var searchWrapper = document.querySelector('.profile-review-search-wrapper');
            var dropdown = document.getElementById('searchSuggestionsDropdown');
            if (searchWrapper && dropdown && !searchWrapper.contains(event.target) && !dropdown.contains(event.target)) {
                hideSearchSuggestions();
            }
        });

        // Update clear button visibility on input
        document.addEventListener('DOMContentLoaded', function() {
            var input = document.getElementById('profileReviewSearchInput');
            if (input) {
                input.addEventListener('input', function() {
                    var wrapper = document.querySelector('.profile-review-search-wrapper');
                    if (wrapper) wrapper.classList.toggle('has-value', this.value.length > 0);
                });
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INTELLIGENT SEARCH SUGGESTIONS (adapted from app-main.js)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        var suggestionState = {
            selectedIndex: -1,
            suggestions: [],
            activeSuggestion: null
        };

        function getPerspectiveForCategory(categoryKey) {
            if (window.PerspektivenModal && window.PerspektivenModal.kategoriePerspektiven) {
                var perspId = window.PerspektivenModal.kategoriePerspektiven[categoryKey];
                if (perspId && window.PerspektivenModal.perspektiven[perspId]) {
                    return window.PerspektivenModal.perspektiven[perspId];
                }
            }
            return null;
        }

        function getPerspectiveForNeed(needId) {
            if (!window.BeduerfnisKatalog || !window.BeduerfnisKatalog.beduerfnisse) return null;
            var need = window.BeduerfnisKatalog.beduerfnisse[needId];
            if (!need || !need.kategorie) return null;
            var categoryId = need.kategorie;
            if (!window.TiageTaxonomie || !window.TiageTaxonomie.kategorien) return null;
            var category = window.TiageTaxonomie.kategorien[categoryId];
            if (!category || !category.key) return null;
            return getPerspectiveForCategory(category.key);
        }

        function generateSearchSuggestions(query) {
            var suggestions = [];
            var parts = query.split(',');
            var lastPart = parts[parts.length - 1].trim();
            var lowerQuery = lastPart.toLowerCase();

            if (!lowerQuery) {
                // Show all categories
                if (window.TiageTaxonomie && window.TiageTaxonomie.kategorien) {
                    Object.values(window.TiageTaxonomie.kategorien).forEach(function(kat) {
                        suggestions.push({ type: 'category', id: kat.id, label: kat.label, description: kat.beschreibung, perspective: getPerspectiveForCategory(kat.key) });
                    });
                }
                // Show all dimensions
                if (window.TiageTaxonomie && window.TiageTaxonomie.dimensionen) {
                    Object.values(window.TiageTaxonomie.dimensionen).forEach(function(dim) {
                        suggestions.push({ type: 'dimension', id: dim.id, label: dim.label, description: dim.beschreibung, perspective: null });
                    });
                }
                // Show all resonance factors
                var resonanzfaktoren = {
                    'R1': { id: 'R1', label: 'Leben', icon: 'üî•', beschreibung: 'Orientierung - Existenz, Zuneigung, Mu√üe, Intimit√§t' },
                    'R2': { id: 'R2', label: 'Philosophie', icon: 'üß†', beschreibung: 'Archetyp - Lebensplanung, Werte, Finanzen' },
                    'R3': { id: 'R3', label: 'Dynamik', icon: '‚ö°', beschreibung: 'Dominanz - Machtdynamik, BDSM, Sicherheit' },
                    'R4': { id: 'R4', label: 'Identit√§t', icon: 'üíö', beschreibung: 'Geschlecht - Authentizit√§t, Kommunikation, Selbstausdruck' }
                };
                Object.values(resonanzfaktoren).forEach(function(r) {
                    suggestions.push({ type: 'resonanz', id: r.id, label: r.label, icon: r.icon, description: r.beschreibung, perspective: null });
                });
                // Show all perspectives
                if (window.TiageTaxonomie && window.TiageTaxonomie.perspektiven) {
                    Object.values(window.TiageTaxonomie.perspektiven).forEach(function(p) {
                        suggestions.push({ type: 'perspective', id: p.id, label: p.label, description: p.beschreibung, perspective: null });
                    });
                }
                return suggestions;
            }

            // Search in needs
            var needsSource = window.BeduerfnisKatalog?.beduerfnisse || (typeof BeduerfnisIds !== 'undefined' ? BeduerfnisIds.beduerfnisse : null);
            if (needsSource) {
                Object.values(needsSource).forEach(function(need) {
                    var matchScore = 0;
                    if (need.label && need.label.toLowerCase().includes(lowerQuery)) matchScore = 10;
                    if (need.id && need.id.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 8);
                    if (matchScore > 0) {
                        suggestions.push({ type: 'need', id: need.id, label: need.label, description: need.frage || '', perspective: getPerspectiveForNeed(need.id), score: matchScore });
                    }
                });
            }

            // Search in categories
            if (window.TiageTaxonomie && window.TiageTaxonomie.kategorien) {
                Object.values(window.TiageTaxonomie.kategorien).forEach(function(kat) {
                    var matchScore = 0;
                    if (kat.label && kat.label.toLowerCase().includes(lowerQuery)) matchScore = 9;
                    if (kat.beschreibung && kat.beschreibung.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 7);
                    if (kat.id && kat.id.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 8);
                    if (matchScore > 0) {
                        suggestions.push({ type: 'category', id: kat.id, label: kat.label, description: kat.beschreibung, perspective: getPerspectiveForCategory(kat.key), score: matchScore });
                    }
                });
            }

            // Search in dimensions
            if (window.TiageTaxonomie && window.TiageTaxonomie.dimensionen) {
                Object.values(window.TiageTaxonomie.dimensionen).forEach(function(dim) {
                    var matchScore = 0;
                    if (dim.label && dim.label.toLowerCase().includes(lowerQuery)) matchScore = 8;
                    if (dim.beschreibung && dim.beschreibung.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 6);
                    if (dim.id && dim.id.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 7);
                    if (matchScore > 0) {
                        suggestions.push({ type: 'dimension', id: dim.id, label: dim.label, description: dim.beschreibung, perspective: null, score: matchScore });
                    }
                });
            }

            // Search in resonance factors
            var resonanzfaktoren = {
                'R1': { id: 'R1', label: 'Leben', icon: 'üî•', beschreibung: 'Orientierung - Existenz, Zuneigung, Mu√üe, Intimit√§t' },
                'R2': { id: 'R2', label: 'Philosophie', icon: 'üß†', beschreibung: 'Archetyp - Lebensplanung, Werte, Finanzen' },
                'R3': { id: 'R3', label: 'Dynamik', icon: '‚ö°', beschreibung: 'Dominanz - Machtdynamik, BDSM, Sicherheit' },
                'R4': { id: 'R4', label: 'Identit√§t', icon: 'üíö', beschreibung: 'Geschlecht - Authentizit√§t, Kommunikation, Selbstausdruck' }
            };
            Object.values(resonanzfaktoren).forEach(function(r) {
                var matchScore = 0;
                if (r.label && r.label.toLowerCase().includes(lowerQuery)) matchScore = 8;
                if (r.beschreibung && r.beschreibung.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 6);
                if (r.id && r.id.toLowerCase().includes(lowerQuery)) matchScore = Math.max(matchScore, 7);
                if (matchScore > 0) {
                    suggestions.push({ type: 'resonanz', id: r.id, label: r.label, icon: r.icon, description: r.beschreibung, perspective: null, score: matchScore });
                }
            });

            suggestions.sort(function(a, b) { return (b.score || 0) - (a.score || 0); });
            return suggestions.slice(0, 15);
        }

        function renderSuggestionItem(suggestion, index) {
            var typeLabel = { 'need': 'Bed√ºrfnis', 'category': 'Kategorie', 'dimension': 'Dimension', 'resonanz': 'Resonanzfaktor', 'perspective': 'Perspektive' }[suggestion.type] || suggestion.type;
            var iconPrefix = suggestion.icon ? suggestion.icon + ' ' : '';
            var descriptionHTML = suggestion.description ? '<div class="suggestion-item-description">' + (suggestion.description.length > 120 ? suggestion.description.substring(0, 120) + '...' : suggestion.description) + '</div>' : '';
            return '<div class="suggestion-item' + (index === suggestionState.selectedIndex ? ' active' : '') + '" data-index="' + index + '" data-value="' + suggestion.label + '">' +
                '<div class="suggestion-item-header">' +
                '<span class="suggestion-item-type type-' + suggestion.type + '">' + typeLabel + '</span>' +
                '<span class="suggestion-item-label">' + iconPrefix + suggestion.label + '</span>' +
                '<span class="suggestion-item-id">' + suggestion.id + '</span>' +
                '</div>' + descriptionHTML + '</div>';
        }

        function displaySearchSuggestions(suggestions) {
            var dropdown = document.getElementById('searchSuggestionsDropdown');
            var content = dropdown ? dropdown.querySelector('.search-suggestions-content') : null;
            if (!dropdown || !content) return;

            suggestionState.suggestions = suggestions;
            suggestionState.selectedIndex = -1;

            if (suggestions.length === 0) {
                content.innerHTML = '<div class="search-suggestions-empty">Keine Vorschl√§ge gefunden</div>';
                dropdown.style.display = 'block';
                return;
            }

            var grouped = { 'need': [], 'category': [], 'dimension': [], 'resonanz': [], 'perspective': [] };
            suggestions.forEach(function(s, i) { if (grouped[s.type]) grouped[s.type].push({suggestion: s, index: i}); });

            var html = '';
            var order = ['need', 'category', 'dimension', 'resonanz', 'perspective'];
            var headers = { 'need': 'Bed√ºrfnisse', 'category': 'Kategorien', 'dimension': 'Dimensionen', 'resonanz': 'Resonanzfaktoren', 'perspective': 'Perspektiven' };
            order.forEach(function(type) {
                if (grouped[type].length > 0) {
                    html += '<div class="suggestion-section-header">' + headers[type] + '</div>';
                    grouped[type].forEach(function(item) { html += renderSuggestionItem(item.suggestion, item.index); });
                }
            });

            content.innerHTML = html;
            dropdown.style.display = 'block';
            content.querySelectorAll('.suggestion-item').forEach(function(item) {
                item.addEventListener('click', function() { selectSuggestion(parseInt(item.getAttribute('data-index'))); });
            });
        }

        function hideSearchSuggestions() {
            var dropdown = document.getElementById('searchSuggestionsDropdown');
            if (dropdown) dropdown.style.display = 'none';
            suggestionState.selectedIndex = -1;
        }
        window.hideSearchSuggestions = hideSearchSuggestions;

        function filterProfileReviewByNeed(query) {
            // Direkte Filterung der flat-need-item Elemente (SSOT: gleiche Logik wie app-main.js)
            var flatNeedItems = document.querySelectorAll('.flat-need-item');
            if (!flatNeedItems.length) return;

            // Wenn leer, alle anzeigen
            if (!query || !query.trim()) {
                flatNeedItems.forEach(function(item) {
                    item.classList.remove('filter-hidden', 'filter-match');
                });
                return;
            }

            var totalMatches = 0;
            var lowerQuery = query.trim().toLowerCase();

            flatNeedItems.forEach(function(item) {
                var needLabel = item.querySelector('.flat-need-label');
                var labelText = needLabel ? needLabel.textContent.toLowerCase() : '';
                var needId = (item.getAttribute('data-need') || '').toLowerCase();

                // Suche in Label und ID
                var matches = labelText.includes(lowerQuery) || needId.includes(lowerQuery);

                item.classList.toggle('filter-hidden', !matches);
                item.classList.toggle('filter-match', matches);

                if (matches) totalMatches++;
            });

            console.log('[Filter] needs-editor:', query, '- Matches:', totalMatches);
        }

        function handleIntelligentSearch(query) {
            filterProfileReviewByNeed(query);
            var suggestions = generateSearchSuggestions(query);
            displaySearchSuggestions(suggestions);
        }
        window.handleIntelligentSearch = handleIntelligentSearch;

        function showSearchSuggestions() {
            var input = document.getElementById('profileReviewSearchInput');
            if (!input) return;
            var suggestions = generateSearchSuggestions(input.value || '');
            displaySearchSuggestions(suggestions);
        }
        window.showSearchSuggestions = showSearchSuggestions;

        function selectSuggestion(index) {
            if (index < 0 || index >= suggestionState.suggestions.length) return;
            var suggestion = suggestionState.suggestions[index];
            var input = document.getElementById('profileReviewSearchInput');
            suggestionState.activeSuggestion = suggestion;

            if (input) {
                var parts = input.value.split(',');
                parts[parts.length - 1] = suggestion.label;
                input.value = parts.join(',');
                filterProfileReviewByNeed(input.value);
            }
            hideSearchSuggestions();
            displayActiveSuggestion();
        }

        function displayActiveSuggestion() {
            var hint = document.getElementById('profileReviewSearchHint');
            if (!hint) return;
            var suggestion = suggestionState.activeSuggestion;
            if (!suggestion) return;
            var typeLabel = { 'need': 'Bed√ºrfnis', 'category': 'Kategorie', 'dimension': 'Dimension', 'resonanz': 'Resonanzfaktor', 'perspective': 'Perspektive' }[suggestion.type] || suggestion.type;
            var iconPrefix = suggestion.icon ? suggestion.icon + ' ' : '';
            hint.innerHTML = '<span class="search-active-selection">' +
                '<span class="search-active-type type-' + suggestion.type + '">' + typeLabel + '</span>' +
                '<span class="search-active-label">' + iconPrefix + suggestion.label + '</span>' +
                '<span class="search-active-id">' + suggestion.id + '</span>' +
                '<button class="search-active-clear" onclick="clearActiveSuggestion()" title="Auswahl entfernen">√ó</button></span>';
            hint.classList.add('has-active-selection');
        }
        window.displayActiveSuggestion = displayActiveSuggestion;

        function clearActiveSuggestion() {
            suggestionState.activeSuggestion = null;
            var hint = document.getElementById('profileReviewSearchHint');
            if (hint) { hint.innerHTML = ''; hint.classList.remove('has-active-selection'); }
            var input = document.getElementById('profileReviewSearchInput');
            if (input && input.value) handleIntelligentSearch(input.value);
        }
        window.clearActiveSuggestion = clearActiveSuggestion;

        function handleSearchKeydown(event) {
            var dropdown = document.getElementById('searchSuggestionsDropdown');
            if (!dropdown || dropdown.style.display === 'none') return;
            var suggestions = suggestionState.suggestions;
            if (suggestions.length === 0) return;

            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    suggestionState.selectedIndex = Math.min(suggestionState.selectedIndex + 1, suggestions.length - 1);
                    updateSuggestionSelection();
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    suggestionState.selectedIndex = Math.max(suggestionState.selectedIndex - 1, -1);
                    updateSuggestionSelection();
                    break;
                case 'Enter':
                    event.preventDefault();
                    if (suggestionState.selectedIndex >= 0) selectSuggestion(suggestionState.selectedIndex);
                    break;
                case 'Escape':
                    event.preventDefault();
                    hideSearchSuggestions();
                    break;
            }
        }
        window.handleSearchKeydown = handleSearchKeydown;

        function updateSuggestionSelection() {
            var content = document.querySelector('.search-suggestions-content');
            if (!content) return;
            content.querySelectorAll('.suggestion-item').forEach(function(item, index) {
                if (index === suggestionState.selectedIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    item.classList.remove('active');
                }
            });
        }

        function clearProfileReviewSearch() {
            var input = document.getElementById('profileReviewSearchInput');
            if (input) input.value = '';
            filterProfileReviewByNeed('');
            hideSearchSuggestions();
            clearActiveSuggestion();
            // Update clear button visibility
            var wrapper = document.querySelector('.profile-review-search-wrapper');
            if (wrapper) wrapper.classList.remove('has-value');
        }
        window.clearProfileReviewSearch = clearProfileReviewSearch;

        // Close suggestions when clicking outside
        document.addEventListener('click', function(event) {
            var searchWrapper = document.querySelector('.profile-review-search-wrapper');
            var dropdown = document.getElementById('searchSuggestionsDropdown');
            if (searchWrapper && dropdown && !searchWrapper.contains(event.target) && !dropdown.contains(event.target)) {
                hideSearchSuggestions();
            }
        });

        // Update clear button visibility on input
        document.addEventListener('DOMContentLoaded', function() {
            var input = document.getElementById('profileReviewSearchInput');
            if (input) {
                input.addEventListener('input', function() {
                    var wrapper = document.querySelector('.profile-review-search-wrapper');
                    if (wrapper) wrapper.classList.toggle('has-value', this.value.length > 0);
                });
            }
        });
    </script>
</body>
</html>
