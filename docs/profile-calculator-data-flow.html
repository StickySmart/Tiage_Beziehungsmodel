<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfileCalculator Datenfluss-Dokumentation</title>
    <style>
        :root {
            --primary-color: #2A9D8F;
            --secondary-color: #E63946;
            --text-color: #264653;
            --bg-color: #ffffff;
            --code-bg: #f5f5f5;
            --border-color: #e0e0e0;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            max-width: 210mm;
            margin: 0 auto;
            padding: 20mm;
            background: var(--bg-color);
        }

        h1 {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            font-size: 28px;
        }

        h2 {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 8px;
            margin-top: 40px;
            font-size: 22px;
        }

        h3 {
            color: var(--text-color);
            margin-top: 30px;
            font-size: 18px;
        }

        .subtitle {
            color: #666;
            font-style: italic;
            margin-bottom: 30px;
        }

        pre {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        pre code {
            background: none;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            text-align: left;
        }

        th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background: #f9f9f9;
        }

        .diagram-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 20px;
            margin: 25px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
            line-height: 1.3;
            white-space: pre;
            overflow-x: auto;
        }

        .section-box {
            background: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .highlight {
            background: linear-gradient(to right, rgba(42, 157, 143, 0.1), transparent);
            padding: 2px 0;
        }

        hr {
            border: none;
            height: 2px;
            background: linear-gradient(to right, var(--primary-color), transparent);
            margin: 40px 0;
        }

        .footer {
            text-align: center;
            margin-top: 60px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            color: #666;
            font-size: 12px;
        }

        @media print {
            body {
                padding: 15mm;
            }
            .page-break {
                page-break-before: always;
            }
            pre, .diagram-box {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>

<h1>ProfileCalculator Datenfluss-Dokumentation</h1>
<p class="subtitle">Technische Dokumentation des Profil-Lade- und Berechnungsprozesses</p>

<h2>Übersicht</h2>
<p>Der <strong>ProfileCalculator</strong> ist das zentrale Modul für die Berechnung und Verwaltung von Profildaten. Diese Dokumentation beschreibt den vollständigen Datenfluss vom Laden eines Profils bis zur UI-Aktualisierung.</p>

<hr>

<h2>Architektur-Diagramm</h2>

<div class="diagram-box">┌─────────────────────────────────────────────────────────────────────────────┐
│                           DATENFLUSS-ÜBERSICHT                               │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────┐
    │   Storage Data   │ (localStorage / Memory Slot)
    │   - archetyp     │
    │   - geschlecht   │
    │   - dominanz     │
    │   - orientierung │
    │   - gewichtungen │
    │   - resonanzfaktoren │
    └────────┬─────────┘
             │
             ▼
┌────────────────────────────────────────────────────────────────────────────┐
│  SCHRITT 1: ProfileCalculator.loadProfile('ich', data)                      │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐        │
│   │ calculateFlat   │    │ Default-        │    │ calculateReso-  │        │
│   │ Needs()         │    │ Gewichtungen    │    │ nanzFaktoren()  │        │
│   └────────┬────────┘    └────────┬────────┘    └────────┬────────┘        │
│            │                      │                      │                  │
│            ▼                      ▼                      ▼                  │
│   ┌─────────────────────────────────────────────────────────────┐          │
│   │              LoadedArchetypProfile.ich                       │          │
│   │  {                                                           │          │
│   │    archetyp: 'single',                                       │          │
│   │    profileReview: { flatNeeds: {...} },    ← 220 Bedürfnisse │          │
│   │    gewichtungen: { O, A, D, G },           ← Faktor-Gewichte │          │
│   │    resonanzFaktoren: { R1, R2, R3, R4 }    ← Resonanzwerte   │          │
│   │  }                                                           │          │
│   └─────────────────────────────────────────────────────────────┘          │
└────────────────────────────────────────────────────────────────────────────┘
             │
             ▼
┌────────────────────────────────────────────────────────────────────────────┐
│  SCHRITT 2: MemoryManager holt berechnete Werte                             │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   const loadedProfile = LoadedArchetypProfile.ich;                          │
│                                                                              │
│   gewichtungen = data.gewichtungen || loadedProfile.gewichtungen;           │
│   resonanzFaktoren = data.resonanzfaktoren || loadedProfile.resonanzFaktoren;│
└────────────────────────────────────────────────────────────────────────────┘
             │
             ▼
┌────────────────────────────────────────────────────────────────────────────┐
│  SCHRITT 3: UI-Aktualisierung                                               │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   applyGewichtungen(gewichtungen, 'ich')                                    │
│   → Speichert in: tiage_faktor_gewichtungen_ich                              │
│                                                                              │
│   applyResonanzfaktoren(resonanzFaktoren, 'ich')                            │
│   → Speichert in: tiage_resonanz_faktoren_ich                                │
│                                                                              │
│   ResonanzCard.setCalculatedValues(resonanzValues, false)                   │
│   → Aktualisiert Slider-UI (R1-R4)                                          │
└────────────────────────────────────────────────────────────────────────────┘</div>

<div class="page-break"></div>

<h2>Detaillierte Funktionsbeschreibungen</h2>

<h3>1. ProfileCalculator.loadProfile(person, storageData)</h3>

<div class="section-box">
<strong>Datei:</strong> <code>profiles/archetypen/index.js</code><br>
<strong>Zeilen:</strong> 286-303<br>
<strong>Zweck:</strong> Lädt und berechnet ein vollständiges Profil aus Storage-Daten.
</div>

<pre><code>function loadProfile(person, storageData) {
    // person: 'ich' oder 'partner'
    // storageData: Objekt mit archetyp, geschlecht, dominanz, orientierung

    const calculatedProfile = calculateProfile(storageData);
    window.LoadedArchetypProfile[person] = calculatedProfile;

    return true;
}</code></pre>

<h4>Eingabe-Parameter:</h4>
<table>
    <tr><th>Parameter</th><th>Typ</th><th>Beschreibung</th></tr>
    <tr><td><code>person</code></td><td><code>string</code></td><td><code>'ich'</code> oder <code>'partner'</code></td></tr>
    <tr><td><code>storageData</code></td><td><code>Object</code></td><td>Profildaten aus Storage</td></tr>
</table>

<h4>storageData Struktur:</h4>
<pre><code>{
    archetyp: 'single',           // Archetyp-Key
    geschlecht: {                 // Geschlechts-Dimension
        primary: 'mann',
        secondary: 'cis'
    },
    dominanz: {                   // Dominanz-Dimension
        primary: 'switch',
        secondary: null
    },
    orientierung: {               // Orientierungs-Dimension
        primary: 'hetero',
        secondary: null
    },
    gewichtungen: {...},          // Optional: Gespeicherte Gewichtungen
    resonanzfaktoren: {...}       // Optional: Gespeicherte Resonanzfaktoren
}</code></pre>

<hr>

<h3>2. calculateFlatNeeds(archetyp, geschlecht, dominanz, orientierung)</h3>

<div class="section-box">
<strong>Datei:</strong> <code>profiles/archetypen/index.js</code><br>
<strong>Zeilen:</strong> 158-192<br>
<strong>Zweck:</strong> Berechnet die 220 flatNeeds-Werte aus Basis-Profil + Modifier.
</div>

<pre><code>function calculateFlatNeeds(archetyp, geschlecht, dominanz, orientierung) {
    // 1. Basis-Bedürfnisse aus BaseArchetypProfile
    const baseProfil = window.BaseArchetypProfile[archetyp];
    const flatNeeds = { ...baseProfil.beduerfnisse };

    // 2. Modifier berechnen und anwenden
    const profileContext = {
        geschlecht: geschlecht,
        dominanz: dominanz?.primary || dominanz,
        orientierung: orientierung?.primary || orientierung
    };

    const deltas = ProfileModifiers.calculateProfileDeltas(profileContext);

    // 3. Deltas anwenden (0-100 begrenzt)
    Object.keys(deltas).forEach(key => {
        flatNeeds[key] = Math.min(100, Math.max(0, flatNeeds[key] + deltas[key]));
    });

    return flatNeeds;
}</code></pre>

<h4>Berechnungsformel:</h4>
<pre><code>flatNeed[i] = BaseArchetypProfile[archetyp].beduerfnisse[i]
            + GenderModifier[i]
            + DominanzModifier[i]
            + OrientierungModifier[i]

Begrenzt auf: 0 ≤ flatNeed[i] ≤ 100</code></pre>

<div class="page-break"></div>

<h3>3. calculateResonanzFaktoren(profileContext)</h3>

<div class="section-box">
<strong>Datei:</strong> <code>profiles/archetypen/index.js</code><br>
<strong>Zeilen:</strong> 200-231<br>
<strong>Zweck:</strong> Berechnet die Resonanzfaktoren R1-R4 aus dem Profil-Kontext.
</div>

<pre><code>function calculateResonanzFaktoren(profileContext) {
    // Prüfe ob TiageSynthesis verfügbar
    if (!TiageSynthesis?.NeedsIntegration?.calculateDimensionalResonance) {
        return getDefaultResonanzFaktoren();
    }

    // Berechne dimensionale Resonanzen
    const resonanz = TiageSynthesis.NeedsIntegration
        .calculateDimensionalResonance(profileContext);

    // Mapping: R1=leben, R2=philosophie, R3=dynamik, R4=identitaet
    return {
        R1: { value: resonanz.leben || 1.0, locked: false },
        R2: { value: resonanz.philosophie || 1.0, locked: false },
        R3: { value: resonanz.dynamik || 1.0, locked: false },
        R4: { value: resonanz.identitaet || 1.0, locked: false }
    };
}</code></pre>

<h4>Resonanzfaktoren-Mapping:</h4>
<table>
    <tr><th>Faktor</th><th>Dimension</th><th>Beschreibung</th><th>Wertebereich</th></tr>
    <tr><td>R1</td><td>Leben</td><td>Existenz, Zuneigung, Muße</td><td>0.5 - 1.5</td></tr>
    <tr><td>R2</td><td>Philosophie</td><td>Freiheit, Teilnahme, Identität</td><td>0.5 - 1.5</td></tr>
    <tr><td>R3</td><td>Dynamik</td><td>Dominanz, Sicherheit</td><td>0.5 - 1.5</td></tr>
    <tr><td>R4</td><td>Identität</td><td>Verständnis, Erschaffen, Verbundenheit</td><td>0.5 - 1.5</td></tr>
</table>

<hr>

<h3>4. MemoryManager.applyMeData(data)</h3>

<div class="section-box">
<strong>Datei:</strong> <code>js/memory-manager.js</code><br>
<strong>Zeilen:</strong> 646-756<br>
<strong>Zweck:</strong> Wendet geladene Daten auf das ICH-Profil an und aktualisiert die UI.
</div>

<pre><code>function applyMeData(data) {
    // 1. Profil berechnen und in LoadedArchetypProfile laden
    ProfileCalculator.loadProfile('ich', data);

    // 2. TiageState aktualisieren
    TiageState.set('personDimensions.ich.geschlecht', data.geschlecht);
    TiageState.set('personDimensions.ich.dominanz', data.dominanz);
    TiageState.set('personDimensions.ich.orientierung', data.orientierung);

    // 3. Berechnete Werte aus LoadedArchetypProfile holen
    const loadedProfile = window.LoadedArchetypProfile?.ich;

    // Priorisierung: Storage > Berechnet
    const gewichtungen = data.gewichtungen || loadedProfile?.gewichtungen;
    const resonanzFaktoren = data.resonanzfaktoren || loadedProfile?.resonanzFaktoren;

    // 4. UI aktualisieren
    applyGewichtungen(gewichtungen, 'ich');
    applyResonanzfaktoren(resonanzFaktoren, 'ich');

    // 5. ResonanzCard UI aktualisieren
    ResonanzCard.setCalculatedValues({
        R1: resonanzFaktoren.R1?.value || 1.0,
        R2: resonanzFaktoren.R2?.value || 1.0,
        R3: resonanzFaktoren.R3?.value || 1.0,
        R4: resonanzFaktoren.R4?.value || 1.0
    }, false);

    return true;
}</code></pre>

<div class="page-break"></div>

<h2>Datenstrukturen</h2>

<h3>LoadedArchetypProfile</h3>

<div class="section-box">
<strong>Speicherort:</strong> <code>window.LoadedArchetypProfile</code>
</div>

<pre><code>{
    ich: {
        archetyp: 'single',
        geschlecht: { primary: 'mann', secondary: 'cis' },
        dominanz: { primary: 'switch', secondary: null },
        orientierung: { primary: 'hetero', secondary: null },
        profileReview: {
            flatNeeds: {
                '#B1': 75,    // 220 Bedürfnisse
                '#B2': 60,
                // ...
            }
        },
        gewichtungen: {
            O: { value: 25, locked: false },  // Orientierung
            A: { value: 25, locked: false },  // Archetyp
            D: { value: 25, locked: false },  // Dominanz
            G: { value: 25, locked: false }   // Geschlecht
        },
        resonanzFaktoren: {
            R1: { value: 1.0, locked: false },
            R2: { value: 1.0, locked: false },
            R3: { value: 1.0, locked: false },
            R4: { value: 1.0, locked: false }
        }
    },
    partner: { ... }  // Gleiche Struktur
}</code></pre>

<h3>LocalStorage Keys</h3>
<table>
    <tr><th>Key</th><th>Beschreibung</th></tr>
    <tr><td><code>tiage_faktor_gewichtungen_ich</code></td><td>Gewichtungen für ICH</td></tr>
    <tr><td><code>tiage_faktor_gewichtungen_partner</code></td><td>Gewichtungen für Partner</td></tr>
    <tr><td><code>tiage_resonanz_faktoren_ich</code></td><td>Resonanzfaktoren für ICH</td></tr>
    <tr><td><code>tiage_resonanz_faktoren_partner</code></td><td>Resonanzfaktoren für Partner</td></tr>
    <tr><td><code>tiage_memory_ME001</code> - <code>ME004</code></td><td>Memory-Slots für ICH</td></tr>
    <tr><td><code>tiage_memory_PART001</code> - <code>PART004</code></td><td>Memory-Slots für Partner</td></tr>
</table>

<hr>

<h2>Sequenzdiagramm</h2>

<div class="diagram-box">┌─────────┐     ┌──────────────────┐     ┌─────────────────────┐     ┌───────────┐
│  User   │     │  MemoryManager   │     │  ProfileCalculator  │     │    UI     │
└────┬────┘     └────────┬─────────┘     └──────────┬──────────┘     └─────┬─────┘
     │                   │                          │                      │
     │  loadMeFromSlot() │                          │                      │
     │──────────────────>│                          │                      │
     │                   │                          │                      │
     │                   │  loadProfile('ich', data)│                      │
     │                   │─────────────────────────>│                      │
     │                   │                          │                      │
     │                   │                          │  calculateFlatNeeds()│
     │                   │                          │──────────┐           │
     │                   │                          │<─────────┘           │
     │                   │                          │                      │
     │                   │                          │  calculateResonanz() │
     │                   │                          │──────────┐           │
     │                   │                          │<─────────┘           │
     │                   │                          │                      │
     │                   │  LoadedArchetypProfile   │                      │
     │                   │<─────────────────────────│                      │
     │                   │                          │                      │
     │                   │  applyGewichtungen()                            │
     │                   │────────────────────────────────────────────────>│
     │                   │                                                 │
     │                   │  applyResonanzfaktoren()                        │
     │                   │────────────────────────────────────────────────>│
     │                   │                                                 │
     │                   │  ResonanzCard.setCalculatedValues()             │
     │                   │────────────────────────────────────────────────>│
     │                   │                          │                      │
     │  success          │                          │                      │
     │<──────────────────│                          │                      │</div>

<div class="page-break"></div>

<h2>Abhängigkeiten</h2>

<h3>Erforderliche Module</h3>
<div class="diagram-box">ProfileCalculator ──────────┬──────> BaseArchetypProfile
                            │
                            ├──────> ProfileModifiers
                            │
                            └──────> TiageSynthesis.NeedsIntegration

MemoryManager ──────────────┬──────> ProfileCalculator
                            │
                            ├──────> TiageState
                            │
                            ├──────> AttributeSummaryCard
                            │
                            └──────> ResonanzCard</div>

<h3>Ladeketten</h3>
<div class="diagram-box">1. BaseArchetypProfile (Basis-Definitionen)
   ↓
2. ProfileModifiers (Modifier-Definitionen)
   ↓
3. TiageSynthesis (Berechnungslogik)
   ↓
4. ProfileCalculator (Haupt-Orchestrator)
   ↓
5. MemoryManager (Storage + UI-Bridge)
   ↓
6. ResonanzCard / AttributeSummaryCard (UI-Komponenten)</div>

<hr>

<h2>Fehlerbehandlung</h2>

<h3>Fallback-Werte</h3>
<table>
    <tr><th>Komponente</th><th>Fallback</th></tr>
    <tr><td>flatNeeds</td><td>Leeres Objekt <code>{}</code></td></tr>
    <tr><td>gewichtungen</td><td><code>{ O: 25, A: 25, D: 25, G: 25 }</code></td></tr>
    <tr><td>resonanzFaktoren</td><td><code>{ R1: 1.0, R2: 1.0, R3: 1.0, R4: 1.0 }</code></td></tr>
</table>

<h3>Validierung</h3>
<ul>
    <li>Archetyp-Key muss in <code>BaseArchetypProfile</code> existieren</li>
    <li>flatNeeds-Werte werden auf 0-100 begrenzt</li>
    <li>Resonanzfaktoren werden auf 0.5-1.5 begrenzt</li>
</ul>

<hr>

<h2>Verwandte Dokumentation</h2>
<ul>
    <li><a href="README.md">README.md</a> - Hauptdokumentation</li>
    <li><a href="theory/resonance.md">theory/resonance.md</a> - Resonanz-Theorie</li>
    <li><a href="theory/factors.md">theory/factors.md</a> - Die 4 Qualitätsfaktoren</li>
    <li><a href="NAMING_CONVENTION.md">NAMING_CONVENTION.md</a> - ID-Referenzsystem</li>
</ul>

<div class="footer">
    <p>&copy; 2025 Ti-Age – Alle Rechte vorbehalten</p>
    <p><em>Diese HTML-Datei kann über den Browser als PDF gedruckt werden (Strg+P / Cmd+P)</em></p>
</div>

</body>
</html>
