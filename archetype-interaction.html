<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Archetypen-Kompatibilität | Swipe</title>
    <style>
        :root {
            --primary: #457B9D;
            --primary-light: #A8D5E2;
            --bg-dark: #0f0f1a;
            --bg-card: #1a1a2e;
            --bg-hover: #252542;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0b0;
            --text-muted: #6a6a7a;
            --border: rgba(255,255,255,0.1);
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;

            /* Responsive Typography with clamp() */
            --font-xs: clamp(0.7rem, 1vw + 0.4rem, 0.85rem);
            --font-sm: clamp(0.8rem, 1.2vw + 0.45rem, 0.95rem);
            --font-base: clamp(0.9rem, 1.5vw + 0.5rem, 1.1rem);
            --font-md: clamp(1rem, 1.8vw + 0.5rem, 1.25rem);
            --font-lg: clamp(1.2rem, 2.5vw + 0.5rem, 1.6rem);
            --font-xl: clamp(1.5rem, 3vw + 0.5rem, 2.2rem);
            --font-label: clamp(0.75rem, 1vw + 0.4rem, 0.9rem);

            /* Responsive Bar Height */
            --bar-height: clamp(16px, 1.5vw + 12px, 22px);
            --bar-radius: calc(var(--bar-height) / 2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* Theme Colors */
        body.theme-single { --primary: #E63946; --primary-light: #FFB4A2; }
        body.theme-duo { --primary: #E84393; --primary-light: #FDA7DF; }
        body.theme-duo_flex { --primary: #FF6B6B; --primary-light: #FFA5A5; }
        body.theme-solopoly { --primary: #2A9D8F; --primary-light: #A8DADC; }
        body.theme-poly_hedo { --primary: #9B5DE5; --primary-light: #D4A5FF; }
        body.theme-polyamor { --primary: #F4A261; --primary-light: #FFE5B4; }

        /* Header */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            text-align: center;
            padding: 12px 15px;
            background: rgba(15,15,26,0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
        }

        h1 {
            font-size: var(--font-base);
            font-weight: 400;
            letter-spacing: 2px;
            color: var(--text-secondary);
        }

        /* Carousel Container */
        .carousel-container {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding-top: 60px;
            height: 100vh;
        }

        .carousel-container::-webkit-scrollbar {
            display: none;
        }

        /* Cards */
        .card {
            flex: 0 0 100vw;
            width: 100vw;
            scroll-snap-align: start;
            padding: 15px;
            overflow-y: auto;
            height: calc(100vh - 60px);
        }

        .card-inner {
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border);
            min-height: 100%;
            overflow: hidden;
        }

        .card-header {
            padding: 18px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: var(--font-sm);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
        }

        .card-body {
            padding: 20px;
        }

        /* Navigation Dots */
        .nav-dots {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
            background: rgba(26,26,46,0.9);
            padding: 10px 20px;
            border-radius: 25px;
            border: 1px solid var(--border);
        }

        .nav-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-dot.active {
            background: var(--primary);
            transform: scale(1.3);
        }

        .nav-dot-label {
            display: none;
        }

        .nav-arrow {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 1.4rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            padding: 0;
            line-height: 1;
        }

        .nav-arrow:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .nav-arrow:active {
            transform: scale(0.95);
        }

        .nav-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .nav-arrow:disabled:hover {
            background: transparent;
            border-color: var(--border);
            color: var(--text-secondary);
        }

        /* Main Select in Card 1 */
        .main-select {
            margin-bottom: 20px;
        }

        .main-select-label {
            font-size: var(--font-base);
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }

        #archetypeSelect {
            width: 100%;
            appearance: none;
            background: var(--bg-dark);
            border: 2px solid var(--primary);
            color: var(--text-primary);
            padding: 14px 45px 14px 18px;
            font-size: var(--font-md);
            border-radius: 12px;
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a0a0b0' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
        }

        /* My Type Display */
        .my-type-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .my-type-icon {
            width: 55px;
            height: 55px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            background: var(--primary);
        }

        .my-type-name {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--primary);
        }

        .my-type-desc {
            color: var(--text-secondary);
            font-size: var(--font-base);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* Collapsible Sections */
        .collapsible {
            border-top: 1px solid var(--border);
        }

        .collapsible-header {
            padding: 14px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: var(--font-base);
        }

        .collapsible-icon {
            transition: transform 0.3s ease;
            font-size: 0.8rem;
        }

        .collapsible.open .collapsible-icon {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible.open .collapsible-content {
            max-height: 600px;
        }

        .pro-contra-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            padding-bottom: 15px;
        }

        .mini-list {
            font-size: var(--font-base);
        }

        .mini-list-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: var(--font-base);
        }

        .mini-list-title.pro { color: var(--success); }
        .mini-list-title.contra { color: var(--danger); }

        .mini-list ul {
            list-style: none;
            color: var(--text-muted);
        }

        .mini-list li {
            padding: 3px 0;
            padding-left: 14px;
            position: relative;
        }

        .mini-list li::before {
            content: '•';
            position: absolute;
            left: 0;
        }

        .pathos-logos-content {
            font-size: var(--font-base);
            color: var(--text-muted);
            padding-bottom: 15px;
        }

        .pathos-logos-content p {
            margin-bottom: 10px;
            font-style: italic;
            line-height: 1.5;
        }

        /* Match Cards */
        .match-section {
            margin-top: 20px;
        }

        .match-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .match-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .match-card:active {
            transform: translateY(0);
        }

        .match-card.top {
            background: rgba(0,206,201,0.1);
            border: 1px solid rgba(0,206,201,0.3);
        }

        .match-card.challenge {
            background: rgba(231,76,60,0.1);
            border: 1px solid rgba(231,76,60,0.3);
        }

        .match-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .match-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .match-label-text {
            font-size: var(--font-xs);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .match-name {
            font-size: var(--font-base);
            font-weight: 500;
        }

        .match-score {
            font-size: var(--font-md);
            font-weight: 700;
        }

        .match-score.excellent { color: #00cec9; }
        .match-score.low { color: #e74c3c; }

        /* Card 2: Partner Selector */
        .partner-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .partner-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 12px 16px;
            border: 2px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 20px;
            cursor: pointer;
            font-size: var(--font-base);
            transition: all 0.3s ease;
        }

        .partner-btn:hover {
            border-color: var(--text-muted);
            background: var(--bg-hover);
        }

        .partner-btn.active {
            border-color: var(--primary);
            background: rgba(69,123,157,0.2);
            color: var(--text-primary);
        }

        .partner-btn .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Radar Chart */
        .radar-section {
            margin-bottom: 25px;
        }

        .radar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .radar-title {
            font-size: var(--font-base);
            color: var(--text-secondary);
        }

        .radar-score {
            font-size: var(--font-xl);
            font-weight: 700;
        }

        .radar-score-label {
            font-size: var(--font-xs);
            color: var(--text-muted);
            text-transform: uppercase;
        }

        #radarChart {
            width: 100%;
            max-width: 280px;
            margin: 0 auto;
            display: block;
        }

        /* Category Bars */
        .category-section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: var(--font-sm);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .category-label {
            width: clamp(20px, 3vw + 10px, 28px);
            font-weight: 700;
            font-size: var(--font-sm);
            color: var(--primary);
        }

        .category-bar-wrap {
            flex: 1;
        }

        .category-bar-container {
            height: var(--bar-height);
            background: rgba(255,255,255,0.05);
            border-radius: var(--bar-radius);
            overflow: hidden;
        }

        .category-bar {
            height: 100%;
            border-radius: var(--bar-radius);
            transition: width 0.6s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
        }

        .category-bar-value {
            font-size: var(--font-xs);
            font-weight: 600;
            color: white;
        }

        .category-name {
            font-size: var(--font-sm);
            color: var(--text-muted);
            margin-top: 2px;
        }

        .bar-excellent { background: linear-gradient(90deg, #00cec9, #0984e3); }
        .bar-good { background: linear-gradient(90deg, #27ae60, #1e8449); }
        .bar-medium { background: linear-gradient(90deg, #f39c12, #d68910); }
        .bar-low { background: linear-gradient(90deg, #e74c3c, #c0392b); }

        /* Pro/Contra Analysis */
        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .analysis-section {
            padding: 14px;
            border-radius: 10px;
        }

        .analysis-section.pro {
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .analysis-section.contra {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .analysis-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: var(--font-base);
        }

        .analysis-section.pro .analysis-title { color: var(--success); }
        .analysis-section.contra .analysis-title { color: var(--danger); }

        .analysis-list {
            list-style: none;
            font-size: var(--font-base);
            color: var(--text-secondary);
        }

        .analysis-list li {
            padding: 3px 0;
            padding-left: 14px;
            position: relative;
        }

        .analysis-list li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 9px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }

        .analysis-section.pro .analysis-list li::before { background: var(--success); }
        .analysis-section.contra .analysis-list li::before { background: var(--danger); }

        /* Card 3: Alle Typen - Mini Cards Grid */
        .mini-cards-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .mini-card {
            background: var(--bg-dark);
            border-radius: 14px;
            padding: 14px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .mini-card:hover {
            border-color: var(--text-muted);
        }

        .mini-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .mini-card-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .mini-card-name {
            font-size: var(--font-base);
            font-weight: 600;
        }

        .mini-card-desc {
            font-size: var(--font-sm);
            color: var(--text-muted);
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .mini-card-self-score {
            font-size: var(--font-sm);
            color: var(--text-secondary);
        }

        .mini-card-self-score span {
            font-weight: 700;
            color: var(--primary);
        }

        /* Swipe Hint */
        .swipe-hint {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: var(--text-muted);
            opacity: 0.7;
            animation: fadeOut 3s forwards;
            animation-delay: 2s;
        }

        @keyframes fadeOut {
            to { opacity: 0; }
        }

        /* Info Icon */
        .section-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .info-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .info-icon:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Clickable Category Row */
        .category-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            padding: 4px;
            margin: -4px;
            margin-bottom: 6px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .category-row:hover {
            background: rgba(255,255,255,0.05);
        }

        .category-row:active {
            background: rgba(255,255,255,0.1);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border);
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 18px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 1;
        }

        .modal-title {
            font-size: var(--font-md);
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-feedback-btn {
            margin-top: 20px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .modal-feedback-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--primary);
            border-color: var(--primary);
        }

        .category-nav-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 8px;
            background: var(--bg-dark);
            border-radius: 10px;
        }

        .category-nav-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: var(--font-sm);
        }

        .category-nav-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .category-nav-indicator {
            color: var(--text-muted);
            font-size: var(--font-sm);
        }

        /* Definition Modal */
        .definition-modal {
            max-width: 500px;
        }

        .definition-section {
            margin-bottom: 20px;
        }

        .definition-section-title {
            font-size: var(--font-sm);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border);
        }

        .definition-long {
            font-size: var(--font-base);
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .definition-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .definition-list li {
            padding: 8px 0 8px 20px;
            position: relative;
            font-size: var(--font-sm);
            color: var(--text-secondary);
        }

        .definition-list.principles li::before {
            content: '✓';
            position: absolute;
            left: 0;
            color: var(--success);
        }

        .definition-list.not-same li::before {
            content: '✗';
            position: absolute;
            left: 0;
            color: var(--danger);
        }

        .definition-list.variants li::before {
            content: '•';
            position: absolute;
            left: 0;
            color: var(--primary);
        }

        .type-info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s;
        }

        .type-info-icon:hover {
            background: var(--primary);
            color: white;
        }

        .type-tooltip {
            position: relative;
            display: inline-block;
        }

        .type-tooltip .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: var(--bg-dark);
            color: var(--text-secondary);
            text-align: left;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: var(--font-sm);
            line-height: 1.4;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .type-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .modal-category {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-category:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .modal-category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .modal-category-letter {
            width: clamp(24px, 3vw + 14px, 32px);
            height: clamp(24px, 3vw + 14px, 32px);
            border-radius: 8px;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: var(--font-sm);
        }

        .modal-category-name {
            font-weight: 600;
            font-size: var(--font-base);
            color: var(--text-primary);
        }

        .modal-category-desc {
            font-size: var(--font-base);
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .modal-subdimensions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .modal-subdim-tag {
            font-size: var(--font-sm);
            padding: 6px 10px;
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            color: var(--text-secondary);
        }

        /* Match Modal Content */
        .match-modal-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .match-modal-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .match-modal-info h3 {
            font-size: var(--font-lg);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .match-modal-info p {
            font-size: var(--font-sm);
            color: var(--text-muted);
        }

        .match-modal-score {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--bg-dark);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .match-modal-score-label {
            font-size: var(--font-sm);
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .match-modal-score-value {
            font-size: var(--font-xl);
            font-weight: 700;
        }

        .match-modal-categories {
            margin-bottom: 20px;
        }

        .match-modal-categories-title {
            font-size: var(--font-sm);
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .match-modal-bar-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .match-modal-bar-row.clickable {
            cursor: pointer;
            padding: 6px;
            margin: -6px;
            margin-bottom: 2px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .match-modal-bar-row.clickable:hover {
            background: rgba(255,255,255,0.08);
        }

        .match-modal-bar-row.clickable:active {
            background: rgba(255,255,255,0.12);
        }

        .match-modal-bar-label {
            width: 24px;
            font-weight: 700;
            font-size: var(--font-sm);
            color: var(--primary);
        }

        .match-modal-bar-container {
            flex: 1;
            height: var(--bar-height);
            background: rgba(255,255,255,0.05);
            border-radius: var(--bar-radius);
            overflow: hidden;
        }

        .match-modal-bar {
            height: 100%;
            border-radius: var(--bar-radius);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
        }

        .match-modal-bar-value {
            font-size: var(--font-xs);
            font-weight: 600;
            color: white;
        }

        .match-modal-bar-name {
            width: 120px;
            font-size: var(--font-xs);
            color: var(--text-muted);
            text-align: right;
        }

        .match-modal-section {
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .match-modal-section.pro {
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .match-modal-section.contra {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .match-modal-section-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: var(--font-base);
        }

        .match-modal-section.pro .match-modal-section-title { color: var(--success); }
        .match-modal-section.contra .match-modal-section-title { color: var(--danger); }

        .match-modal-list {
            list-style: none;
            font-size: var(--font-sm);
            color: var(--text-secondary);
        }

        .match-modal-list li {
            padding: 3px 0;
            padding-left: 14px;
            position: relative;
        }

        .match-modal-list li::before {
            content: '•';
            position: absolute;
            left: 0;
        }

        /* Legend Page */
        .legend-section {
            margin-bottom: 25px;
        }

        .legend-title {
            font-size: var(--font-sm);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .color-scale {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .color-scale-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .color-scale-bar {
            width: clamp(50px, 8vw + 20px, 80px);
            height: var(--bar-height);
            border-radius: var(--bar-radius);
        }

        .color-scale-label {
            font-size: var(--font-base);
            color: var(--text-secondary);
        }

        .color-scale-range {
            font-size: var(--font-sm);
            color: var(--text-muted);
            margin-left: auto;
        }

        .legend-category-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .legend-category-item:hover {
            background: var(--bg-hover);
        }

        .legend-category-letter {
            width: clamp(28px, 4vw + 16px, 36px);
            height: clamp(28px, 4vw + 16px, 36px);
            border-radius: 8px;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: var(--font-base);
            flex-shrink: 0;
        }

        .legend-category-content {
            flex: 1;
        }

        .legend-category-name {
            font-weight: 600;
            font-size: var(--font-md);
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .legend-category-desc {
            font-size: var(--font-base);
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* Responsive - Mobile (larger fonts for readability) */
        @media (max-width: 599px) {
            :root {
                --font-xs: 0.85rem;
                --font-sm: 0.95rem;
                --font-base: 1.05rem;
                --font-md: 1.15rem;
                --font-lg: 1.4rem;
                --font-xl: 1.8rem;
                --bar-height: 20px;
            }

            .modal {
                max-width: 95vw;
                max-height: 90vh;
            }

            .match-modal-bar-name {
                width: auto;
                min-width: 80px;
            }
        }

        /* Responsive - Tablet+ */
        @media (min-width: 600px) {
            .mini-cards-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .analysis-grid {
                grid-template-columns: 1fr 1fr;
            }

            .pro-contra-grid {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .mini-list {
                font-size: var(--font-sm);
            }

            .mini-list-title {
                font-size: var(--font-sm);
            }
        }

        @media (min-width: 900px) {
            .card {
                padding: 20px 10%;
            }

            .mini-cards-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
            }
        }

        /* Feedback Button */
        .feedback-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            font-size: 1.4rem;
            cursor: pointer;
            z-index: 99;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .feedback-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        /* Feedback Modal */
        .feedback-modal {
            max-width: 420px;
        }

        .feedback-context-id {
            display: inline-block;
            padding: 4px 10px;
            background: var(--bg-dark);
            border-radius: 6px;
            font-size: var(--font-xs);
            color: var(--primary);
            font-family: monospace;
            margin-bottom: 16px;
        }

        .feedback-form-group {
            margin-bottom: 16px;
        }

        .feedback-label {
            display: block;
            font-size: var(--font-sm);
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .feedback-label .required {
            color: var(--danger);
        }

        .feedback-input,
        .feedback-textarea {
            width: 100%;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 14px;
            color: var(--text-primary);
            font-size: var(--font-base);
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .feedback-input:focus,
        .feedback-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .feedback-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Star Rating */
        .star-rating-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .star-rating-label {
            font-size: var(--font-sm);
            color: var(--text-muted);
            min-width: 80px;
        }

        .star-rating {
            display: flex;
            gap: 4px;
        }

        .star-rating .star {
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .star-rating .star:hover,
        .star-rating .star.active {
            color: #f1c40f;
            transform: scale(1.1);
        }

        .feedback-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .feedback-btn-cancel,
        .feedback-btn-submit {
            flex: 1;
            padding: 14px;
            border-radius: 10px;
            font-size: var(--font-base);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .feedback-btn-cancel {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .feedback-btn-cancel:hover {
            background: var(--bg-hover);
        }

        .feedback-btn-submit {
            background: var(--primary);
            border: none;
            color: white;
        }

        .feedback-btn-submit:hover {
            filter: brightness(1.1);
        }

        .feedback-btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Feedback Page (Card 4) */
        .feedback-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .feedback-filter-btn {
            padding: 8px 14px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 20px;
            font-size: var(--font-sm);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .feedback-filter-btn:hover {
            background: var(--bg-hover);
        }

        .feedback-filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .feedback-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .feedback-item {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 14px;
            border: 1px solid var(--border);
        }

        .feedback-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .feedback-item-context {
            font-size: var(--font-xs);
            color: var(--primary);
            font-family: monospace;
            background: rgba(255,255,255,0.05);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .feedback-item-name {
            font-size: var(--font-sm);
            color: var(--text-muted);
        }

        .feedback-item-title {
            font-size: var(--font-base);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .feedback-item-comment {
            font-size: var(--font-sm);
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .feedback-item-ratings {
            display: flex;
            gap: 20px;
            font-size: var(--font-sm);
        }

        .feedback-rating {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-muted);
        }

        .feedback-rating .stars {
            color: #f1c40f;
        }

        .feedback-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .feedback-loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        /* Advanced Feedback Filters */
        .feedback-search {
            margin-bottom: 15px;
        }

        .feedback-search-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: var(--font-sm);
        }

        .feedback-search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .feedback-advanced-filters {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .feedback-filter-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .feedback-filter-row:last-child {
            margin-bottom: 0;
        }

        .feedback-filter-row label {
            font-size: var(--font-sm);
            color: var(--text-muted);
            min-width: 90px;
        }

        .feedback-select {
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: var(--font-sm);
            cursor: pointer;
        }

        .filter-separator {
            color: var(--text-muted);
            font-size: var(--font-sm);
        }

        .feedback-category-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .cat-filter-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 16px;
            font-size: var(--font-xs);
            cursor: pointer;
            transition: all 0.2s;
        }

        .cat-filter-btn:hover {
            background: var(--bg-hover);
        }

        .cat-filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Reply/Thread Styles */
        .feedback-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .feedback-reply-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 16px;
            color: var(--text-muted);
            font-size: var(--font-xs);
            cursor: pointer;
            transition: all 0.2s;
        }

        .feedback-reply-btn:hover {
            background: var(--bg-hover);
            color: var(--primary);
            border-color: var(--primary);
        }

        .feedback-replies {
            margin-left: 20px;
            padding-left: 15px;
            border-left: 2px solid var(--border);
            margin-top: 12px;
        }

        .feedback-item.reply {
            background: rgba(255,255,255,0.02);
            padding: 12px;
        }

        .feedback-item.reply .feedback-item-context {
            font-size: 10px;
        }

        .reply-indicator {
            font-size: var(--font-xs);
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .feedback-timestamp {
            font-size: 10px;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <header>
        <h1>ARCHETYPEN-KOMPATIBILITÄT</h1>
    </header>

    <div class="carousel-container" id="carousel">
        <!-- CARD 1: MEIN TYP -->
        <div class="card" data-card="0">
            <div class="card-inner">
                <div class="card-header">
                    <span class="card-title">Mein Typ</span>
                </div>
                <div class="card-body">
                    <div class="main-select">
                        <label class="main-select-label">Ich bin...</label>
                        <select id="archetypeSelect">
                            <option value="single">Single</option>
                            <option value="duo">Duo</option>
                            <option value="duo_flex">Duo-Flex</option>
                            <option value="solopoly">Solopoly</option>
                            <option value="poly_hedo">Poly Hedo</option>
                            <option value="polyamor">Polyamor</option>
                        </select>
                    </div>

                    <div class="my-type-header">
                        <div class="my-type-icon" id="myTypeIcon">★</div>
                        <div class="type-tooltip">
                            <div class="my-type-name" id="myTypeName">Single</div>
                            <span class="tooltip-text" id="myTypeTooltip"></span>
                        </div>
                        <span class="type-info-icon" id="myTypeInfoIcon" onclick="openDefinitionModal(currentArchetype)" title="Was bedeutet dieser Typ?">ℹ</span>
                    </div>
                    <p class="my-type-desc" id="myTypeDesc">...</p>

                    <!-- Collapsible: Pro/Contra -->
                    <div class="collapsible" id="proContraCollapse">
                        <div class="collapsible-header" onclick="toggleCollapsible('proContraCollapse')">
                            <span>Pro & Contra</span>
                            <span class="collapsible-icon">▼</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="pro-contra-grid">
                                <div class="mini-list">
                                    <div class="mini-list-title pro">✓ Pro</div>
                                    <ul id="myTypePro"></ul>
                                </div>
                                <div class="mini-list">
                                    <div class="mini-list-title contra">✗ Contra</div>
                                    <ul id="myTypeContra"></ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Collapsible: Pathos/Logos -->
                    <div class="collapsible" id="pathosLogosCollapse">
                        <div class="collapsible-header" onclick="toggleCollapsible('pathosLogosCollapse')">
                            <span>Pathos & Logos</span>
                            <span class="collapsible-icon">▼</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="pathos-logos-content">
                                <p id="myTypePathos"></p>
                                <p id="myTypeLogos"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Match Section -->
                    <div class="match-section">
                        <div class="match-card top" id="topMatchCard" onclick="openMatchModal('top')">
                            <div class="match-info">
                                <div class="match-dot" id="topMatchDot"></div>
                                <div>
                                    <div class="match-label-text">Top Match</div>
                                    <div class="match-name" id="topMatchName">...</div>
                                </div>
                            </div>
                            <div class="match-score excellent" id="topMatchScore">0%</div>
                        </div>

                        <div class="match-card challenge" id="challengeCard" onclick="openMatchModal('challenge')">
                            <div class="match-info">
                                <div class="match-dot" id="challengeDot"></div>
                                <div>
                                    <div class="match-label-text">Challenge</div>
                                    <div class="match-name" id="challengeName">...</div>
                                </div>
                            </div>
                            <div class="match-score low" id="challengeScore">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CARD 2: KOMPATIBILITÄT -->
        <div class="card" data-card="1">
            <div class="card-inner">
                <div class="card-header">
                    <span class="card-title">Kompatibilität</span>
                </div>
                <div class="card-body">
                    <!-- Partner Selector -->
                    <div class="partner-selector" id="partnerSelector"></div>

                    <!-- Radar Chart -->
                    <div class="radar-section">
                        <div class="radar-header">
                            <div>
                                <div class="radar-title">
                                    <span class="type-tooltip"><span id="myTypeNameDisplay">...</span><span class="tooltip-text" id="myTypeTooltipPage3"></span></span>
                                    mit
                                    <span class="type-tooltip"><span id="partnerNameDisplay">...</span><span class="tooltip-text" id="partnerTooltipPage3"></span></span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div class="radar-score" id="overallScore" style="color: var(--primary);">0%</div>
                                <div class="radar-score-label">Gesamt</div>
                            </div>
                        </div>
                        <svg id="radarChart" viewBox="0 0 280 260"></svg>
                    </div>

                    <!-- Category Bars -->
                    <div class="category-section">
                        <div class="section-title-row">
                            <div class="section-title" style="margin-bottom: 0;">Kategorie-Details</div>
                            <div class="info-icon" onclick="openCategoryModal()">ℹ</div>
                        </div>
                        <div id="categoryBars"></div>
                    </div>

                    <!-- Pro/Contra Analysis -->
                    <div class="analysis-grid">
                        <div class="analysis-section pro">
                            <div class="analysis-title">✓ Was funktioniert</div>
                            <ul class="analysis-list" id="partnerPro"></ul>
                        </div>
                        <div class="analysis-section contra">
                            <div class="analysis-title">✗ Herausforderungen</div>
                            <ul class="analysis-list" id="partnerContra"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CARD 3: LEGENDE -->
        <div class="card" data-card="2">
            <div class="card-inner">
                <div class="card-header">
                    <span class="card-title">Legende</span>
                </div>
                <div class="card-body">
                    <!-- Farbskala -->
                    <div class="legend-section">
                        <div class="legend-title">Bewertungsskala</div>
                        <div class="color-scale">
                            <div class="color-scale-item">
                                <div class="color-scale-bar bar-excellent"></div>
                                <span class="color-scale-label">Exzellent</span>
                                <span class="color-scale-range">78-100%</span>
                            </div>
                            <div class="color-scale-item">
                                <div class="color-scale-bar bar-good"></div>
                                <span class="color-scale-label">Gut</span>
                                <span class="color-scale-range">70-77%</span>
                            </div>
                            <div class="color-scale-item">
                                <div class="color-scale-bar bar-medium"></div>
                                <span class="color-scale-label">Mittel</span>
                                <span class="color-scale-range">60-69%</span>
                            </div>
                            <div class="color-scale-item">
                                <div class="color-scale-bar bar-low"></div>
                                <span class="color-scale-label">Herausfordernd</span>
                                <span class="color-scale-range">&lt;60%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Kategorien -->
                    <div class="legend-section">
                        <div class="legend-title">Bewertungskategorien</div>
                        <div id="legendCategories"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CARD 4: FEEDBACK -->
        <div class="card" data-card="3">
            <div class="card-inner">
                <div class="card-header">
                    <span class="card-title">Feedback</span>
                </div>
                <div class="card-body">
                    <!-- Search -->
                    <div class="feedback-search">
                        <input type="text" id="feedbackSearch" placeholder="🔍 Suche nach Name, Titel oder Inhalt..." class="feedback-search-input">
                    </div>

                    <!-- Advanced Filters -->
                    <div class="feedback-advanced-filters">
                        <div class="feedback-filter-row">
                            <label>Kombination:</label>
                            <select id="filterMyType" class="feedback-select">
                                <option value="all">Alle Typen</option>
                            </select>
                            <span class="filter-separator">mit</span>
                            <select id="filterPartnerType" class="feedback-select">
                                <option value="all">Alle Partner</option>
                            </select>
                        </div>
                        <div class="feedback-filter-row">
                            <label>Kategorie:</label>
                            <div class="feedback-category-btns" id="categoryFilterBtns">
                                <button class="cat-filter-btn active" data-cat="all">Alle</button>
                                <button class="cat-filter-btn" data-cat="A" title="Beziehungsphilosophie">A Philosophie</button>
                                <button class="cat-filter-btn" data-cat="B" title="Werte-Alignment">B Werte</button>
                                <button class="cat-filter-btn" data-cat="C" title="Nähe-Distanz">C Nähe</button>
                                <button class="cat-filter-btn" data-cat="D" title="Autonomie">D Autonomie</button>
                                <button class="cat-filter-btn" data-cat="E" title="Kommunikation">E Kommunik.</button>
                                <button class="cat-filter-btn" data-cat="F" title="Soziale Kompatibilität">F Sozial</button>
                                <button class="cat-filter-btn" data-cat="TM" title="Top Match">Top Match</button>
                                <button class="cat-filter-btn" data-cat="CH" title="Challenge">Challenge</button>
                            </div>
                        </div>
                        <div class="feedback-filter-row">
                            <label>Sortieren:</label>
                            <select id="filterSort" class="feedback-select">
                                <option value="newest">Neueste zuerst</option>
                                <option value="oldest">Älteste zuerst</option>
                                <option value="rating">Beste Bewertung</option>
                            </select>
                        </div>
                    </div>

                    <!-- Feedback List -->
                    <div class="feedback-list" id="feedbackList">
                        <div class="feedback-loading">Lade Feedback...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div class="modal-overlay" id="categoryModal" onclick="closeCategoryModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Kategorie-Details</span>
                <button class="modal-close" onclick="closeCategoryModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div class="modal-overlay" id="feedbackModal" onclick="closeFeedbackModal(event)">
        <div class="modal feedback-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-title">Feedback geben</span>
                <button class="modal-close" onclick="closeFeedbackModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="feedback-context-id" id="feedbackContextId">S1-SINGLE</div>

                <div class="feedback-form-group">
                    <label class="feedback-label">Name/Kürzel <span class="required">*</span></label>
                    <input type="text" class="feedback-input" id="feedbackName" placeholder="z.B. Max, Anna, M.S." maxlength="20">
                </div>

                <div class="feedback-form-group">
                    <label class="feedback-label">Titel <span class="required">*</span></label>
                    <input type="text" class="feedback-input" id="feedbackTitle" placeholder="Kurze Zusammenfassung" maxlength="50">
                </div>

                <div class="feedback-form-group">
                    <label class="feedback-label">Kommentar</label>
                    <textarea class="feedback-textarea" id="feedbackComment" placeholder="Dein Feedback zu dieser Ansicht..."></textarea>
                </div>

                <div class="feedback-form-group">
                    <label class="feedback-label">Bewertung</label>
                    <div class="star-rating-group">
                        <span class="star-rating-label">Verstand</span>
                        <span style="font-size: 1rem;">😕</span>
                        <div class="star-rating" id="ratingVerstand">
                            <span class="star" data-value="1">★</span>
                            <span class="star" data-value="2">★</span>
                            <span class="star" data-value="3">★</span>
                            <span class="star" data-value="4">★</span>
                            <span class="star" data-value="5">★</span>
                        </div>
                        <span style="font-size: 1rem;">🤩</span>
                    </div>
                    <div class="star-rating-group" style="margin-top: 10px;">
                        <span class="star-rating-label">Gefühl</span>
                        <span style="font-size: 1rem;">😕</span>
                        <div class="star-rating" id="ratingGefuehl">
                            <span class="star" data-value="1">★</span>
                            <span class="star" data-value="2">★</span>
                            <span class="star" data-value="3">★</span>
                            <span class="star" data-value="4">★</span>
                            <span class="star" data-value="5">★</span>
                        </div>
                        <span style="font-size: 1rem;">🤩</span>
                    </div>
                </div>

                <div class="feedback-buttons">
                    <button class="feedback-btn-cancel" onclick="closeFeedbackModal()">Abbrechen</button>
                    <button class="feedback-btn-submit" id="feedbackSubmitBtn" onclick="submitFeedback()">Senden</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Definition Modal -->
    <div class="modal-overlay" id="definitionModal" onclick="closeDefinitionModal(event)">
        <div class="modal definition-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-title" id="definitionModalTitle">Typ-Definition</span>
                <button class="modal-close" onclick="closeDefinitionModal()">&times;</button>
            </div>
            <div class="modal-body" id="definitionModalBody"></div>
        </div>
    </div>

    <!-- Navigation Dots with Arrows -->
    <div class="nav-dots">
        <button class="nav-arrow" onclick="navigatePrev()">‹</button>
        <div class="nav-dot active" data-card="0" onclick="scrollToCard(0)"></div>
        <div class="nav-dot" data-card="1" onclick="scrollToCard(1)"></div>
        <div class="nav-dot" data-card="2" onclick="scrollToCard(2)"></div>
        <div class="nav-dot" data-card="3" onclick="scrollToCard(3)"></div>
        <button class="nav-arrow" onclick="navigateNext()">›</button>
    </div>

    <div class="swipe-hint">← Swipe →</div>

    <script>
        let data = null;
        let currentArchetype = 'single';
        let selectedPartner = 'duo';

        const icons = {
            single: '★',
            duo: '♡',
            duo_flex: '⚡',
            solopoly: '◆',
            poly_hedo: '☀',
            polyamor: '♥'
        };

        const categoryNames = {
            A: 'Beziehungsphilosophie',
            B: 'Werte-Alignment',
            C: 'Nähe-Distanz',
            D: 'Autonomie',
            E: 'Kommunikation',
            F: 'Soziale Kompatibilität'
        };

        // Archetype definitions
        const archetypeDefinitions = {
            single: {
                name: "Single",
                shortDef: "Bewusste Entscheidung für ein autonomes Leben ohne Primärbeziehung als dauerhafte Lebensform.",
                longDef: "Single-orientierte Menschen haben sich aktiv für ein Leben ohne dauerhafte romantische Partnerschaft entschieden. Dies ist keine Übergangsphase ('zwischen Beziehungen'), sondern eine bewusste Lebensform, die Selbstgenügsamkeit und persönliche Autonomie als zentrale Werte sieht. Soziale Kontakte, Freundschaften und gelegentliche romantische/sexuelle Begegnungen sind möglich, aber keine feste Partnerschaft wird angestrebt.",
                keyPrinciples: [
                    "Selbstgenügsamkeit als Wert, nicht als Mangel",
                    "Persönliche Autonomie über Verbindlichkeit",
                    "Beziehungen als Option, nicht als Notwendigkeit",
                    "Erfüllung durch Selbst, Freunde, Projekte"
                ],
                notTheSameAs: [
                    "'Zwischen Beziehungen' sein",
                    "'Noch nicht den Richtigen gefunden'",
                    "Beziehungsunfähig oder bindungsängstlich",
                    "Einsam oder unglücklich"
                ],
                variants: [
                    "Aromantisch-Single: Keine romantischen Gefühle, kein Bedürfnis danach",
                    "Bewusst-autonom: Positive Entscheidung für Freiheit",
                    "Beziehungs-kritisch: Bevorzugt Unabhängigkeit"
                ]
            },
            duo: {
                name: "Duo",
                shortDef: "Traditionelle monogame Zweierbeziehung mit Exklusivität und gemeinsamer Lebensgestaltung als Kernprinzip.",
                longDef: "Duo-orientierte Menschen leben in oder suchen eine klassische Zweierbeziehung mit romantischer und sexueller Exklusivität. Die Partnerschaft steht im Zentrum der Lebensgestaltung und wird als primäre emotionale und soziale Einheit verstanden. Gemeinsame Ziele, Alltag und Zukunftsplanung werden als Paar gestaltet.",
                keyPrinciples: [
                    "Exklusivität als Ausdruck von Verbindlichkeit",
                    "'Wir' als zentrale Einheit über 'Ich'",
                    "Tiefe durch Fokussierung auf eine Person",
                    "Gemeinsame Lebensgestaltung und Zukunftsplanung",
                    "Treue als emotionale und sexuelle Exklusivität"
                ],
                notTheSameAs: [
                    "Besitzdenken oder Kontrolle",
                    "Verlust der eigenen Identität",
                    "'Alte' oder 'überholte' Beziehungsform",
                    "Langweilig oder unerfüllt"
                ],
                variants: [
                    "Traditionell-Duo: Klassisches Ehe-Modell",
                    "Modern-Duo: Ohne Trauschein, flexiblere Rollen",
                    "Intensiv-Duo: Sehr enge emotionale Verschmelzung"
                ]
            },
            duo_flex: {
                name: "Duo-Flex",
                shortDef: "Primäre Zweierbeziehung mit vereinbarten Öffnungen für zusätzliche Kontakte unter klaren Regeln.",
                longDef: "Duo-Flex-orientierte Menschen leben in einer Hauptbeziehung mit einem Primärpartner, öffnen diese aber bewusst und einvernehmlich für weitere Kontakte. Die Primärbeziehung bleibt zentral und privilegiert. Alle Öffnungen erfolgen transparent und nach gemeinsam vereinbarten Regeln.",
                keyPrinciples: [
                    "Primärbeziehung als Anker und Priorität",
                    "Sexuelle/romantische Vielfalt ohne Hierarchie-Aufgabe",
                    "Ehrlichkeit und Transparenz über alle Kontakte",
                    "Regeln schützen die Hauptbeziehung",
                    "Freiheit innerhalb vereinbarter Grenzen"
                ],
                notTheSameAs: [
                    "Untreue oder Betrug (alles ist abgesprochen!)",
                    "'Beziehung retten' durch Öffnung",
                    "Fehlende Verbindlichkeit",
                    "Übergangsphase zu Polyamorie"
                ],
                variants: [
                    "Swinging/Lifestyle: Gemeinsame sexuelle Erlebnisse",
                    "Open Relationship: Individuelle sexuelle Freiheit",
                    "Hierarchisches Poly: Primärpartner + Nebenbeziehungen"
                ]
            },
            solopoly: {
                name: "Solopoly",
                shortDef: "Mehrere gleichwertige Beziehungen bei bewusster Bewahrung der eigenen Autonomie - keine Primärpartner.",
                longDef: "Solopoly-orientierte Menschen führen mehrere romantische und/oder sexuelle Beziehungen parallel, ohne eine davon als 'Hauptbeziehung' zu priorisieren. Die persönliche Autonomie steht im Zentrum: Kein Zusammenziehen, keine gemeinsame Haushaltsführung. 'Ich bin mein eigener Primärpartner'.",
                keyPrinciples: [
                    "Autonomie als höchster Wert - auch in Beziehungen",
                    "Mehrere gleichwertige Beziehungen ohne Hierarchie",
                    "Keine Verschmelzung oder gemeinsame Haushalte",
                    "'Ich bin mein eigener Primärpartner'",
                    "Liebe ohne Aufgabe der Unabhängigkeit"
                ],
                notTheSameAs: [
                    "Bindungsangst oder Commitment-Probleme",
                    "'Light-Version' von Polyamorie",
                    "Egoistisch oder beziehungsunfähig",
                    "Zwischenstufe zu 'richtiger' Partnerschaft"
                ],
                variants: [
                    "Stark-autonom: Sehr klare Grenzen",
                    "Beziehungs-balanciert: Tiefe Beziehungen, getrennte Wohnungen",
                    "Netzwerk-orientiert: Viele gleichwertige Connections"
                ]
            },
            poly_hedo: {
                name: "Poly Hedo",
                shortDef: "Freiheitsorientierte Poly-Orientierung mit Fokus auf Genuss, Spontaneität und lebensbereichernde Erfahrungen.",
                longDef: "Poly-Hedo-orientierte Menschen leben multiple Beziehungen mit Betonung auf Lebensfreude, Spontaneität und genussvolle Erfahrungen. Weniger Regelwerk als bei anderen Poly-Formen, mehr Flow und Intuition. Die Freude am Moment und an vielfältigen Verbindungen steht im Vordergrund.",
                keyPrinciples: [
                    "Lebensfreude und Genuss als zentrale Werte",
                    "Spontaneität über starre Regeln",
                    "Vielfalt der Erfahrungen bereichert das Leben",
                    "Freiheit in Verbindungen",
                    "Intensität des Moments"
                ],
                notTheSameAs: [
                    "Verantwortungslos oder rücksichtslos",
                    "'Nur Sex ohne Gefühle'",
                    "Oberflächlich oder bindungsunfähig",
                    "Chaotisch oder planlos"
                ],
                variants: [
                    "Erlebnis-orientiert: Fokus auf gemeinsame Abenteuer",
                    "Genuss-zentriert: Sinnlichkeit und Lebensfreude",
                    "Freigeist: Maximale Spontaneität und Offenheit"
                ]
            },
            polyamor: {
                name: "Polyamor",
                shortDef: "Mehrere gleichzeitige, ethisch geführte Liebesbeziehungen mit Transparenz und emotionalem Commitment.",
                longDef: "Polyamor-orientierte Menschen führen mehrere romantische Beziehungen parallel, die alle auf Ehrlichkeit, Einvernehmlichkeit und Transparenz basieren. Tiefe Verschmelzung, Zusammenleben und gemeinsame Zukunftsplanung mit mehreren Partnern sind möglich und erwünscht. Alle Beteiligten wissen voneinander.",
                keyPrinciples: [
                    "Liebe ist nicht begrenzt oder exklusiv",
                    "Ehrlichkeit und Transparenz gegenüber allen",
                    "Konsens und Einvernehmlichkeit als Basis",
                    "Emotionale Tiefe zu mehreren Menschen",
                    "Kommunikation als zentrale Kompetenz"
                ],
                notTheSameAs: [
                    "Untreue oder Betrug (alle wissen Bescheid!)",
                    "Bindungsunfähigkeit",
                    "Nur Sex ohne Gefühle",
                    "Chaotisch oder unkontrolliert"
                ],
                variants: [
                    "Hierarchisches Poly: Primär-, Sekundärpartner",
                    "Nicht-hierarchisches Poly: Alle gleichwertig",
                    "Kitchen-Table-Poly: Alle Partner verstehen sich",
                    "Parallel-Poly: Partner kennen sich, wenig Kontakt"
                ]
            }
        };

        // Category descriptions loaded from data
        let categoryDescriptions = {};

        async function loadData() {
            try {
                const response = await fetch('archetype-matrix.json');
                data = await response.json();
                // Load category descriptions from data
                if (data.categories) {
                    categoryDescriptions = data.categories;
                }
            } catch (error) {
                console.error('Error loading data:', error);
                data = getFallbackData();
            }
            initApp();
        }

        function getFallbackData() {
            return {
                archetypes: {
                    single: { id: "single", name: "Single", color: "#E63946", shortDescription: "Fokus auf Selbstentwicklung", pro: [], contra: [], pathos: "", logos: "" },
                    duo: { id: "duo", name: "Duo", color: "#E84393", shortDescription: "Klassische monogame Zweierbeziehung", pro: [], contra: [], pathos: "", logos: "" },
                    duo_flex: { id: "duo_flex", name: "Duo-Flex", color: "#FF6B6B", shortDescription: "Primär Zweierbeziehung mit situativer Öffnung", pro: [], contra: [], pathos: "", logos: "" },
                    solopoly: { id: "solopoly", name: "Solopoly", color: "#2A9D8F", shortDescription: "Polyamor mit Autonomie", pro: [], contra: [], pathos: "", logos: "" },
                    poly_hedo: { id: "poly_hedo", name: "Poly Hedo", color: "#9B5DE5", shortDescription: "Lustorientierte Mehrfachbeziehungen", pro: [], contra: [], pathos: "", logos: "" },
                    polyamor: { id: "polyamor", name: "Polyamor", color: "#F4A261", shortDescription: "Strukturierte Mehrfachbeziehungen", pro: [], contra: [], pathos: "", logos: "" }
                },
                categories: {},
                interactions: {},
                aggregatedMatrix: { rows: [], cols: [], values: [] }
            };
        }

        function initApp() {
            document.getElementById('archetypeSelect').addEventListener('change', (e) => {
                currentArchetype = e.target.value;
                updateAll();
            });

            // Carousel scroll detection
            const carousel = document.getElementById('carousel');
            carousel.addEventListener('scroll', updateNavDots);

            updateAll();
        }

        function updateAll() {
            updateTheme();
            updateMyType();
            updatePartnerSelector();
            updateTopAndChallenge();
            updatePartnerView();
            updateLegendCategories();
        }

        function updateTheme() {
            document.body.className = `theme-${currentArchetype}`;
        }

        function updateMyType() {
            const arch = data.archetypes[currentArchetype];
            if (!arch) return;

            document.getElementById('myTypeIcon').textContent = icons[currentArchetype];
            document.getElementById('myTypeIcon').style.background = arch.color;
            document.getElementById('myTypeName').textContent = arch.name;
            document.getElementById('myTypeName').style.color = arch.color;
            document.getElementById('myTypeDesc').textContent = arch.shortDescription || '';
            document.getElementById('myTypeTooltip').textContent = getShortDef(currentArchetype);

            const proList = document.getElementById('myTypePro');
            proList.innerHTML = (arch.pro || []).slice(0, 4).map(p => `<li>${p}</li>`).join('');

            const contraList = document.getElementById('myTypeContra');
            contraList.innerHTML = (arch.contra || []).slice(0, 4).map(c => `<li>${c}</li>`).join('');

            document.getElementById('myTypePathos').textContent = arch.pathos || '';
            document.getElementById('myTypeLogos').textContent = arch.logos || '';
        }

        // Fixed archetype order to ensure all types are shown
        const archetypeOrder = ['single', 'duo', 'duo_flex', 'solopoly', 'poly_hedo', 'polyamor'];

        function updatePartnerSelector() {
            const container = document.getElementById('partnerSelector');
            // Show ALL archetypes as partner options (including own type for self-matching)
            const allPartners = archetypeOrder
                .map(id => data.archetypes[id])
                .filter(arch => arch); // Remove any undefined

            if (!allPartners.find(o => o.id === selectedPartner)) {
                selectedPartner = allPartners[0]?.id || 'duo';
            }

            container.innerHTML = allPartners.map(arch => `
                <button class="partner-btn ${arch.id === selectedPartner ? 'active' : ''}"
                        onclick="selectPartner('${arch.id}')"
                        data-id="${arch.id}">
                    <span class="dot" style="background: ${arch.color}"></span>
                    ${arch.name}
                </button>
            `).join('');
        }

        function selectPartner(partnerId) {
            selectedPartner = partnerId;
            document.querySelectorAll('.partner-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.id === partnerId);
            });
            updatePartnerView();
        }

        function updateTopAndChallenge() {
            // Include all types (including self) for top match and challenge
            const others = archetypeOrder;
            let topMatch = { id: null, score: 0 };
            let challenge = { id: null, score: 100 };

            others.forEach(otherId => {
                const key = `${currentArchetype}_${otherId}`;
                const interaction = data.interactions[key];
                const score = interaction?.overall || 0;

                if (score > topMatch.score) {
                    topMatch = { id: otherId, score };
                }
                if (score < challenge.score) {
                    challenge = { id: otherId, score };
                }
            });

            // Store for modal access
            currentTopMatch = topMatch;
            currentChallenge = challenge;

            const myArch = data.archetypes[currentArchetype];

            if (topMatch.id) {
                const arch = data.archetypes[topMatch.id];
                document.getElementById('topMatchDot').style.background = arch.color;
                document.getElementById('topMatchName').textContent = `${myArch.name} (Ich) mit ${arch.name}`;
                document.getElementById('topMatchScore').textContent = topMatch.score + '%';
            }

            if (challenge.id) {
                const arch = data.archetypes[challenge.id];
                document.getElementById('challengeDot').style.background = arch.color;
                document.getElementById('challengeName').textContent = `${myArch.name} (Ich) mit ${arch.name}`;
                document.getElementById('challengeScore').textContent = challenge.score + '%';
            }
        }

        function updatePartnerView() {
            const myArch = data.archetypes[currentArchetype];
            const partnerArch = data.archetypes[selectedPartner];
            const interactionKey = `${currentArchetype}_${selectedPartner}`;
            const interaction = data.interactions[interactionKey] || {};

            document.getElementById('myTypeNameDisplay').textContent = myArch?.name || '...';
            document.getElementById('partnerNameDisplay').textContent = partnerArch?.name || '...';
            document.getElementById('myTypeTooltipPage3').textContent = getShortDef(currentArchetype);
            document.getElementById('partnerTooltipPage3').textContent = getShortDef(selectedPartner);

            const score = interaction.overall || 0;
            const scoreEl = document.getElementById('overallScore');
            scoreEl.textContent = score + '%';
            scoreEl.style.color = getScoreColor(score);

            drawRadarChart(interaction.scores || {}, partnerArch?.color || '#457B9D');
            updateCategoryBars(interaction.scores || {});

            const proList = document.getElementById('partnerPro');
            proList.innerHTML = (interaction.pro || []).map(p => `<li>${p}</li>`).join('') || '<li>Keine Daten</li>';

            const contraList = document.getElementById('partnerContra');
            contraList.innerHTML = (interaction.contra || []).map(c => `<li>${c}</li>`).join('') || '<li>Keine Daten</li>';
        }

        function drawRadarChart(scores, color) {
            const svg = document.getElementById('radarChart');
            const cx = 140, cy = 120, maxR = 90;
            const categories = ['A', 'B', 'C', 'D', 'E', 'F'];
            const n = categories.length;

            let html = '';

            for (let r = 18; r <= maxR; r += 18) {
                html += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="1"/>`;
            }

            categories.forEach((cat, i) => {
                const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
                const x = cx + Math.cos(angle) * maxR;
                const y = cy + Math.sin(angle) * maxR;
                const labelX = cx + Math.cos(angle) * (maxR + 18);
                const labelY = cy + Math.sin(angle) * (maxR + 18);

                html += `<line x1="${cx}" y1="${cy}" x2="${x}" y2="${y}" stroke="rgba(255,255,255,0.08)" stroke-width="1"/>`;
                html += `<text x="${labelX}" y="${labelY}" fill="var(--text-muted)" font-size="10" text-anchor="middle" dominant-baseline="middle">${cat}</text>`;
            });

            const points = categories.map((cat, i) => {
                const value = scores[cat]?.value || 0;
                const r = (value / 100) * maxR;
                const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
                return `${cx + Math.cos(angle) * r},${cy + Math.sin(angle) * r}`;
            }).join(' ');

            html += `<polygon points="${points}" fill="${color}33" stroke="${color}" stroke-width="2"/>`;

            categories.forEach((cat, i) => {
                const value = scores[cat]?.value || 0;
                const r = (value / 100) * maxR;
                const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
                const x = cx + Math.cos(angle) * r;
                const y = cy + Math.sin(angle) * r;
                html += `<circle cx="${x}" cy="${y}" r="4" fill="${color}"/>`;
            });

            svg.innerHTML = html;
        }

        function updateCategoryBars(scores) {
            const container = document.getElementById('categoryBars');
            const categories = ['A', 'B', 'C', 'D', 'E', 'F'];

            container.innerHTML = categories.map(cat => {
                const value = scores[cat]?.value || 0;
                const barClass = getBarClass(value);
                const name = categoryNames[cat] || cat;

                return `
                    <div class="category-row" onclick="openSingleCategoryModal('${cat}')">
                        <span class="category-label">${cat}</span>
                        <div class="category-bar-wrap">
                            <div class="category-bar-container">
                                <div class="category-bar ${barClass}" style="width: ${value}%">
                                    <span class="category-bar-value">${value}%</span>
                                </div>
                            </div>
                            <div class="category-name">${name}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getScoreColor(score) {
            if (score >= 78) return '#00cec9';
            if (score >= 70) return '#27ae60';
            if (score >= 60) return '#f39c12';
            return '#e74c3c';
        }

        function getBarClass(value) {
            if (value >= 78) return 'bar-excellent';
            if (value >= 70) return 'bar-good';
            if (value >= 60) return 'bar-medium';
            return 'bar-low';
        }

        function toggleCollapsible(id) {
            document.getElementById(id).classList.toggle('open');
        }

        function scrollToCard(index) {
            const carousel = document.getElementById('carousel');
            const cardWidth = window.innerWidth;
            carousel.scrollTo({ left: cardWidth * index, behavior: 'smooth' });
        }

        const TOTAL_PAGES = 4;

        function updateNavDots() {
            const carousel = document.getElementById('carousel');
            const cardWidth = window.innerWidth;
            const currentCard = Math.round(carousel.scrollLeft / cardWidth);

            document.querySelectorAll('.nav-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === currentCard);
            });

            // Update arrow states
            const arrows = document.querySelectorAll('.nav-arrow');
            if (arrows.length >= 2) {
                arrows[0].disabled = currentCard === 0;
                arrows[1].disabled = currentCard === TOTAL_PAGES - 1;
            }

            // Load feedback when on page 4
            if (currentCard === 3) {
                loadFeedback();
            }
        }

        function navigatePrev() {
            const carousel = document.getElementById('carousel');
            const cardWidth = window.innerWidth;
            const currentCard = Math.round(carousel.scrollLeft / cardWidth);
            if (currentCard > 0) {
                scrollToCard(currentCard - 1);
            }
        }

        function navigateNext() {
            const carousel = document.getElementById('carousel');
            const cardWidth = window.innerWidth;
            const currentCard = Math.round(carousel.scrollLeft / cardWidth);
            if (currentCard < TOTAL_PAGES - 1) {
                scrollToCard(currentCard + 1);
            }
        }

        // Legend Categories
        function updateLegendCategories() {
            const container = document.getElementById('legendCategories');
            const categories = ['A', 'B', 'C', 'D', 'E', 'F'];

            // Get current interaction scores
            const interactionKey = `${currentArchetype}_${selectedPartner}`;
            const interaction = data.interactions[interactionKey] || {};
            const scores = interaction.scores || {};

            const myArch = data.archetypes[currentArchetype];
            const partnerArch = data.archetypes[selectedPartner];
            const myName = myArch?.name || currentArchetype;
            const partnerName = partnerArch?.name || selectedPartner;

            // Show which combination is displayed
            const headerText = currentArchetype === selectedPartner
                ? `${myName} (Ich) mit ${myName}`
                : `${myName} (Ich) mit ${partnerName}`;

            container.innerHTML = `
                <div style="margin-bottom: 15px; padding: 10px; background: var(--bg-dark); border-radius: 10px; text-align: center;">
                    <span style="color: var(--text-muted); font-size: var(--font-sm);">Aktuelle Auswahl:</span>
                    <div style="color: var(--primary); font-weight: 600; font-size: var(--font-base);">${headerText}</div>
                </div>
            ` + categories.map(cat => {
                const catData = categoryDescriptions[cat] || {};
                const name = catData.name || categoryNames[cat] || cat;
                const desc = catData.description || 'Beschreibung nicht verfügbar';
                const value = scores[cat]?.value || 0;
                const scoreColor = getScoreColor(value);

                return `
                    <div class="legend-category-item" onclick="openSingleCategoryModal('${cat}')">
                        <div class="legend-category-letter">${cat}</div>
                        <div class="legend-category-content">
                            <div class="legend-category-name">${name}</div>
                            <div class="legend-category-desc">${desc}</div>
                        </div>
                        <div style="font-weight: 700; font-size: var(--font-md); color: ${scoreColor}; min-width: 50px; text-align: right;">${value}%</div>
                    </div>
                `;
            }).join('');
        }

        // Modal Functions
        function openCategoryModal() {
            // Reset modal context when opening directly (uses page 2 selection)
            modalContextPartner = null;
            const categories = ['A', 'B', 'C', 'D', 'E', 'F'];
            document.getElementById('modalTitle').textContent = 'Alle Kategorien';
            document.getElementById('modalBody').innerHTML = categories.map(cat => getCategoryModalContent(cat)).join('');
            document.getElementById('categoryModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        let currentModalCategory = 'A'; // Track current category for navigation

        function openSingleCategoryModal(category) {
            currentModalCategory = category;
            // Don't reset modalContextPartner here - it may be set from match modal
            const catData = categoryDescriptions[category] || {};
            const name = catData.name || categoryNames[category] || category;
            document.getElementById('modalTitle').textContent = `Kategorie ${category}`;
            document.getElementById('modalBody').innerHTML = getCategoryModalContent(category);
            document.getElementById('categoryModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function navigateCategoryPrev() {
            const categories = ['A', 'B', 'C', 'D', 'E', 'F'];
            const currentIndex = categories.indexOf(currentModalCategory);
            const prevIndex = currentIndex > 0 ? currentIndex - 1 : categories.length - 1;
            openSingleCategoryModal(categories[prevIndex]);
        }

        function navigateCategoryNext() {
            const categories = ['A', 'B', 'C', 'D', 'E', 'F'];
            const currentIndex = categories.indexOf(currentModalCategory);
            const nextIndex = currentIndex < categories.length - 1 ? currentIndex + 1 : 0;
            openSingleCategoryModal(categories[nextIndex]);
        }

        function getCategoryModalContent(cat) {
            const catData = categoryDescriptions[cat] || {};
            const name = catData.name || categoryNames[cat] || cat;
            const desc = catData.description || 'Beschreibung nicht verfügbar';
            const subDims = catData.subDimensions || [];

            // Use modalContextPartner if set (from match modal), otherwise use selectedPartner (from page 2)
            const partnerId = modalContextPartner || selectedPartner;
            const interactionKey = `${currentArchetype}_${partnerId}`;
            const interaction = data.interactions[interactionKey] || {};
            const scores = interaction.scores || {};
            const value = scores[cat]?.value || 0;
            const scoreColor = getScoreColor(value);
            const barClass = getBarClass(value);

            const myArch = data.archetypes[currentArchetype];
            const partnerArch = data.archetypes[partnerId];
            const comboText = `${myArch?.name || '?'} + ${partnerArch?.name || '?'}`;
            const contextText = `${comboText} | ${name}`;

            // Get category position for navigation
            const categories = ['A', 'B', 'C', 'D', 'E', 'F'];
            const catIndex = categories.indexOf(cat);
            const prevCat = categories[catIndex > 0 ? catIndex - 1 : categories.length - 1];
            const nextCat = categories[catIndex < categories.length - 1 ? catIndex + 1 : 0];
            const prevName = categoryNames[prevCat] || prevCat;
            const nextName = categoryNames[nextCat] || nextCat;

            return `
                <div class="category-nav-row">
                    <button class="category-nav-btn" onclick="navigateCategoryPrev()">
                        ‹ ${prevCat}
                    </button>
                    <span class="category-nav-indicator">${catIndex + 1} / 6</span>
                    <button class="category-nav-btn" onclick="navigateCategoryNext()">
                        ${nextCat} ›
                    </button>
                </div>

                <div class="modal-feedback-btn" onclick="openFeedbackModalWithContext('${contextText}')">
                    💬 Feedback zu ${comboText} | ${name}
                </div>

                <div class="modal-category">
                    <div class="modal-category-header">
                        <div class="modal-category-letter">${cat}</div>
                        <div class="modal-category-name">${name}</div>
                    </div>
                    <div class="match-modal-score" style="margin: 12px 0;">
                        <span class="match-modal-score-label">${comboText}</span>
                        <span class="match-modal-score-value" style="color: ${scoreColor}">${value}%</span>
                    </div>
                    <div class="modal-category-desc">${desc}</div>
                    ${subDims.length > 0 ? `
                        <div class="modal-subdimensions">
                            ${subDims.map(sd => `<span class="modal-subdim-tag">${sd}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function closeCategoryModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('categoryModal').classList.remove('active');
            document.body.style.overflow = '';
            // Reset modal context when closing
            modalContextPartner = null;
        }

        // Definition Modal Functions
        function openDefinitionModal(archetypeId) {
            const def = archetypeDefinitions[archetypeId];
            if (!def) return;

            const arch = data.archetypes[archetypeId];
            const color = arch?.color || 'var(--primary)';
            const icon = icons[archetypeId] || '?';

            document.getElementById('definitionModalTitle').innerHTML = `
                <span style="color: ${color}">${icon}</span> ${def.name}
            `;

            document.getElementById('definitionModalBody').innerHTML = `
                <div class="definition-long">${def.longDef}</div>

                <div class="definition-section">
                    <div class="definition-section-title">Kernprinzipien</div>
                    <ul class="definition-list principles">
                        ${def.keyPrinciples.map(p => `<li>${p}</li>`).join('')}
                    </ul>
                </div>

                <div class="definition-section">
                    <div class="definition-section-title">Das ist NICHT dasselbe wie</div>
                    <ul class="definition-list not-same">
                        ${def.notTheSameAs.map(n => `<li>${n}</li>`).join('')}
                    </ul>
                </div>

                <div class="definition-section">
                    <div class="definition-section-title">Varianten</div>
                    <ul class="definition-list variants">
                        ${def.variants.map(v => `<li>${v}</li>`).join('')}
                    </ul>
                </div>
            `;

            document.getElementById('definitionModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeDefinitionModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('definitionModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Get short definition for tooltip
        function getShortDef(archetypeId) {
            return archetypeDefinitions[archetypeId]?.shortDef || '';
        }

        // Store current match data for modal access
        let currentTopMatch = { id: null, score: 0 };
        let currentChallenge = { id: null, score: 0 };
        let modalContextPartner = null; // Track which partner to use in category modal

        // Match Modal Functions
        function openMatchModal(type) {
            const matchData = type === 'top' ? currentTopMatch : currentChallenge;
            if (!matchData.id) return;

            // Set the modal context to use this match's partner
            modalContextPartner = matchData.id;

            const myArch = data.archetypes[currentArchetype];
            const partnerArch = data.archetypes[matchData.id];
            const interactionKey = `${currentArchetype}_${matchData.id}`;
            const interaction = data.interactions[interactionKey] || {};
            const scores = interaction.scores || {};

            const title = type === 'top' ? 'Top Match' : 'Challenge';
            const scoreColor = getScoreColor(matchData.score);

            document.getElementById('modalTitle').textContent = `${myArch.name} + ${partnerArch.name}`;
            document.getElementById('modalBody').innerHTML = getMatchModalContent(partnerArch, interaction, scores, scoreColor, myArch);
            document.getElementById('categoryModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function getMatchModalContent(partnerArch, interaction, scores, scoreColor, myArch) {
            const categories = ['A', 'B', 'C', 'D', 'E', 'F'];
            const overall = interaction.overall || 0;
            const isIdenticalType = myArch.id === partnerArch.id;

            const categoryBars = categories.map(cat => {
                const value = scores[cat]?.value || 0;
                const barClass = getBarClass(value);
                const name = categoryNames[cat] || cat;

                // Special note for identical types on category A (Beziehungsphilosophie)
                const isPhilosophyCategory = cat === 'A' && isIdenticalType;
                const specialNote = isPhilosophyCategory
                    ? '<div style="font-size: 10px; color: var(--success); margin-top: 2px;">Identische Grundüberzeugung</div>'
                    : '';

                return `
                    <div class="match-modal-bar-row clickable" onclick="openSingleCategoryModal('${cat}')">
                        <span class="match-modal-bar-label">${cat}</span>
                        <div class="match-modal-bar-container">
                            <div class="match-modal-bar ${barClass}" style="width: ${value}%">
                                <span class="match-modal-bar-value">${value}%</span>
                            </div>
                            ${specialNote}
                        </div>
                        <span class="match-modal-bar-name">${name}</span>
                    </div>
                `;
            }).join('');

            const proItems = (interaction.pro || []).map(p => `<li>${p}</li>`).join('') || '<li>Keine Daten</li>';
            const contraItems = (interaction.contra || []).map(c => `<li>${c}</li>`).join('') || '<li>Keine Daten</li>';

            // Special banner for identical types
            const identicalTypeBanner = isIdenticalType ? `
                <div style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.15), rgba(46, 204, 113, 0.05));
                            border: 1px solid var(--success); border-radius: 10px; padding: 12px; margin-bottom: 15px; text-align: center;">
                    <div style="font-weight: 600; color: var(--success); margin-bottom: 4px;">✓ Identischer Beziehungstyp</div>
                    <div style="font-size: var(--font-sm); color: var(--text-secondary);">
                        Ihr teilt dieselbe Grundüberzeugung über Beziehungen
                    </div>
                </div>
            ` : '';

            const comboText = `${myArch.name} + ${partnerArch.name}`;
            const myDef = archetypeDefinitions[myArch.id]?.shortDef || '';
            const partnerDef = archetypeDefinitions[partnerArch.id]?.shortDef || '';

            return `
                <div class="modal-feedback-btn" onclick="openFeedbackModalWithContext('${comboText}')">
                    💬 Feedback zu ${comboText}
                </div>

                <div class="match-modal-header">
                    <div class="match-modal-icon" style="background: ${partnerArch.color}">${icons[partnerArch.id]}</div>
                    <div class="match-modal-info">
                        <h3 style="color: ${partnerArch.color}">
                            ${partnerArch.name}
                            <span class="type-info-icon" onclick="openDefinitionModal('${partnerArch.id}')" title="Definition anzeigen">ℹ</span>
                        </h3>
                        <p>${partnerArch.shortDescription || ''}</p>
                    </div>
                </div>

                ${identicalTypeBanner}

                <div class="type-definitions-compact" style="background: var(--bg-dark); border-radius: 10px; padding: 12px; margin-bottom: 15px; font-size: var(--font-sm);">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <span style="color: ${myArch.color}; font-weight: 600;">${icons[myArch.id]} ${myArch.name}</span>
                            <span class="type-info-icon" onclick="openDefinitionModal('${myArch.id}')" style="margin-left: 4px;">ℹ</span>
                            <div style="color: var(--text-muted); margin-top: 4px; line-height: 1.4;">${myDef}</div>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <span style="color: ${partnerArch.color}; font-weight: 600;">${icons[partnerArch.id]} ${partnerArch.name}</span>
                            <span class="type-info-icon" onclick="openDefinitionModal('${partnerArch.id}')" style="margin-left: 4px;">ℹ</span>
                            <div style="color: var(--text-muted); margin-top: 4px; line-height: 1.4;">${partnerDef}</div>
                        </div>
                    </div>
                </div>

                <div class="match-modal-score">
                    <span class="match-modal-score-label">Kompatibilität ${isIdenticalType ? '(gleicher Typ)' : 'mit ' + myArch.name}</span>
                    <span class="match-modal-score-value" style="color: ${scoreColor}">${overall}%</span>
                </div>

                <div class="match-modal-categories">
                    <div class="match-modal-categories-title">Kategorie-Bewertungen</div>
                    ${categoryBars}
                </div>

                <div class="match-modal-section pro">
                    <div class="match-modal-section-title">✓ Was funktioniert</div>
                    <ul class="match-modal-list">${proItems}</ul>
                </div>

                <div class="match-modal-section contra">
                    <div class="match-modal-section-title">✗ Herausforderungen</div>
                    <ul class="match-modal-list">${contraItems}</ul>
                </div>
            `;
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeCategoryModal();
                closeFeedbackModal();
            }
        });

        // ==========================================
        // FEEDBACK SYSTEM
        // ==========================================

        // Google Apps Script URL für Feedback
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwSpnFIsm6KNMiyZSfLzDtuPBUVxYBEEbx5pKgw37LZIFCutx4ugWau8CUWs_cB_YIl/exec';

        let feedbackData = [];
        let feedbackRatings = { verstand: 0, gefuehl: 0 };
        let replyToId = null; // For reply functionality

        // Advanced filter state
        let feedbackFilters = {
            search: '',
            myType: 'all',
            partnerType: 'all',
            category: 'all',
            sort: 'newest'
        };

        // Get current context ID based on what's visible
        function getCurrentContextId() {
            const carousel = document.getElementById('carousel');
            const cardWidth = window.innerWidth;
            const currentCard = Math.round(carousel.scrollLeft / cardWidth);

            const myType = currentArchetype.toUpperCase();
            const partner = selectedPartner.toUpperCase();

            switch(currentCard) {
                case 0:
                    return `S1-${myType}`;
                case 1:
                    return `S2-${myType}-${partner}`;
                case 2:
                    return `S3`;
                case 3:
                    return `S4`;
                default:
                    return `S${currentCard + 1}`;
            }
        }

        // Get context ID for modals
        function getModalContextId() {
            const categoryModal = document.getElementById('categoryModal');
            if (categoryModal.classList.contains('active')) {
                const modalTitle = document.getElementById('modalTitle').textContent;
                const myArch = data.archetypes[currentArchetype];
                const partnerId = modalContextPartner || selectedPartner;
                const partnerArch = data.archetypes[partnerId];
                const combo = `${myArch?.name || '?'} (Ich) mit ${partnerArch?.name || '?'}`;

                if (modalTitle.includes('Kategorie')) {
                    const cat = modalTitle.replace('Kategorie ', '').trim();
                    const catName = categoryNames[cat] || cat;
                    return `${combo} | ${catName}`;
                } else if (modalTitle.includes('+')) {
                    // Match modal (Top Match or Challenge)
                    const matchType = (currentTopMatch.id && modalContextPartner === currentTopMatch.id) ? 'Top Match' : 'Challenge';
                    return `${combo} | ${matchType}`;
                }
            }
            return getCurrentContextId();
        }

        // Open feedback modal
        function openFeedbackModal() {
            replyToId = null; // Reset reply state for new feedback
            const contextId = getModalContextId();
            document.getElementById('feedbackContextId').textContent = contextId;
            document.getElementById('feedbackModal').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Reset form
            document.getElementById('feedbackName').value = '';
            document.getElementById('feedbackTitle').value = '';
            document.getElementById('feedbackComment').value = '';
            feedbackRatings = { verstand: 0, gefuehl: 0 };
            updateStarDisplay('ratingVerstand', 0);
            updateStarDisplay('ratingGefuehl', 0);
        }

        // Open feedback modal with specific context
        function openFeedbackModalWithContext(contextText) {
            replyToId = null;
            document.getElementById('feedbackContextId').textContent = contextText;
            document.getElementById('feedbackModal').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Reset form
            document.getElementById('feedbackName').value = '';
            document.getElementById('feedbackTitle').value = '';
            document.getElementById('feedbackComment').value = '';
            feedbackRatings = { verstand: 0, gefuehl: 0 };
            updateStarDisplay('ratingVerstand', 0);
            updateStarDisplay('ratingGefuehl', 0);
        }

        function closeFeedbackModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('feedbackModal').classList.remove('active');
            document.body.style.overflow = '';
            replyToId = null; // Reset on close
        }

        // Star rating functionality
        function updateStarDisplay(containerId, value) {
            const container = document.getElementById(containerId);
            container.querySelectorAll('.star').forEach((star, i) => {
                star.classList.toggle('active', i < value);
            });
        }

        function initStarRatings() {
            ['ratingVerstand', 'ratingGefuehl'].forEach(containerId => {
                const container = document.getElementById(containerId);
                const ratingKey = containerId === 'ratingVerstand' ? 'verstand' : 'gefuehl';

                container.querySelectorAll('.star').forEach(star => {
                    star.addEventListener('click', () => {
                        const value = parseInt(star.dataset.value);
                        feedbackRatings[ratingKey] = value;
                        updateStarDisplay(containerId, value);
                    });

                    star.addEventListener('mouseenter', () => {
                        const value = parseInt(star.dataset.value);
                        container.querySelectorAll('.star').forEach((s, i) => {
                            s.style.color = i < value ? '#f1c40f' : '';
                        });
                    });

                    star.addEventListener('mouseleave', () => {
                        container.querySelectorAll('.star').forEach((s, i) => {
                            s.style.color = i < feedbackRatings[ratingKey] ? '#f1c40f' : '';
                        });
                    });
                });
            });
        }

        // Submit feedback
        // Generate unique ID
        function generateFeedbackId() {
            return 'fb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        async function submitFeedback() {
            const name = document.getElementById('feedbackName').value.trim();
            const titel = document.getElementById('feedbackTitle').value.trim();
            const kommentar = document.getElementById('feedbackComment').value.trim();
            const kontextId = replyToId
                ? document.getElementById('feedbackContextId').textContent
                : getModalContextId();

            // Validation
            if (!name) {
                alert('Bitte gib deinen Namen/Kürzel ein.');
                return;
            }
            if (!titel) {
                alert('Bitte gib einen Titel ein.');
                return;
            }

            const feedbackEntry = {
                id: generateFeedbackId(),
                kontextId,
                name,
                titel,
                kommentar,
                verstand: feedbackRatings.verstand,
                gefuehl: feedbackRatings.gefuehl,
                antwortAuf: replyToId || ''
            };

            const submitBtn = document.getElementById('feedbackSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sende...';

            try {
                if (GOOGLE_SCRIPT_URL) {
                    // Send to Google Sheets
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(feedbackEntry)
                    });
                }

                // Also save locally as backup
                saveLocalFeedback(feedbackEntry);

                alert('Danke für dein Feedback!');
                replyToId = null; // Reset reply state
                closeFeedbackModal();

                // Reload feedback to show the new entry
                setTimeout(() => loadFeedback(), 500);

            } catch (error) {
                console.error('Feedback error:', error);
                // Save locally on error
                saveLocalFeedback(feedbackEntry);
                alert('Feedback lokal gespeichert. (Server nicht erreichbar)');
                replyToId = null;
                closeFeedbackModal();
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'Senden';
        }

        // Local storage backup
        function saveLocalFeedback(entry) {
            const stored = JSON.parse(localStorage.getItem('tiage_feedback') || '[]');
            entry.timestamp = new Date().toISOString();
            stored.unshift(entry);
            localStorage.setItem('tiage_feedback', JSON.stringify(stored));
        }

        function getLocalFeedback() {
            return JSON.parse(localStorage.getItem('tiage_feedback') || '[]');
        }

        // Load and display feedback
        async function loadFeedback() {
            const container = document.getElementById('feedbackList');

            try {
                if (GOOGLE_SCRIPT_URL) {
                    // Try to load from Google Sheets
                    const response = await fetch(GOOGLE_SCRIPT_URL);
                    const serverData = await response.json();
                    feedbackData = serverData.reverse(); // Newest first
                } else {
                    // Use local data only
                    feedbackData = getLocalFeedback();
                }
            } catch (error) {
                console.error('Load feedback error:', error);
                // Fallback to local
                feedbackData = getLocalFeedback();
            }

            // Populate type filter dropdowns
            populateTypeFilters();
            renderFeedbackList();
        }

        // Populate type dropdowns for filters
        function populateTypeFilters() {
            const archetypes = Object.values(data?.archetypes || {});
            const myTypeSelect = document.getElementById('filterMyType');
            const partnerTypeSelect = document.getElementById('filterPartnerType');

            const options = archetypes.map(a =>
                `<option value="${a.id}">${a.name}</option>`
            ).join('');

            myTypeSelect.innerHTML = `<option value="all">Alle Typen</option>${options}`;
            partnerTypeSelect.innerHTML = `<option value="all">Alle Partner</option>${options}`;
        }

        function renderFeedbackList() {
            const container = document.getElementById('feedbackList');

            // Apply all filters
            let filtered = feedbackData.filter(f => {
                const kontextId = (f.KontextID || f.kontextId || '').toLowerCase();
                const name = (f.Name || f.name || '').toLowerCase();
                const titel = (f.Titel || f.titel || '').toLowerCase();
                const kommentar = (f.Kommentar || f.kommentar || '').toLowerCase();
                const antwortAuf = f.AntwortAuf || f.antwortAuf || '';

                // Skip replies in main list (they'll be shown as threads)
                if (antwortAuf) return false;

                // Search filter
                if (feedbackFilters.search) {
                    const search = feedbackFilters.search.toLowerCase();
                    if (!name.includes(search) && !titel.includes(search) && !kommentar.includes(search)) {
                        return false;
                    }
                }

                // Type filters (parse from context ID like "Single (Ich) mit Duo")
                if (feedbackFilters.myType !== 'all' || feedbackFilters.partnerType !== 'all') {
                    const myTypeName = data?.archetypes?.[feedbackFilters.myType]?.name?.toLowerCase();
                    const partnerTypeName = data?.archetypes?.[feedbackFilters.partnerType]?.name?.toLowerCase();

                    if (feedbackFilters.myType !== 'all' && myTypeName) {
                        if (!kontextId.includes(myTypeName)) return false;
                    }
                    if (feedbackFilters.partnerType !== 'all' && partnerTypeName) {
                        if (!kontextId.includes('mit ' + partnerTypeName)) return false;
                    }
                }

                // Category filter
                if (feedbackFilters.category !== 'all') {
                    const cat = feedbackFilters.category;
                    if (cat === 'TM') {
                        if (!kontextId.includes('top match')) return false;
                    } else if (cat === 'CH') {
                        if (!kontextId.includes('challenge')) return false;
                    } else {
                        // Category A-F: check for category name
                        const catName = categoryNames[cat]?.toLowerCase();
                        if (catName && !kontextId.includes(catName)) return false;
                    }
                }

                return true;
            });

            // Sort
            if (feedbackFilters.sort === 'oldest') {
                filtered = filtered.reverse();
            } else if (feedbackFilters.sort === 'rating') {
                filtered.sort((a, b) => {
                    const aRating = (a.Verstand || a.verstand || 0) + (a.Gefuehl || a.gefuehl || 0);
                    const bRating = (b.Verstand || b.verstand || 0) + (b.Gefuehl || b.gefuehl || 0);
                    return bRating - aRating;
                });
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="feedback-empty">
                        ${feedbackData.length === 0
                            ? 'Noch kein Feedback vorhanden.<br>Sei der Erste!'
                            : 'Kein Feedback für diesen Filter.'}
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(f => renderFeedbackItem(f)).join('');
        }

        // Render single feedback item with replies
        function renderFeedbackItem(f, isReply = false) {
            const id = f.Id || f.id || f.timestamp || '';
            const kontextId = f.KontextID || f.kontextId || '-';
            const name = f.Name || f.name || 'Anonym';
            const titel = f.Titel || f.titel || '';
            const kommentar = f.Kommentar || f.kommentar || '';
            const verstand = f.Verstand || f.verstand || 0;
            const gefuehl = f.Gefuehl || f.gefuehl || 0;
            const timestamp = f.Timestamp || f.timestamp || '';

            // Find replies to this item
            const replies = feedbackData.filter(r =>
                (r.AntwortAuf || r.antwortAuf) === id
            );

            const timeStr = timestamp ? new Date(timestamp).toLocaleDateString('de-DE') : '';

            return `
                <div class="feedback-item ${isReply ? 'reply' : ''}" data-id="${id}">
                    <div class="feedback-item-header">
                        <span class="feedback-item-context">${kontextId}</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="feedback-item-name">${name}</span>
                            ${timeStr ? `<span class="feedback-timestamp">${timeStr}</span>` : ''}
                        </div>
                    </div>
                    <div class="feedback-item-title">${titel}</div>
                    ${kommentar ? `<div class="feedback-item-comment">${kommentar}</div>` : ''}
                    <div class="feedback-item-footer">
                        <div class="feedback-item-ratings">
                            <div class="feedback-rating">
                                <span>Verstand:</span>
                                <span class="stars">${'★'.repeat(verstand)}${'☆'.repeat(5-verstand)}</span>
                            </div>
                            <div class="feedback-rating">
                                <span>Gefühl:</span>
                                <span class="stars">${'★'.repeat(gefuehl)}${'☆'.repeat(5-gefuehl)}</span>
                            </div>
                        </div>
                        <button class="feedback-reply-btn" onclick="openReplyModal('${id}', '${name}')">
                            ↩ Antworten
                        </button>
                    </div>
                    ${replies.length > 0 ? `
                        <div class="feedback-replies">
                            ${replies.map(r => renderFeedbackItem(r, true)).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Open reply modal
        function openReplyModal(parentId, parentName) {
            replyToId = parentId;
            document.getElementById('feedbackContextId').innerHTML =
                `<span class="reply-indicator">↩ Antwort auf ${parentName}</span>`;
            document.getElementById('feedbackModal').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Reset form
            document.getElementById('feedbackName').value = '';
            document.getElementById('feedbackTitle').value = '';
            document.getElementById('feedbackComment').value = '';
            feedbackRatings = { verstand: 0, gefuehl: 0 };
            updateStarDisplay('ratingVerstand', 0);
            updateStarDisplay('ratingGefuehl', 0);
        }

        // Initialize advanced filters
        function initAdvancedFilters() {
            // Search input
            document.getElementById('feedbackSearch').addEventListener('input', (e) => {
                feedbackFilters.search = e.target.value;
                renderFeedbackList();
            });

            // Type selects
            document.getElementById('filterMyType').addEventListener('change', (e) => {
                feedbackFilters.myType = e.target.value;
                renderFeedbackList();
            });

            document.getElementById('filterPartnerType').addEventListener('change', (e) => {
                feedbackFilters.partnerType = e.target.value;
                renderFeedbackList();
            });

            // Category buttons
            document.querySelectorAll('.cat-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.cat-filter-btn').forEach(b =>
                        b.classList.remove('active')
                    );
                    btn.classList.add('active');
                    feedbackFilters.category = btn.dataset.cat;
                    renderFeedbackList();
                });
            });

            // Sort select
            document.getElementById('filterSort').addEventListener('change', (e) => {
                feedbackFilters.sort = e.target.value;
                renderFeedbackList();
            });
        }

        // Initialize feedback system
        function initFeedbackSystem() {
            initStarRatings();
            initAdvancedFilters();
        }

        // Initialize
        loadData();
        initFeedbackSystem();
    </script>
</body>
</html>
